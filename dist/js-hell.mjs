#!/usr/bin/env node 
import*as e from"node:path";import{resolve as n,basename as i,extname as o,relative as r,sep as a,join as s,parse as l,dirname as p}from"node:path";import{fileURLToPath as c,pathToFileURL as u}from"node:url";import*as d from"node:fs";import{statSync as f,readFileSync as m,writeFileSync as h,openSync as y,writevSync as v,closeSync as g,unlinkSync as w,readdirSync as x,existsSync as b,readSync as E,createWriteStream as T}from"node:fs";import{basename as k,extname as S}from"node:path/posix";import{Blob as O}from"node:buffer";import{AsyncLocalStorage as j}from"node:async_hooks";import*as A from"node:util";import{inspect as N,formatWithOptions as I}from"node:util";import{Console as $}from"node:console";import*as L from"node:crypto";import{randomUUID as _}from"node:crypto";import R from"node:http";import"node:inspector";function U(e,...t){let n=e[0];for(let i=0;i<t.length;++i)n+=JSON.stringify(t[i])+e[i+1];return n}function M(e){try{return f(e)}catch{return null}}(void 0===Object.groupBy||globalThis.CHECK_POYFILLS)&&(Object.groupBy=(e,t)=>e.reduce(((e,n)=>{const i=t(n);return e[i]??=[],e[i].push(n),e}),{})),("function"!=typeof Set.prototype.intersection||globalThis.CHECK_POYFILLS)&&(Set.prototype.intersection=function(e){const t=new Set;for(const n of e)this.has(n)&&t.add(n);return t}),async function(){process.removeAllListeners("warning");const e=await Promise.resolve().then((function(){return xp})),t=await e.default();process.exit(t)}();const C="dir",P="file",D="";function z(e){const t="string"==typeof e?M(e):e;if(null==t)return D;if(t.isDirectory())return C;if(t.isFile())return P;if(t.isFIFO()||t.isSocket())return"pipe";if(t.isSymbolLink())return"link";if(t.isBlockDevice()||t.isCharacterDevice())return"device";throw new TypeError("What the hell file type is it then?!")}const F=new RegExp(`.*?(?=${/[!?$%^=@#~()[\]{}<>&|,;`'"]/.source}|\\s|::|$)`,"y"),B=/(["'])(.*?)\1/sy,J=/\s+--(?=\s)/y,V=/.*?(?=\r?\n|$)/y,q=/.*?(?:\r?\n|$)/y,W="::",K="$0";function G(e,t){if(!t.match(J))return e;const n=t.match(V);return e.annotation=n,e}function X(e){let t;return(t=e.exec(B))?{value:t[2],quoted:!0}:{value:e.match(F),quoted:!1}}function H(e){const{value:t,quoted:n}=X(e),i=new String(t);return i.quoted=n,i}const Z=/\s+/y;function Y(e,t,n=0){return e.lastIndex=n,e.test(t)?e.lastIndex-n:0}function Q(e,t,n=0){if("string"==typeof e)return t.startsWith(e,n)?e.length:0;if("function"==typeof e){const i=e(t,n);if(!Number.isInteger(i)||i<0||n+i>t.length)throw new TypeError("Invalid matcher result");return i}if(void 0!==e.sticky&&!0!==e.sticky)throw new TypeError("RegExp-like must be sticky");return Y(e,t,n)}class ee{#e;#t;#n;#i;#o;constructor(e,{pos:t=0,ws:n=Z,autoTrim:i=!1,trimStart:o=i}={}){this.#e=e,this.#t=o?t+Y(n,e,t):t,this.#i=i,this.#n=n,this.#o=this.#t}match(e,t=this.#i){const{trimEnd:n=!1,lookahead:i=!1}="object"==typeof t&&t?t:{trimEnd:!!t,lookahead:!1},o=this.#t,r=this.#e,a=Q(e,r,o);if(!a)return"";const s=o+a;return i||(this.#o=o,this.#t=n?s+Y(this.#n,r,s):s),"string"==typeof e?e:r.slice(o,s)}exec(e,t=this.#i){const{trimEnd:n=!1,lookahead:i=!1}="object"==typeof t&&t?t:{trimEnd:!!t,lookahead:!1};if(!0!==e.sticky)throw new TypeError("Must be a sticky RegExp-like");const o=this.#e,r=this.#t;e.lastIndex=r;const a=e.exec(o);if(!i&&a){const t=e.lastIndex;this.#o=r,this.#t=n?t+Y(this.#n,o,t):t}return a}startsWith(e){return 0!==Q(e,this.#e,this.#t)}trimStart(){const e=Y(this.#n,this.#e,this.#t);return!!e&&(this.#t+=e,!0)}get lastIndex(){return this.#o}get pos(){return this.#t}getPos(){return this.#t}atEof(){return this.#t>=this.#e.length}slice(e){const t=this.#t;return e>t?this.#e.slice(t,e):this.#e.slice(e,t)}tail(){return this.#e.slice(this.#t)}error(e,t=this.#t,n=this.#t){t<0&&(t+=this.#t);const i=new Error(e+=` at ${n}`);return i.type="parse",i.sourceIndex=t,i.sourceStartIndex=t,i.sourceEndIndex=n,i.sourceText=this.#e,i}warn(e,t){const n=this.error(e,t);console.warn(n.message)}getText(){return this.#e}fence(){return this.#t}rollback(e=this.#o){this.#t=e}}const te=Symbol.for("js-hell.realiseTo"),ne=Symbol.for("js-hell.valueForEquals"),ie=Symbol.for("js-hell.typeof"),oe=Symbol("default-missing-bool"),re=Symbol.for("js-hell.explict-variables"),ae="[]",se="*",le="",pe="async*",ce=Symbol("is async?"),ue="lookup",de="array",fe="object",me="callback",he="call",ye="method",ve="value",ge="unary",we="binary",xe="ternary",be="??",Ee="as",Te="instanceof",ke="index",Se="sync",Oe="typeof",je="globals",Ae="imports",Ne="locals";function Ie(e){return{type:ve,async:!1,value:e}}function $e(e){return e.type===ve}function Le(e,{scope:t,defaultValue:n,option:i=!1,typename:o="",write:r=!1}={}){return{type:ue,parent:null,name:e,scope:t,defaultValue:n,option:i,typename:o,write:r}}function _e(e){return{type:de,value:e}}function Re(e,t,n,{defaulted:i=!1,pipeIndex:o=0,exprType:r}={}){return{type:we,op:e,lhs:t,rhs:n,defaulted:i,pipeIndex:o,exprType:r}}function Ue(e,t,n){if("function"==typeof t)throw new TypeError("Not supported");let i,o,r;if("object"==typeof t)({start:o,end:r}=t);else{if(void 0===t)throw new TypeError("subscripts may not be undefined");i=t}return{type:ge,op:ke,object:e,property:i,start:o,end:r}}function Me(e,t,{exprType:n}={}){return{type:ge,op:e,object:t,exprType:n}}function Ce(e,t,n,i=[],{new:o=!1,import:r=!1}={}){return{type:e,new:o,object:n,name:t,args:i,import:e===he&&r}}function Pe(e,t=[],n){return Ce(he,e,null,t,n)}function De(e,t,n=[],i){const o=Ce(ye,e,t,n,i);return t.parent=o,o}function ze(e){return Me(Se,e)}function Fe(e,t){if(void 0===e&&void 0===t)return!0;if(e.type!==ve||t.type!==ve)throw new Error("Cannot compare nodes");if(!1!==e.async||!1!==t.async)throw new Error("Async should be false on all nodes");return Object.is(e.value,t.value)}function Be(e=null,t){const n=Object.create(e);for(let e=0;e<t.length;e+=2){const i=t[e],o=t[e+1];Object.defineProperty(n,i,{value:o,writable:!1,configurable:!1,enumerable:!0})}return n}const Je=/[A-Za-z0-9_$]/y;function Ve(e){return(t,n)=>function(e,t,n){return t.startsWith(e,n)?(Je.lastIndex=n+e.length,Je.test(t)?0:e.length):0}(e,t,n)}function qe(e){const{basetype:t}=e;switch(e.enum){case pe:return`async*${t}`;case se:return`*${t}`;case ae:return`${t}[]`;case le:return t;default:throw new Error("Unknown enumeration type")}}class We{basetype;enum;constructor(e,t=""){this.basetype=e,this.enum=t}isScalar(e){return this.enum===le&&this.basetype===e}}const Ke=/\$-|[A-Za-z_$][A-Za-z_$0-9]*/y,Ge=/[A-Za-z_][A-Za-z_$0-9]*/y,Xe=/async(?![A-Za-z_$0-9]|\s*\*)/y,He=/=(?![=>])/y,Ze=/[-+]?\d+/y,Ye=/[-+]?\d+/y,Qe=/%\d*/y,et=/[^"\\\r\n\u2028\u2029]+/y,tt=/[^'\\\r\n\u2028\u2029]+/y,nt=/['"\\]/y,it=/[\n\u2028\u2029]|\r\n?/y,ot=/[bfnrtv]/y,rt=/u[0-9A-Fa-f]{4}/y,at=/\[(?!\s*\])/y,st=/\?(?!\?)/y,lt=/[^`\\$\r\n\u2028\u2029]*/y,pt=/[\n\u2028\u2029]|\r\n?/y,ct=/['"\\bfnrtv]/y,ut=/x[0-9A-Fa-f]{2}|u[0-9A-Fa-f]{4}/y,dt=/u\{[0-9A-Fa-f]+\}/y,ft="every reference";function mt(e){let t="";for(;;){if(e.type===ue)return t||e.name;if(e.type!==ge||e.op!==ke)return"";if("string"!=typeof e.property||void 0!==e.property.start||void 0!==e.end)return"";t||(t=e.property),e=e.object}}function ht(e,t,n=!0){if(e.type===we){if(","!==e.op)return null;const i=ht(e.lhs,t,n),o=ht(e.rhs,t,n);return i&&o?[...i,...o]:null}return e.type===ue?(n&&kt(t,e),[e.name]):null}function yt(e,t,n){let i="";for(;;){if(i+=e.match(t,!1),e.match(n,!0))return i;if(!e.match("\\",!1))throw e.error("Unterminated string");let o;if(""!==(o=e.match(nt,!1)))i+=o;else if(""!==(o=e.match(rt,!1)))i+=String.fromCharCode(parseInt(o.slice(1),16));else if(""!==(o=e.match(ot,!1))){const e="bfnrtv".indexOf(o);i+="\b\f\n\r\t\v".charAt(e)}else{if(""!==e.match(/[x0-9]/y,!1))throw e.error("unsupported escape sequence");e.match(it,!1)}}}function vt(e){return""!==e.match('"',!1)?Ie(yt(e,et,'"')):""!==e.match("'",!1)?Ie(yt(e,tt,"'")):null}function gt(e,t){let n,i,o;return""!==(n=e.match(Ze,!0))?Ie(parseFloat(n)):(i=vt(e))?i:(o=function(e,t,n=!1){if(!e.match("`"))return null;const i=Qt(e,t,{raw:n,terminated:!0});return e.trimStart(),i}(e,t))?o:""!==e.match("true",!0)?Ie(!0):""!==e.match("false",!0)?Ie(!1):""!==e.match("null",!0)?Ie(null):""!==e.match("undefined",!0)?Ie(void 0):null}function wt(e,t,n){if(e.match(".",!0)){const i=e.match(Ke,!0);if(!i)throw e.error("expected identifier");if(!e.match("(",!0))return Ue(t,i);return De(i,t,Ct(e,")",n))}const i=function(e,t){if(!e.match(at,!0))return;let n,i;if(i=vt(e))n=i.value;else{const i=e.match(Ye,!0);n=""!==i?parseInt(i,10):_t(e,t)}if(!e.match("]",!0))throw e.error("expected ']'");return e.trimStart(),n}(e,n);return void 0===i?t:"object"==typeof i?Re(".",t,i):Ue(t,i)}function xt(e){const t=e.match(Ke,!0);if(!t)throw e.error("expected identifier");return t}function bt(e){return Le(xt(e))}function Et(e,t,n={}){const i=xt(e),o=St(t,i),r=Le(i,{scope:o,...n});return Ot(t,r,i,o),r}function Tt(e,t){const n=gt(e,t)||function(e,t){if(!e.match("@"))return null;if(!e.match(Ve("option")))throw e.error("@option is the only decorated currently supported");let n="";if(e.match("(",!0)){if(n=xt(e),!e.match(")",!0))throw e.error("expected ')'")}else e.trimStart();const i=Et(e,t,{option:!0,typename:n});if(i.scope!==je)throw e.error("@option can only decorate globals");return i}(e,t);if(n)return n;if(e.match("(",!0)){let n=Bt(e,t);for(;e.match(",",!0);)n=Re(",",n,Bt(e,t));if(!e.match(")",!0))throw e.error("expected ')'");return n}{const n=e.match(Qe,!0);if(n)return Le(n,{scope:Ne});{const n=bt(e);return function(e,t){const{name:n}=t,i=St(e,n);Ot(e,t,n,i),t.scope=i}(t,n),n}}}function kt(e,t){if(t.scope===Ne)return;const n=t.scope===je?e.globals:t.scope===Ae?e.imports:null;if(!n.has(t.name))return;const i=n.get(t.name);i.delete(t),0===i.size&&t.scope===je&&n.delete(t.name)}function St(e,t){return void 0!==e.locals?.[t]?Ne:e.imports.has(t)?Ae:je}function Ot(e,t,n,i){i===Ae?e.imports.get(n).add(t):i===je&&(e.globals.has(n)?e.globals.get(n).add(t):e.globals.set(n,new Set([t])))}function jt(e,t){const n=e.pos;let i=!!e.match(Ve("new"),!0),o=Tt(e,t);if(o.type===ue){if(e.match("(",!0)){if(o.option)throw e.error("@option can decorate function calls");const n=o;o=Pe(n.name,Ct(e,")",t)),o.new=i,i=!1,function(e,t,n){if(t.scope===Ne)return;const i=(t.scope===je?e.globals:t.scope===Ae?e.imports:null).get(t.name);i.delete(t),i.add(n),n.import=t.scope===Ae}(t,n,o)}}else if(i)throw e.error("`new` not allowed here",n);for(;;){const r=wt(e,o,t);if(i){if(r.type===ye){if(!mt(r.object))throw e.error("`new` not allowed here",n);r.new=i,i=!1}else if(r===o)throw e.error("`new` not allowed here",n)}else if(r===o)return o;o=r}}function At(e){const t=!!e.match(Ve("async"),!0);if(e.match("*",!0))return t?pe:se;if(t)throw e.error("expected '*' following 'async'");return le}function Nt(e,t){if(e.match(Ve("typeof"),!0))return Me(Oe,Nt(e,t),{exprType:new We("string")});if(e.match("!",!0))return Me("!",Nt(e,t),{exprType:new We("boolean")});const n=At(e),i=n===le&&function(e,t){if("await"!==e.match(Ve("await"),!0))return!1;if(!0!==t.async)throw e.error("await cannot be used outside of an async context");return!0}(e,t);let o=jt(e,t);return i?o=ze(o):n===se?o=De(Symbol.iterator,o,[]):n===pe&&(o=De(Symbol.asyncIterator,o,[])),o}function It(e,t){const n=Nt(e,t);if(!e.match(Ve("instanceof"),!0))return n;const i=function(e,t){let n=Et(e,t);for(;e.match(".",!0);){const t=n;n=Ue(t,xt(e)),null===t.parent&&(t.parent=n)}return n}(e,t);return Re(Te,n,i,{exprType:new We("boolean")})}const $t=function(e,t){let n=It(e,t);if(e.match("===",!0))n=Re("===",n,It(e,t),{exprType:new We("boolean")});else{if(!e.match("!==",!0))return n;n=Re("!==",n,It(e,t),{exprType:new We("boolean")})}if(e.match("===")||e.match("!=="))throw e.error("another equality operator is not permitted here (without brackets)");return n};function Lt(e,t,n){const i=zt(e,n);if(!e.match(":",!0))throw e.error("expected ':'");return function(e,t,n){return{type:xe,condition:e,true:t,false:n}}(t,i,zt(e,n))}function _t(e,t,n=0){const i=function(e,t,n){if(!e.match("??",!0))return t;const i=zt(e,n);return Re(be,t,i)}(e,$t(e,t),t);if(e.match(st,!0)){if(n)throw e.error("cannot mix ternary and pipe expressions");const o=Lt(e,i,t);if(e.match("|>",!0))throw e.error("cannot mix ternary and pipe expressions");return o}if(e.match("|>",!0)){return Re("|>",i,_t(e,t,n+1),{pipeIndex:n+1})}return i}function Rt(e,t){const n=_t(e,t),{pos:i}=e,o=function(e,t){if(!e.match(He,!0))return null;const n=e.pos,i=gt(e,t);if(!i)throw e.error("expected literal",n);return i}(e,t);if(!o)return n;if(!mt(n))throw e.error("defaulting not permitted here",i);if(n.type===ue){if(n.option&&n.typename&&typeof o.value!==n.typename)throw e.error("defaulted value must have the same type as is declared in the option",i);return n.defaultValue=o,n}return Re(be,n,o,{defaulted:!0})}function Ut(e){return e.type===we&&e.op===be&&!0===e.defaulted}function Mt(e,t,n){if(e.match("...",!0))return Me("...",zt(e,n));const i=!!e.match(Xe,!0),o=zt(e,n);if(t){const t=ht(o,n,!1);if(t){const r=function(e,t,n,i){if(!e.match("=>",!0))return;const o=Be(t,["async",n,"locals",Be(t.locals,i.flatMap((e=>[e,!0])))]);return Ft(e,o)}(e,n,i,t);if(r)return ht(o,n,!0),function(e,t,n=!1){return{type:me,async:n,expr:t,freeVariableNames:e}}(t,r,i)}}if(i)throw e.error("cannot use async here");return o}function Ct(e,t,n){const i=[],o=")"===t;if(!e.match(t,!0))for(;;){i.push(Mt(e,o,n));const r=e.match(",",!0);if(e.match(t,!0))break;if(!r)throw e.error("expected ',' or ')'")}return i}function Pt(e,t){if(!e.match("[",!0))return;return _e(Ct(e,"]",t))}function Dt(e,t){if(!e.match("{",!0))return;const n=[];if(!e.match("}",!0))for(;;){const{pos:i}=e,o=Rt(e,t);let r,a;if(o.type===ue&&e.match(":",!0))kt(t,o),r=o.name,a=zt(e,t);else{const t=mt(Ut(o)?o.lhs:o);if(!t)throw e.error("cannot use argument as a shorthand",i);r=t,a=o}if(-1!==r.indexOf("$"))throw new TypeError("Property name cannot contain `$`");if(n.push([r,a]),e.match("}",!0))break;if(!e.match(",",!0))throw e.error("expected ',' or '}'")}return{type:fe,value:n}}function zt(e,t){return Pt(e,t)??Dt(e,t)??gt(e,t)??Rt(e,t)}function Ft(e,t){return Pt(e,t)??gt(e,t)??_t(e,t)}function Bt(e,t){return Pt(e,t)??Dt(e,t)??gt(e,t)??_t(e,t)}const Jt=["void","undefined","null"];function Vt(e){const t=[];for(const[n,i]of e){const e=i[Symbol.iterator](),o=e.next();if(o.done)throw new Error(U`No options for global ${n}`);if(!o.value.option){if(!Array.from(e).every((e=>!e.option)))throw new Error(U`Every reference to ${n} must be declared an option`);continue}for(const t of e){if(!t.option)throw new Error(`${ft} to ${JSON.stringify(n)} must be declared an option`);if(t.typename!==o.value.typename)throw new Error(`${ft} to ${JSON.stringify(n)} must be declared with the same type`);if(!Fe(t.defaultValue,o.value.defaultValue))throw new Error(`${ft} to ${JSON.stringify(n)} must have identical default value`)}if(o.value.defaultValue&&o.value.defaultValue.type!==ve)throw new Error("@option can only be declared with literal values.");const r=!!o.value.typename,a=!!o.value.defaultValue;t.push({name:n,hasExplicitTypename:r,typename:r?o.value.typename:a?typeof o.value.defaultValue.value:"",hasDefaultValue:a,defaultValue:o.value.defaultValue?.value})}return t}const qt="expr",Wt="embedded",Kt="binding",Gt="template",Xt="template-tail";function Ht(e,t=qt){"boolean"==typeof t&&console.warn("_parse invoked with boolean - upgrade to a const"),!0===t?t=qt:!1===t&&(t=Kt);const n={api:1,async:!0,globals:void 0,imports:void 0,locals:Be(null,[])},i=t===Kt,o=t===Gt||t===Xt;o||e.trimStart();const r=i?e.match(Ke,!1)||(console.warn("warning: IDL omitted function name"),"default"):"";if("with"===r&&e.trimStart(),i&&!e.match("(",!0))throw new TypeError("Expected '('");const a="with"===r,s=!i||a,l=i?a?function(e){const t=[];for(;;){if(e.match(")",!0))return t;if(t.push(bt(e).name),e.match(")",!0))return t;if(!e.match(",",!0))throw e.error("exepcted ','")}}(e):[r]:[],p=new Map(Array.from(l,(e=>[e,new Set])));n.globals=new Map,n.imports=p;let c=o?Qt(e,n,{raw:!1,terminated:t!==Gt}):s?Ft(e,n):function(e,t){return ze(Pe(e,t,{import:!0}))}(r,Ct(e,")",n));if(!s){const e=p.get(r);if(0!==e.size)throw new Error(`Import ${r} should not be referenced - except in the principle call`);e.add(function(e){if(e.type===we&&e.op===Ee&&(e=e.lhs),e.type!==ge||e.op!==Se)throw new Error("expected root to be an await()");const{object:t}=e;if(void 0===t||t.type!==he)throw new Error("expected await to wrap a call");if(!0!==t.import)throw new Error("expected call to be an import");return t}(c))}let u=function(e,t="to"){if(!e.match(t,!0))return;const n=At(e);let i=Dt(e);if(!i&&(i=e.match(Ge,!0),!i))throw new TypeError("Expected identifier");const o=function(e){if(!e.match("[",!0))return!1;if(e.match("]",!0))return!0;throw e.error("expected ']' following '['")}(e);if(n!==le&&o)throw new TypeError("Cannot be both iterator and array");return new We(i,o?ae:n)}(e,"as"),d=!1;if(!s&&e.match("->",!0)){const t=xt(e);if(St(n,t)!==je)throw e.error("'->' can only be used on globals");const i=Le(t,{scope:je,write:!0});Ot(n,i,t,je),c=function(e,t,n){return{type:"->",sourceValue:e,destIdentifier:t,typeAssertion:n}}(c,i,u),u=void 0,d=!0}if(u&&(c=Re(Ee,c,function(e,t){let n;return n=e.charAt(0).toUpperCase()===e.charAt(0)?`${e}.is${e}(%) ?? % instanceof ${e}`:e.toLowerCase()===e?`typeof % === ${JSON.stringify(e)}`:"0",Bt(new ee(n),t)}(u.basetype,n)),c.exprType=u),s){const e=l.filter((e=>0===p.get(e).size));if(e.length)throw new Error(`Unused imports ${e.join(" ")}`)}if(!e.atEof()&&t!==Wt&&t!==Xt)throw e.error("Expected eof.");const f=Vt(n.globals);return{importReferences:p,globalReferences:n.globals,imports:l,typeAssertion:u,args:c,inlineOptions:f,isVoid:d}}const Zt={"\\":"\\","'":"'",'"':'"',b:"\b",f:"\f",n:"\n",r:"\r",t:"\t",v:"\v"};function Yt(e){let t;return(t=e.match(ct))?Zt[t]:e.match(/./y)}function Qt(e,t,{raw:n,terminated:i}){const o=function*(e,t=!0){let n,i="";for(;;){if(i+=e.match(lt,!1),e.atEof()){if(t)throw e.error("expected `");return i}if(e.match("`",!1)){if(t)return i;i+="`"}else if(e.match("$",!1))if(e.match("{",!0))yield i,i="";else{if(e.match("(",!1))throw e.error("Embedded CLI calls not yet supported",e.pos-2,e.pos-2);i+="$"}else if(e.match("\\",!1))if(e.match(/0(?!\d)/y,!1))i+="\0";else if(n=e.match(pt))i+="";else if(n=e.match(ut,!1))i+=String.fromCharCode(parseInt(n.slice(1),16));else if(n=e.match(dt,!1)){const e=parseInt(n.slice(2,-1),16);if(!(e<=1114111))throw new SyntaxError("Invalid template");i+=String.fromCodePoint(e)}else{if(!(n=Yt(e)))throw e.error("not implemented");i+=n}else{if(!(n=e.match(pt,!1)))throw e.error("not implemented");i+=n}}}(e,i),r=[];for(;;){const{value:n,done:i}=o.next();if(n.length&&r.push(Ie(n)),i)break;if(r.push(Ft(e,t)),e.trimStart(),!e.match("}"))throw e.error("expected '}'")}return 0===r.length?Ie(""):1===r.length?r[0]:De("join",_e(r),[Ie("")])}function en(e){return!("object"!=typeof e||!e)&&("function"==typeof e.next&&("function"==typeof e[Symbol.iterator]&&e[Symbol.iterator]()===e))}function tn(e){return"object"==typeof e&&e&&"Generator"===e[Symbol.toStringTag]}class nn{#r;#a;constructor(e,t){this.#r=t,this.#a=e}get name(){return this.#r}fromString(e){if(this.#a!==e)throw new TypeError(`Expected literal ${JSON.stringify(this.#a)} for ${this.#r}`);return e}get literal(){return!0}get enum(){return!1}}class on{fullPath;constructor(t){this.fullPath=e.resolve(t)}async getFile(t){const n=e.resolve(this.fullPath,"..",t),i=d.readFileSync(n);return new rn([i],n,{fileSystemEntry:new on(n)})}getFileFromRelativeURL(e){return getFile(c(new URL(e,u(this.fullPath)+"/.")))}relativePathFromUrl(t,n=this){const i=u(this.fullPath),o=c(new URL(t,i));return e.relative(e.resolve(n.fullPath,".."),o)}async getParent(){return new on(e.join(this.fullPath,".."))}toURL(){return u(this.fullPath)}}class rn extends O{name;lastModified;webkitRelativePath;fileSystemEntry;constructor(t,n,{type:i="",lastModified:o=Date.now(),fileSystemEntry:r=new on(n)}={}){super(t,{type:i}),Object.assign(this,{name:e.basename(n),lastModified:o,webkitRelativePath:n,fileSystemEntry:r})}}var an={".123":"application/vnd.lotus-1-2-3",".1km":"application/vnd.1000minds.decision-model+xml",".3dml":"text/vnd.in3d.3dml",".3ds":"image/x-3ds",".3g2":"video/3gpp2",".3gp":"video/3gpp",".3mf":"model/3mf",".7z":"application/x-7z-compressed",".aab":"application/x-authorware-bin",".aac":"audio/x-aac",".aam":"application/x-authorware-map",".aas":"application/x-authorware-seg",".abw":"application/x-abiword",".acc":"application/vnd.americandynamics.acc",".ace":"application/x-ace-compressed",".acu":"application/vnd.acucobol",".acutc":"application/vnd.acucorp",".adp":"audio/adpcm",".aep":"application/vnd.audiograph",".afm":"application/x-font-type1",".afp":"application/vnd.ibm.modcap",".age":"application/vnd.age",".ahead":"application/vnd.ahead.space",".ai":"application/postscript",".aif":"audio/x-aiff",".aifc":"audio/x-aiff",".aiff":"audio/x-aiff",".air":"application/vnd.adobe.air-application-installer-package+zip",".ait":"application/vnd.dvb.ait",".ami":"application/vnd.amiga.ami",".amr":"audio/amr",".apk":"application/vnd.android.package-archive",".apng":"image/apng",".appcache":"text/cache-manifest",".application":"application/x-ms-application",".apr":"application/vnd.lotus-approach",".arc":"application/x-freearc",".arj":"application/x-arj",".asf":"video/x-ms-asf",".asm":"text/x-asm",".aso":"application/vnd.accpac.simply.aso",".asx":"video/x-ms-asf",".atc":"application/vnd.acucorp",".atom":"application/atom+xml",".atomcat":"application/atomcat+xml",".atomdeleted":"application/atomdeleted+xml",".atomsvc":"application/atomsvc+xml",".atx":"application/vnd.antix.game-component",".au":"audio/basic",".avci":"image/avci",".avcs":"image/avcs",".avi":"video/x-msvideo",".avif":"image/avif",".aw":"application/applixware",".azf":"application/vnd.airzip.filesecure.azf",".azs":"application/vnd.airzip.filesecure.azs",".azv":"image/vnd.airzip.accelerator.azv",".azw":"application/vnd.amazon.ebook",".b16":"image/vnd.pco.b16",".bat":"application/x-msdownload",".bcpio":"application/x-bcpio",".bdf":"application/x-font-bdf",".bdm":"application/vnd.syncml.dm+wbxml",".bed":"application/vnd.realvnc.bed",".bh2":"application/vnd.fujitsu.oasysprs",".bin":"application/octet-stream",".blb":"application/x-blorb",".blorb":"application/x-blorb",".bmi":"application/vnd.bmi",".bmml":"application/vnd.balsamiq.bmml+xml",".book":"application/vnd.framemaker",".box":"application/vnd.previewsystems.box",".boz":"application/x-bzip2",".bpk":"application/octet-stream",".bsp":"model/vnd.valve.source.compiled-map",".btif":"image/prs.btif",".buffer":"application/octet-stream",".bz":"application/x-bzip",".bz2":"application/x-bzip2",".c":"text/x-c",".c11amc":"application/vnd.cluetrust.cartomobile-config",".c11amz":"application/vnd.cluetrust.cartomobile-config-pkg",".c4d":"application/vnd.clonk.c4group",".c4f":"application/vnd.clonk.c4group",".c4g":"application/vnd.clonk.c4group",".c4p":"application/vnd.clonk.c4group",".c4u":"application/vnd.clonk.c4group",".cab":"application/vnd.ms-cab-compressed",".caf":"audio/x-caf",".cap":"application/vnd.tcpdump.pcap",".car":"application/vnd.curl.car",".cat":"application/vnd.ms-pki.seccat",".cb7":"application/x-cbr",".cba":"application/x-cbr",".cbr":"application/x-cbr",".cbt":"application/x-cbr",".cbz":"application/x-cbr",".cc":"text/x-c",".cco":"application/x-cocoa",".cct":"application/x-director",".ccxml":"application/ccxml+xml",".cdbcmsg":"application/vnd.contact.cmsg",".cdf":"application/x-netcdf",".cdfx":"application/cdfx+xml",".cdkey":"application/vnd.mediastation.cdkey",".cdmia":"application/cdmi-capability",".cdmic":"application/cdmi-container",".cdmid":"application/cdmi-domain",".cdmio":"application/cdmi-object",".cdmiq":"application/cdmi-queue",".cdx":"chemical/x-cdx",".cdxml":"application/vnd.chemdraw+xml",".cdy":"application/vnd.cinderella",".cer":"application/pkix-cert",".cfs":"application/x-cfs-compressed",".cgm":"image/cgm",".chat":"application/x-chat",".chm":"application/vnd.ms-htmlhelp",".chrt":"application/vnd.kde.kchart",".cif":"chemical/x-cif",".cii":"application/vnd.anser-web-certificate-issue-initiation",".cil":"application/vnd.ms-artgalry",".cjs":"application/node",".cla":"application/vnd.claymore",".class":"application/java-vm",".clkk":"application/vnd.crick.clicker.keyboard",".clkp":"application/vnd.crick.clicker.palette",".clkt":"application/vnd.crick.clicker.template",".clkw":"application/vnd.crick.clicker.wordbank",".clkx":"application/vnd.crick.clicker",".clp":"application/x-msclip",".cmc":"application/vnd.cosmocaller",".cmdf":"chemical/x-cmdf",".cml":"chemical/x-cml",".cmp":"application/vnd.yellowriver-custom-menu",".cmx":"image/x-cmx",".cod":"application/vnd.rim.cod",".coffee":"text/coffeescript",".com":"application/x-msdownload",".conf":"text/plain",".cpio":"application/x-cpio",".cpl":"application/cpl+xml",".cpp":"text/x-c",".cpt":"application/mac-compactpro",".crd":"application/x-mscardfile",".crl":"application/pkix-crl",".crt":"application/x-x509-ca-cert",".crx":"application/x-chrome-extension",".cryptonote":"application/vnd.rig.cryptonote",".csh":"application/x-csh",".csl":"application/vnd.citationstyles.style+xml",".csml":"chemical/x-csml",".csp":"application/vnd.commonspace",".css":"text/css",".cst":"application/x-director",".csv":"text/csv",".cu":"application/cu-seeme",".curl":"text/vnd.curl",".cww":"application/prs.cww",".cxt":"application/x-director",".cxx":"text/x-c",".dae":"model/vnd.collada+xml",".daf":"application/vnd.mobius.daf",".dart":"application/vnd.dart",".dataless":"application/vnd.fdsn.seed",".davmount":"application/davmount+xml",".dbf":"application/vnd.dbf",".dbk":"application/docbook+xml",".dcr":"application/x-director",".dcurl":"text/vnd.curl.dcurl",".dd2":"application/vnd.oma.dd2+xml",".ddd":"application/vnd.fujixerox.ddd",".ddf":"application/vnd.syncml.dmddf+xml",".dds":"image/vnd.ms-dds",".def":"text/plain",".deploy":"application/octet-stream",".der":"application/x-x509-ca-cert",".dfac":"application/vnd.dreamfactory",".dgc":"application/x-dgc-compressed",".dic":"text/x-c",".dir":"application/x-director",".dis":"application/vnd.mobius.dis",".disposition-notification":"message/disposition-notification",".dist":"application/octet-stream",".distz":"application/octet-stream",".djv":"image/vnd.djvu",".djvu":"image/vnd.djvu",".dll":"application/octet-stream",".dmg":"application/x-apple-diskimage",".dmp":"application/vnd.tcpdump.pcap",".dms":"application/octet-stream",".dna":"application/vnd.dna",".doc":"application/msword",".docm":"application/vnd.ms-word.document.macroenabled.12",".docx":"application/vnd.openxmlformats-officedocument.wordprocessingml.document",".dot":"application/msword",".dotm":"application/vnd.ms-word.template.macroenabled.12",".dotx":"application/vnd.openxmlformats-officedocument.wordprocessingml.template",".dp":"application/vnd.osgi.dp",".dpg":"application/vnd.dpgraph",".dra":"audio/vnd.dra",".drle":"image/dicom-rle",".dsc":"text/prs.lines.tag",".dssc":"application/dssc+der",".dtb":"application/x-dtbook+xml",".dtd":"application/xml-dtd",".dts":"audio/vnd.dts",".dtshd":"audio/vnd.dts.hd",".dump":"application/octet-stream",".dvb":"video/vnd.dvb.file",".dvi":"application/x-dvi",".dwd":"application/atsc-dwd+xml",".dwf":"model/vnd.dwf",".dwg":"image/vnd.dwg",".dxf":"image/vnd.dxf",".dxp":"application/vnd.spotfire.dxp",".dxr":"application/x-director",".ear":"application/java-archive",".ecelp4800":"audio/vnd.nuera.ecelp4800",".ecelp7470":"audio/vnd.nuera.ecelp7470",".ecelp9600":"audio/vnd.nuera.ecelp9600",".ecma":"application/ecmascript",".edm":"application/vnd.novadigm.edm",".edx":"application/vnd.novadigm.edx",".efif":"application/vnd.picsel",".ei6":"application/vnd.pg.osasli",".elc":"application/octet-stream",".eml":"message/rfc822",".emma":"application/emma+xml",".emotionml":"application/emotionml+xml",".emz":"application/x-msmetafile",".eol":"audio/vnd.digital-winds",".eot":"application/vnd.ms-fontobject",".eps":"application/postscript",".epub":"application/epub+zip",".es":"application/ecmascript",".es3":"application/vnd.eszigno3+xml",".esa":"application/vnd.osgi.subsystem",".esf":"application/vnd.epson.esf",".et3":"application/vnd.eszigno3+xml",".etx":"text/x-setext",".eva":"application/x-eva",".evy":"application/x-envoy",".exe":"application/octet-stream",".exi":"application/exi",".exp":"application/express",".exr":"image/aces",".ext":"application/vnd.novadigm.ext",".ez":"application/andrew-inset",".ez2":"application/vnd.ezpix-album",".ez3":"application/vnd.ezpix-package",".f":"text/x-fortran",".f4v":"video/x-f4v",".f77":"text/x-fortran",".f90":"text/x-fortran",".fbs":"image/vnd.fastbidsheet",".fcdt":"application/vnd.adobe.formscentral.fcdt",".fcs":"application/vnd.isac.fcs",".fdf":"application/vnd.fdf",".fdt":"application/fdt+xml",".fe_launch":"application/vnd.denovo.fcselayout-link",".fg5":"application/vnd.fujitsu.oasysgp",".fgd":"application/x-director",".fh":"image/x-freehand",".fh4":"image/x-freehand",".fh5":"image/x-freehand",".fh7":"image/x-freehand",".fhc":"image/x-freehand",".fig":"application/x-xfig",".fits":"image/fits",".flac":"audio/x-flac",".fli":"video/x-fli",".flo":"application/vnd.micrografx.flo",".flv":"video/x-flv",".flw":"application/vnd.kde.kivio",".flx":"text/vnd.fmi.flexstor",".fly":"text/vnd.fly",".fm":"application/vnd.framemaker",".fnc":"application/vnd.frogans.fnc",".fo":"application/vnd.software602.filler.form+xml",".for":"text/x-fortran",".fpx":"image/vnd.fpx",".frame":"application/vnd.framemaker",".fsc":"application/vnd.fsc.weblaunch",".fst":"image/vnd.fst",".ftc":"application/vnd.fluxtime.clip",".fti":"application/vnd.anser-web-funds-transfer-initiation",".fvt":"video/vnd.fvt",".fxp":"application/vnd.adobe.fxp",".fxpl":"application/vnd.adobe.fxp",".fzs":"application/vnd.fuzzysheet",".g2w":"application/vnd.geoplan",".g3":"image/g3fax",".g3w":"application/vnd.geospace",".gac":"application/vnd.groove-account",".gam":"application/x-tads",".gbr":"application/rpki-ghostbusters",".gca":"application/x-gca-compressed",".gdl":"model/vnd.gdl",".gdoc":"application/vnd.google-apps.document",".ged":"text/vnd.familysearch.gedcom",".geo":"application/vnd.dynageo",".geojson":"application/geo+json",".gex":"application/vnd.geometry-explorer",".ggb":"application/vnd.geogebra.file",".ggt":"application/vnd.geogebra.tool",".ghf":"application/vnd.groove-help",".gif":"image/gif",".gim":"application/vnd.groove-identity-message",".glb":"model/gltf-binary",".gltf":"model/gltf+json",".gml":"application/gml+xml",".gmx":"application/vnd.gmx",".gnumeric":"application/x-gnumeric",".gph":"application/vnd.flographit",".gpx":"application/gpx+xml",".gqf":"application/vnd.grafeq",".gqs":"application/vnd.grafeq",".gram":"application/srgs",".gramps":"application/x-gramps-xml",".gre":"application/vnd.geometry-explorer",".grv":"application/vnd.groove-injector",".grxml":"application/srgs+xml",".gsf":"application/x-font-ghostscript",".gsheet":"application/vnd.google-apps.spreadsheet",".gslides":"application/vnd.google-apps.presentation",".gtar":"application/x-gtar",".gtm":"application/vnd.groove-tool-message",".gtw":"model/vnd.gtw",".gv":"text/vnd.graphviz",".gxf":"application/gxf",".gxt":"application/vnd.geonext",".gz":"application/gzip",".h":"text/x-c",".h261":"video/h261",".h263":"video/h263",".h264":"video/h264",".hal":"application/vnd.hal+xml",".hbci":"application/vnd.hbci",".hbs":"text/x-handlebars-template",".hdd":"application/x-virtualbox-hdd",".hdf":"application/x-hdf",".heic":"image/heic",".heics":"image/heic-sequence",".heif":"image/heif",".heifs":"image/heif-sequence",".hej2":"image/hej2k",".held":"application/atsc-held+xml",".hh":"text/x-c",".hjson":"application/hjson",".hlp":"application/winhlp",".hpgl":"application/vnd.hp-hpgl",".hpid":"application/vnd.hp-hpid",".hps":"application/vnd.hp-hps",".hqx":"application/mac-binhex40",".hsj2":"image/hsj2",".htc":"text/x-component",".htke":"application/vnd.kenameaapp",".htm":"text/html",".html":"text/html",".hvd":"application/vnd.yamaha.hv-dic",".hvp":"application/vnd.yamaha.hv-voice",".hvs":"application/vnd.yamaha.hv-script",".i2g":"application/vnd.intergeo",".icc":"application/vnd.iccprofile",".ice":"x-conference/x-cooltalk",".icm":"application/vnd.iccprofile",".ics":"text/calendar",".ief":"image/ief",".ifb":"text/calendar",".ifm":"application/vnd.shana.informed.formdata",".iges":"model/iges",".igl":"application/vnd.igloader",".igm":"application/vnd.insors.igm",".igs":"model/iges",".igx":"application/vnd.micrografx.igx",".iif":"application/vnd.shana.informed.interchange",".img":"application/octet-stream",".imp":"application/vnd.accpac.simply.imp",".ims":"application/vnd.ms-ims",".in":"text/plain",".ini":"text/plain",".ink":"application/inkml+xml",".inkml":"application/inkml+xml",".install":"application/x-install-instructions",".iota":"application/vnd.astraea-software.iota",".ipfix":"application/ipfix",".ipk":"application/vnd.shana.informed.package",".irm":"application/vnd.ibm.rights-management",".irp":"application/vnd.irepository.package+xml",".itp":"application/vnd.shana.informed.formtemplate",".its":"application/its+xml",".ivp":"application/vnd.immervision-ivp",".ivu":"application/vnd.immervision-ivu",".jad":"text/vnd.sun.j2me.app-descriptor",".jade":"text/jade",".jam":"application/vnd.jam",".jar":"application/java-archive",".jardiff":"application/x-java-archive-diff",".java":"text/x-java-source",".jhc":"image/jphc",".jisp":"application/vnd.jisp",".jls":"image/jls",".jlt":"application/vnd.hp-jlyt",".jng":"image/x-jng",".jnlp":"application/x-java-jnlp-file",".joda":"application/vnd.joost.joda-archive",".jp2":"image/jp2",".jpe":"image/jpeg",".jpeg":"image/jpeg",".jpf":"image/jpx",".jpg":"image/jpeg",".jpg2":"image/jp2",".jpgm":"video/jpm",".jpgv":"video/jpeg",".jph":"image/jph",".jpx":"image/jpx",".js":"application/javascript",".json":"application/json",".json5":"application/json5",".jsonld":"application/ld+json",".jsonml":"application/jsonml+json",".jsx":"text/jsx",".jxr":"image/jxr",".jxra":"image/jxra",".jxrs":"image/jxrs",".jxs":"image/jxs",".jxsc":"image/jxsc",".jxsi":"image/jxsi",".jxss":"image/jxss",".kar":"audio/midi",".karbon":"application/vnd.kde.karbon",".kdbx":"application/x-keepass2",".kfo":"application/vnd.kde.kformula",".kia":"application/vnd.kidspiration",".kml":"application/vnd.google-earth.kml+xml",".kmz":"application/vnd.google-earth.kmz",".kne":"application/vnd.kinar",".knp":"application/vnd.kinar",".kon":"application/vnd.kde.kontour",".kpr":"application/vnd.kde.kpresenter",".kpt":"application/vnd.kde.kpresenter",".kpxx":"application/vnd.ds-keypoint",".ksp":"application/vnd.kde.kspread",".ktr":"application/vnd.kahootz",".ktx":"image/ktx",".ktx2":"image/ktx2",".ktz":"application/vnd.kahootz",".kwd":"application/vnd.kde.kword",".kwt":"application/vnd.kde.kword",".lasxml":"application/vnd.las.las+xml",".latex":"application/x-latex",".lbd":"application/vnd.llamagraphics.life-balance.desktop",".lbe":"application/vnd.llamagraphics.life-balance.exchange+xml",".les":"application/vnd.hhe.lesson-player",".less":"text/less",".lgr":"application/lgr+xml",".lha":"application/x-lzh-compressed",".link66":"application/vnd.route66.link66+xml",".list":"text/plain",".list3820":"application/vnd.ibm.modcap",".listafp":"application/vnd.ibm.modcap",".litcoffee":"text/coffeescript",".lnk":"application/x-ms-shortcut",".log":"text/plain",".lostxml":"application/lost+xml",".lrf":"application/octet-stream",".lrm":"application/vnd.ms-lrm",".ltf":"application/vnd.frogans.ltf",".lua":"text/x-lua",".luac":"application/x-lua-bytecode",".lvp":"audio/vnd.lucent.voice",".lwp":"application/vnd.lotus-wordpro",".lzh":"application/x-lzh-compressed",".m13":"application/x-msmediaview",".m14":"application/x-msmediaview",".m1v":"video/mpeg",".m21":"application/mp21",".m2a":"audio/mpeg",".m2v":"video/mpeg",".m3a":"audio/mpeg",".m3u":"audio/x-mpegurl",".m3u8":"application/vnd.apple.mpegurl",".m4p":"application/mp4",".m4s":"video/iso.segment",".m4u":"video/vnd.mpegurl",".m4v":"video/x-m4v",".ma":"application/mathematica",".mads":"application/mads+xml",".maei":"application/mmt-aei+xml",".mag":"application/vnd.ecowin.chart",".maker":"application/vnd.framemaker",".man":"text/troff",".manifest":"text/cache-manifest",".map":"application/json",".mar":"application/octet-stream",".markdown":"text/markdown",".mathml":"application/mathml+xml",".mb":"application/mathematica",".mbk":"application/vnd.mobius.mbk",".mbox":"application/mbox",".mc1":"application/vnd.medcalcdata",".mcd":"application/vnd.mcd",".mcurl":"text/vnd.curl.mcurl",".md":"text/markdown",".mdb":"application/x-msaccess",".mdi":"image/vnd.ms-modi",".mdx":"text/mdx",".me":"text/troff",".mesh":"model/mesh",".meta4":"application/metalink4+xml",".metalink":"application/metalink+xml",".mets":"application/mets+xml",".mfm":"application/vnd.mfmp",".mft":"application/rpki-manifest",".mgp":"application/vnd.osgeo.mapguide.package",".mgz":"application/vnd.proteus.magazine",".mid":"audio/midi",".midi":"audio/midi",".mie":"application/x-mie",".mif":"application/vnd.mif",".mime":"message/rfc822",".mj2":"video/mj2",".mjp2":"video/mj2",".mjs":"application/module+javascript",".mk3d":"video/x-matroska",".mka":"audio/x-matroska",".mkd":"text/x-markdown",".mks":"video/x-matroska",".mkv":"video/x-matroska",".mlp":"application/vnd.dolby.mlp",".mmd":"application/vnd.chipnuts.karaoke-mmd",".mmf":"application/vnd.smaf",".mml":"text/mathml",".mmr":"image/vnd.fujixerox.edmics-mmr",".mng":"video/x-mng",".mny":"application/x-msmoney",".mobi":"application/x-mobipocket-ebook",".mods":"application/mods+xml",".mov":"video/quicktime",".movie":"video/x-sgi-movie",".mp2":"audio/mpeg",".mp21":"application/mp21",".mp2a":"audio/mpeg",".mp3":"audio/mpeg",".mp4":"video/mp4",".mp4a":"audio/mp4",".mp4s":"application/mp4",".mp4v":"video/mp4",".mpc":"application/vnd.mophun.certificate",".mpd":"application/dash+xml",".mpe":"video/mpeg",".mpeg":"video/mpeg",".mpf":"application/media-policy-dataset+xml",".mpg":"video/mpeg",".mpg4":"video/mp4",".mpga":"audio/mpeg",".mpkg":"application/vnd.apple.installer+xml",".mpm":"application/vnd.blueice.multipass",".mpn":"application/vnd.mophun.application",".mpt":"application/vnd.ms-project",".mpy":"application/vnd.ibm.minipay",".mqy":"application/vnd.mobius.mqy",".mrc":"application/marc",".mrcx":"application/marcxml+xml",".ms":"text/troff",".mscml":"application/mediaservercontrol+xml",".mseed":"application/vnd.fdsn.mseed",".mseq":"application/vnd.mseq",".msf":"application/vnd.epson.msf",".msg":"application/vnd.ms-outlook",".msh":"model/mesh",".msi":"application/octet-stream",".msl":"application/vnd.mobius.msl",".msm":"application/octet-stream",".msp":"application/octet-stream",".msty":"application/vnd.muvee.style",".mtl":"model/mtl",".mts":"model/vnd.mts",".mus":"application/vnd.musician",".musd":"application/mmt-usd+xml",".musicxml":"application/vnd.recordare.musicxml+xml",".mvb":"application/x-msmediaview",".mvt":"application/vnd.mapbox-vector-tile",".mwf":"application/vnd.mfer",".mxf":"application/mxf",".mxl":"application/vnd.recordare.musicxml",".mxmf":"audio/mobile-xmf",".mxml":"application/xv+xml",".mxs":"application/vnd.triscape.mxs",".mxu":"video/vnd.mpegurl",".n-gage":"application/vnd.nokia.n-gage.symbian.install",".n3":"text/n3",".nb":"application/mathematica",".nbp":"application/vnd.wolfram.player",".nc":"application/x-netcdf",".ncx":"application/x-dtbncx+xml",".nfo":"text/x-nfo",".ngdat":"application/vnd.nokia.n-gage.data",".nitf":"application/vnd.nitf",".nlu":"application/vnd.neurolanguage.nlu",".nml":"application/vnd.enliven",".nnd":"application/vnd.noblenet-directory",".nns":"application/vnd.noblenet-sealer",".nnw":"application/vnd.noblenet-web",".npx":"image/vnd.net-fpx",".nq":"application/n-quads",".nsc":"application/x-conference",".nsf":"application/vnd.lotus-notes",".nt":"application/n-triples",".ntf":"application/vnd.nitf",".nzb":"application/x-nzb",".oa2":"application/vnd.fujitsu.oasys2",".oa3":"application/vnd.fujitsu.oasys3",".oas":"application/vnd.fujitsu.oasys",".obd":"application/x-msbinder",".obgx":"application/vnd.openblox.game+xml",".oda":"application/oda",".odb":"application/vnd.oasis.opendocument.database",".odc":"application/vnd.oasis.opendocument.chart",".odf":"application/vnd.oasis.opendocument.formula",".odft":"application/vnd.oasis.opendocument.formula-template",".odg":"application/vnd.oasis.opendocument.graphics",".odi":"application/vnd.oasis.opendocument.image",".odm":"application/vnd.oasis.opendocument.text-master",".odp":"application/vnd.oasis.opendocument.presentation",".ods":"application/vnd.oasis.opendocument.spreadsheet",".odt":"application/vnd.oasis.opendocument.text",".oga":"audio/ogg",".ogex":"model/vnd.opengex",".ogg":"audio/ogg",".ogv":"video/ogg",".ogx":"application/ogg",".omdoc":"application/omdoc+xml",".onepkg":"application/onenote",".onetmp":"application/onenote",".onetoc":"application/onenote",".onetoc2":"application/onenote",".opf":"application/oebps-package+xml",".opml":"text/x-opml",".oprc":"application/vnd.palm",".opus":"audio/ogg",".osf":"application/vnd.yamaha.openscoreformat",".osfpvg":"application/vnd.yamaha.openscoreformat.osfpvg+xml",".osm":"application/vnd.openstreetmap.data+xml",".otc":"application/vnd.oasis.opendocument.chart-template",".otf":"font/otf",".otg":"application/vnd.oasis.opendocument.graphics-template",".oth":"application/vnd.oasis.opendocument.text-web",".oti":"application/vnd.oasis.opendocument.image-template",".otp":"application/vnd.oasis.opendocument.presentation-template",".ots":"application/vnd.oasis.opendocument.spreadsheet-template",".ott":"application/vnd.oasis.opendocument.text-template",".ova":"application/x-virtualbox-ova",".ovf":"application/x-virtualbox-ovf",".owl":"application/rdf+xml",".oxps":"application/oxps",".oxt":"application/vnd.openofficeorg.extension",".p":"text/x-pascal",".p10":"application/pkcs10",".p12":"application/x-pkcs12",".p7b":"application/x-pkcs7-certificates",".p7c":"application/pkcs7-mime",".p7m":"application/pkcs7-mime",".p7r":"application/x-pkcs7-certreqresp",".p7s":"application/pkcs7-signature",".p8":"application/pkcs8",".pac":"application/x-ns-proxy-autoconfig",".pas":"text/x-pascal",".paw":"application/vnd.pawaafile",".pbd":"application/vnd.powerbuilder6",".pbm":"image/x-portable-bitmap",".pcap":"application/vnd.tcpdump.pcap",".pcf":"application/x-font-pcf",".pcl":"application/vnd.hp-pcl",".pclxl":"application/vnd.hp-pclxl",".pct":"image/x-pict",".pcurl":"application/vnd.curl.pcurl",".pde":"text/x-processing",".pdf":"application/pdf",".pem":"application/x-x509-ca-cert",".pfa":"application/x-font-type1",".pfb":"application/x-font-type1",".pfm":"application/x-font-type1",".pfr":"application/font-tdpfr",".pfx":"application/x-pkcs12",".pgm":"image/x-portable-graymap",".pgn":"application/x-chess-pgn",".pgp":"application/pgp-encrypted",".php":"application/x-httpd-php",".pic":"image/x-pict",".pkg":"application/octet-stream",".pki":"application/pkixcmp",".pkipath":"application/pkix-pkipath",".pkpass":"application/vnd.apple.pkpass",".pl":"application/x-perl",".plb":"application/vnd.3gpp.pic-bw-large",".plc":"application/vnd.mobius.plc",".plf":"application/vnd.pocketlearn",".pls":"application/pls+xml",".pm":"application/x-perl",".pml":"application/vnd.ctc-posml",".png":"image/png",".pnm":"image/x-portable-anymap",".portpkg":"application/vnd.macports.portpkg",".pot":"application/vnd.ms-powerpoint",".potm":"application/vnd.ms-powerpoint.template.macroenabled.12",".potx":"application/vnd.openxmlformats-officedocument.presentationml.template",".ppam":"application/vnd.ms-powerpoint.addin.macroenabled.12",".ppd":"application/vnd.cups-ppd",".ppm":"image/x-portable-pixmap",".pps":"application/vnd.ms-powerpoint",".ppsm":"application/vnd.ms-powerpoint.slideshow.macroenabled.12",".ppsx":"application/vnd.openxmlformats-officedocument.presentationml.slideshow",".ppt":"application/vnd.ms-powerpoint",".pptm":"application/vnd.ms-powerpoint.presentation.macroenabled.12",".pptx":"application/vnd.openxmlformats-officedocument.presentationml.presentation",".pqa":"application/vnd.palm",".pre":"application/vnd.lotus-freelance",".prf":"application/pics-rules",".provx":"application/provenance+xml",".ps":"application/postscript",".psb":"application/vnd.3gpp.pic-bw-small",".psd":"image/vnd.adobe.photoshop",".psf":"application/x-font-linux-psf",".pskcxml":"application/pskc+xml",".pti":"image/prs.pti",".ptid":"application/vnd.pvi.ptid1",".pub":"application/x-mspublisher",".pvb":"application/vnd.3gpp.pic-bw-var",".pwn":"application/vnd.3m.post-it-notes",".pya":"audio/vnd.ms-playready.media.pya",".pyv":"video/vnd.ms-playready.media.pyv",".qam":"application/vnd.epson.quickanime",".qbo":"application/vnd.intu.qbo",".qfx":"application/vnd.intu.qfx",".qps":"application/vnd.publishare-delta-tree",".qt":"video/quicktime",".qwd":"application/vnd.quark.quarkxpress",".qwt":"application/vnd.quark.quarkxpress",".qxb":"application/vnd.quark.quarkxpress",".qxd":"application/vnd.quark.quarkxpress",".qxl":"application/vnd.quark.quarkxpress",".qxt":"application/vnd.quark.quarkxpress",".ram":"audio/x-pn-realaudio",".raml":"application/raml+yaml",".rapd":"application/route-apd+xml",".ras":"image/x-cmu-raster",".rcprofile":"application/vnd.ipunplugged.rcprofile",".rdf":"application/rdf+xml",".rdz":"application/vnd.data-vision.rdz",".relo":"application/p2p-overlay+xml",".rep":"application/vnd.businessobjects",".res":"application/x-dtbresource+xml",".rgb":"image/x-rgb",".rif":"application/reginfo+xml",".rip":"audio/vnd.rip",".ris":"application/x-research-info-systems",".rl":"application/resource-lists+xml",".rlc":"image/vnd.fujixerox.edmics-rlc",".rld":"application/resource-lists-diff+xml",".rm":"application/vnd.rn-realmedia",".rmi":"audio/midi",".rmp":"audio/x-pn-realaudio-plugin",".rms":"application/vnd.jcp.javame.midlet-rms",".rmvb":"application/vnd.rn-realmedia-vbr",".rnc":"application/relax-ng-compact-syntax",".rng":"application/xml",".roa":"application/rpki-roa",".roff":"text/troff",".rp9":"application/vnd.cloanto.rp9",".rpm":"application/x-redhat-package-manager",".rpss":"application/vnd.nokia.radio-presets",".rpst":"application/vnd.nokia.radio-preset",".rq":"application/sparql-query",".rs":"application/rls-services+xml",".rsat":"application/atsc-rsat+xml",".rsd":"application/rsd+xml",".rsheet":"application/urc-ressheet+xml",".rss":"application/rss+xml",".rtx":"text/richtext",".run":"application/x-makeself",".rusd":"application/route-usd+xml",".s":"text/x-asm",".s3m":"audio/s3m",".saf":"application/vnd.yamaha.smaf-audio",".sass":"text/x-sass",".sbml":"application/sbml+xml",".sc":"application/vnd.ibm.secure-container",".scd":"application/x-msschedule",".scm":"application/vnd.lotus-screencam",".scq":"application/scvp-cv-request",".scs":"application/scvp-cv-response",".scss":"text/x-scss",".scurl":"text/vnd.curl.scurl",".sda":"application/vnd.stardivision.draw",".sdc":"application/vnd.stardivision.calc",".sdd":"application/vnd.stardivision.impress",".sdkd":"application/vnd.solent.sdkm+xml",".sdkm":"application/vnd.solent.sdkm+xml",".sdp":"application/sdp",".sdw":"application/vnd.stardivision.writer",".sea":"application/x-sea",".see":"application/vnd.seemail",".seed":"application/vnd.fdsn.seed",".sema":"application/vnd.sema",".semd":"application/vnd.semd",".semf":"application/vnd.semf",".senmlx":"application/senml+xml",".sensmlx":"application/sensml+xml",".ser":"application/java-serialized-object",".setpay":"application/set-payment-initiation",".setreg":"application/set-registration-initiation",".sfd-hdstx":"application/vnd.hydrostatix.sof-data",".sfs":"application/vnd.spotfire.sfs",".sfv":"text/x-sfv",".sgi":"image/sgi",".sgl":"application/vnd.stardivision.writer-global",".sgm":"text/sgml",".sgml":"text/sgml",".sh":"application/x-sh",".shar":"application/x-shar",".shex":"text/shex",".shf":"application/shf+xml",".shtml":"text/html",".sid":"image/x-mrsid-image",".sieve":"application/sieve",".sig":"application/pgp-signature",".sil":"audio/silk",".silo":"model/mesh",".sis":"application/vnd.symbian.install",".sisx":"application/vnd.symbian.install",".sit":"application/x-stuffit",".sitx":"application/x-stuffitx",".siv":"application/sieve",".skd":"application/vnd.koan",".skm":"application/vnd.koan",".skp":"application/vnd.koan",".skt":"application/vnd.koan",".sldm":"application/vnd.ms-powerpoint.slide.macroenabled.12",".sldx":"application/vnd.openxmlformats-officedocument.presentationml.slide",".slim":"text/slim",".slm":"text/slim",".sls":"application/route-s-tsid+xml",".slt":"application/vnd.epson.salt",".sm":"application/vnd.stepmania.stepchart",".smf":"application/vnd.stardivision.math",".smi":"application/smil+xml",".smil":"application/smil+xml",".smv":"video/x-smv",".smzip":"application/vnd.stepmania.package",".snd":"audio/basic",".snf":"application/x-font-snf",".so":"application/octet-stream",".spc":"application/x-pkcs7-certificates",".spdx":"text/spdx",".spf":"application/vnd.yamaha.smaf-phrase",".spl":"application/x-futuresplash",".spot":"text/vnd.in3d.spot",".spp":"application/scvp-vp-response",".spq":"application/scvp-vp-request",".spx":"audio/ogg",".sq3":"application/vnd.sqlite3",".sql":"application/x-sql",".sqlite3":"application/vnd.sqlite3",".src":"application/x-wais-source",".srt":"application/x-subrip",".sru":"application/sru+xml",".srx":"application/sparql-results+xml",".ssdl":"application/ssdl+xml",".sse":"application/vnd.kodak-descriptor",".ssf":"application/vnd.epson.ssf",".ssml":"application/ssml+xml",".st":"application/vnd.sailingtracker.track",".stc":"application/vnd.sun.xml.calc.template",".std":"application/vnd.sun.xml.draw.template",".stf":"application/vnd.wt.stf",".sti":"application/vnd.sun.xml.impress.template",".stk":"application/hyperstudio",".stpx":"model/step+xml",".stpxz":"model/step-xml+zip",".stpz":"model/step+zip",".str":"application/vnd.pg.format",".stw":"application/vnd.sun.xml.writer.template",".styl":"text/stylus",".stylus":"text/stylus",".sus":"application/vnd.sus-calendar",".susp":"application/vnd.sus-calendar",".sv4cpio":"application/x-sv4cpio",".sv4crc":"application/x-sv4crc",".svc":"application/vnd.dvb.service",".svd":"application/vnd.svd",".svg":"image/svg+xml",".svgz":"image/svg+xml",".swa":"application/x-director",".swf":"application/x-shockwave-flash",".swi":"application/vnd.aristanetworks.swi",".swidtag":"application/swid+xml",".sxc":"application/vnd.sun.xml.calc",".sxd":"application/vnd.sun.xml.draw",".sxg":"application/vnd.sun.xml.writer.global",".sxi":"application/vnd.sun.xml.impress",".sxm":"application/vnd.sun.xml.math",".sxw":"application/vnd.sun.xml.writer",".t":"text/troff",".t3":"application/x-t3vm-image",".t38":"image/t38",".taglet":"application/vnd.mynfc",".tao":"application/vnd.tao.intent-module-archive",".tap":"image/vnd.tencent.tap",".tar":"application/x-tar",".tcap":"application/vnd.3gpp2.tcap",".tcl":"application/x-tcl",".td":"application/urc-targetdesc+xml",".teacher":"application/vnd.smart.teacher",".tei":"application/tei+xml",".teicorpus":"application/tei+xml",".tex":"application/x-tex",".texi":"application/x-texinfo",".texinfo":"application/x-texinfo",".text":"text/plain",".tfi":"application/thraud+xml",".tfm":"application/x-tex-tfm",".tfx":"image/tiff-fx",".tga":"image/x-tga",".thmx":"application/vnd.ms-officetheme",".tif":"image/tiff",".tiff":"image/tiff",".tk":"application/x-tcl",".tmo":"application/vnd.tmobile-livetv",".toml":"application/toml",".torrent":"application/x-bittorrent",".tpl":"application/vnd.groove-tool-template",".tpt":"application/vnd.trid.tpt",".tr":"text/troff",".tra":"application/vnd.trueapp",".trig":"application/trig",".trm":"application/x-msterminal",".ts":"video/mp2t",".tsd":"application/timestamped-data",".tsv":"text/tab-separated-values",".ttc":"font/collection",".ttf":"font/ttf",".ttl":"text/turtle",".ttml":"application/ttml+xml",".twd":"application/vnd.simtech-mindmapper",".twds":"application/vnd.simtech-mindmapper",".txd":"application/vnd.genomatix.tuxedo",".txf":"application/vnd.mobius.txf",".txt":"text/plain",".u32":"application/x-authorware-bin",".u8dsn":"message/global-delivery-status",".u8hdr":"message/global-headers",".u8mdn":"message/global-disposition-notification",".u8msg":"message/global",".ubj":"application/ubjson",".udeb":"application/x-debian-package",".ufd":"application/vnd.ufdl",".ufdl":"application/vnd.ufdl",".ulx":"application/x-glulx",".umj":"application/vnd.umajin",".unityweb":"application/vnd.unity",".uoml":"application/vnd.uoml+xml",".uri":"text/uri-list",".uris":"text/uri-list",".urls":"text/uri-list",".usdz":"model/vnd.usdz+zip",".ustar":"application/x-ustar",".utz":"application/vnd.uiq.theme",".uu":"text/x-uuencode",".uva":"audio/vnd.dece.audio",".uvd":"application/vnd.dece.data",".uvf":"application/vnd.dece.data",".uvg":"image/vnd.dece.graphic",".uvh":"video/vnd.dece.hd",".uvi":"image/vnd.dece.graphic",".uvm":"video/vnd.dece.mobile",".uvp":"video/vnd.dece.pd",".uvs":"video/vnd.dece.sd",".uvt":"application/vnd.dece.ttml+xml",".uvu":"video/vnd.uvvu.mp4",".uvv":"video/vnd.dece.video",".uvva":"audio/vnd.dece.audio",".uvvd":"application/vnd.dece.data",".uvvf":"application/vnd.dece.data",".uvvg":"image/vnd.dece.graphic",".uvvh":"video/vnd.dece.hd",".uvvi":"image/vnd.dece.graphic",".uvvm":"video/vnd.dece.mobile",".uvvp":"video/vnd.dece.pd",".uvvs":"video/vnd.dece.sd",".uvvt":"application/vnd.dece.ttml+xml",".uvvu":"video/vnd.uvvu.mp4",".uvvv":"video/vnd.dece.video",".uvvx":"application/vnd.dece.unspecified",".uvvz":"application/vnd.dece.zip",".uvx":"application/vnd.dece.unspecified",".uvz":"application/vnd.dece.zip",".vbox":"application/x-virtualbox-vbox",".vbox-extpack":"application/x-virtualbox-vbox-extpack",".vcard":"text/vcard",".vcd":"application/x-cdlink",".vcf":"text/x-vcard",".vcg":"application/vnd.groove-vcard",".vcs":"text/x-vcalendar",".vcx":"application/vnd.vcx",".vdi":"application/x-virtualbox-vdi",".vds":"model/vnd.sap.vds",".vhd":"application/x-virtualbox-vhd",".vis":"application/vnd.visionary",".viv":"video/vnd.vivo",".vmdk":"application/x-virtualbox-vmdk",".vob":"video/x-ms-vob",".vor":"application/vnd.stardivision.writer",".vox":"application/x-authorware-bin",".vrml":"model/vrml",".vsd":"application/vnd.visio",".vsf":"application/vnd.vsf",".vss":"application/vnd.visio",".vst":"application/vnd.visio",".vsw":"application/vnd.visio",".vtf":"image/vnd.valve.source.texture",".vtt":"text/vtt",".vtu":"model/vnd.vtu",".vxml":"application/voicexml+xml",".w3d":"application/x-director",".wad":"application/x-doom",".wadl":"application/vnd.sun.wadl+xml",".war":"application/java-archive",".wasm":"application/wasm",".wax":"audio/x-ms-wax",".wbmp":"image/vnd.wap.wbmp",".wbs":"application/vnd.criticaltools.wbs+xml",".wbxml":"application/vnd.wap.wbxml",".wcm":"application/vnd.ms-works",".wdb":"application/vnd.ms-works",".wdp":"image/vnd.ms-photo",".weba":"audio/webm",".webapp":"application/x-web-app-manifest+json",".webm":"video/webm",".webmanifest":"application/manifest+json",".webp":"image/webp",".wg":"application/vnd.pmi.widget",".wgt":"application/widget",".wif":"application/watcherinfo+xml",".wks":"application/vnd.ms-works",".wm":"video/x-ms-wm",".wma":"audio/x-ms-wma",".wmd":"application/x-ms-wmd",".wml":"text/vnd.wap.wml",".wmlc":"application/vnd.wap.wmlc",".wmls":"text/vnd.wap.wmlscript",".wmlsc":"application/vnd.wap.wmlscriptc",".wmv":"video/x-ms-wmv",".wmx":"video/x-ms-wmx",".woff":"font/woff",".woff2":"font/woff2",".wpd":"application/vnd.wordperfect",".wpl":"application/vnd.ms-wpl",".wps":"application/vnd.ms-works",".wqd":"application/vnd.wqd",".wri":"application/x-mswrite",".wrl":"model/vrml",".wsc":"message/vnd.wfa.wsc",".wsdl":"application/wsdl+xml",".wspolicy":"application/wspolicy+xml",".wtb":"application/vnd.webturbo",".wvx":"video/x-ms-wvx",".x_b":"model/vnd.parasolid.transmit.binary",".x_t":"model/vnd.parasolid.transmit.text",".x32":"application/x-authorware-bin",".x3d":"model/x3d+xml",".x3dbz":"model/x3d+binary",".x3dvz":"model/x3d+vrml",".x3dz":"model/x3d+xml",".xaml":"application/xaml+xml",".xap":"application/x-silverlight-app",".xar":"application/vnd.xara",".xav":"application/xcap-att+xml",".xbap":"application/x-ms-xbap",".xbd":"application/vnd.fujixerox.docuworks.binder",".xbm":"image/x-xbitmap",".xca":"application/xcap-caps+xml",".xcs":"application/calendar+xml",".xdf":"application/xcap-diff+xml",".xdm":"application/vnd.syncml.dm+xml",".xdp":"application/vnd.adobe.xdp+xml",".xdssc":"application/dssc+xml",".xdw":"application/vnd.fujixerox.docuworks",".xel":"application/xcap-el+xml",".xenc":"application/xenc+xml",".xer":"application/patch-ops-error+xml",".xfdf":"application/vnd.adobe.xfdf",".xfdl":"application/vnd.xfdl",".xht":"application/xhtml+xml",".xhtml":"application/xhtml+xml",".xhvml":"application/xv+xml",".xif":"image/vnd.xiff",".xla":"application/vnd.ms-excel",".xlam":"application/vnd.ms-excel.addin.macroenabled.12",".xlc":"application/vnd.ms-excel",".xlm":"application/vnd.ms-excel",".xls":"application/vnd.ms-excel",".xlsb":"application/vnd.ms-excel.sheet.binary.macroenabled.12",".xlsm":"application/vnd.ms-excel.sheet.macroenabled.12",".xlsx":"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",".xlt":"application/vnd.ms-excel",".xltm":"application/vnd.ms-excel.template.macroenabled.12",".xltx":"application/vnd.openxmlformats-officedocument.spreadsheetml.template",".xlw":"application/vnd.ms-excel",".xm":"audio/xm",".xml":"text/xml",".xns":"application/xcap-ns+xml",".xo":"application/vnd.olpc-sugar",".xop":"application/xop+xml",".xpi":"application/x-xpinstall",".xpl":"application/xproc+xml",".xpm":"image/x-xpixmap",".xpr":"application/vnd.is-xpr",".xps":"application/vnd.ms-xpsdocument",".xpw":"application/vnd.intercon.formnet",".xpx":"application/vnd.intercon.formnet",".xsd":"application/xml",".xslt":"application/xslt+xml",".xsm":"application/vnd.syncml+xml",".xspf":"application/xspf+xml",".xul":"application/vnd.mozilla.xul+xml",".xvm":"application/xv+xml",".xvml":"application/xv+xml",".xwd":"image/x-xwindowdump",".xyz":"chemical/x-xyz",".xz":"application/x-xz",".yaml":"text/yaml",".yang":"application/yang",".yin":"application/yin+xml",".yml":"text/yaml",".ymp":"text/x-suse-ymp",".z1":"application/x-zmachine",".z2":"application/x-zmachine",".z3":"application/x-zmachine",".z4":"application/x-zmachine",".z5":"application/x-zmachine",".z6":"application/x-zmachine",".z7":"application/x-zmachine",".z8":"application/x-zmachine",".zaz":"application/vnd.zzazz.deck+xml",".zip":"application/zip",".zir":"application/vnd.zul",".zirz":"application/vnd.zul",".zmm":"application/vnd.handheld-entertainment+xml"};class sn{#r;#s;data;constructor(e,t,n){let i;const o=e instanceof sn?e.name:`${e}`;if(void 0===t)i=e instanceof sn?Array.from(e.data,n):[];else if(Array.isArray(t))i=void 0===n?t:t.map(n);else if("number"==typeof t)i=0===t?[]:void 0!==n&&"function"!=typeof n?Array.from({length:t},(()=>n)):Array.from({length:t},n);else{if("function"!=typeof t?.[Symbol.iterator])throw new TypeError("Unknown rowCountOrData arg");i=Array.from(t,n)}this.#r=o,this.data=i}get name(){return this.#r}get isIntegerName(){return this.#s}setAt(e,t,n){!function(e,t,n){for(let i=e.length;i<t;++i)e[i]=n}(this.data,e-1,n),this.data[e]=t}push(e){this.data.push(e)}}function ln(e,t){const n=new Map;for(let i=0;i<e.length;++i)for(const[o,r]of Object.entries(e[i]))n.has(o)||n.set(o,new sn(o)),n.get(o).setAt(i,r,t);return Array.from(n.values())}const pn=/\s*(?:"([^"]*?)"\s*|([^,]*))/g;function cn(e,t=e=>e){const n=[];for(pn.lastIndex=0;;){const i=pn.exec(e);if(!i)throw new Error("parse failure");const o=void 0!==i[1]?t(i[1],!0):t(i[2].trim(),!1);if(n.push(o),pn.lastIndex===e.length)return n;if(","!=e[pn.lastIndex])throw new Error("parse failure");pn.lastIndex++}}const un=e=>!e.length;const dn=new j;function fn(){return dn.getStore()}function mn(e,t){return dn.run(e,t)}let hn=null;function yn(e){return`'${e.replaceAll("'","''")}'`}function vn(e,t){const n=new hn(":memory:"),i=yn(t),o=e.map((e=>yn(e.name)));n.exec("BEGIN TRANSACTION"),n.exec(`CREATE TABLE ${i} ( ${o.map((e=>`${e} TEXT`)).join(",")} )`);const r=n.prepare(`INSERT INTO ${i} VALUES ( ${e.map((e=>"?")).join(",")} ) `),a=Math.min(...e.map((e=>e.data.length)));for(let t=0;t<a;++t){const n=e.map((e=>e.data[t]));r.run(...n)}return n.exec("COMMIT TRANSACTION"),n}async function gn(e,t){if(!hn)try{hn=(await import("better-sqlite3")).default}catch(e){throw console.debug("import better-sqlite3 failed: ",e),new Error("database utilities need optional dependency `better-sqlite3` to be installed")}if("application/vnd.sqlite3"===e.type){const t=e.fullPath,n=new hn(t);return fn().registerCleanup((()=>{n.close()})),n}if("application/json"===e.type){const n=e.toJSON();if(!Array.isArray(n))throw new TypeError("JSON database must be an array");return vn(ln(n),t)}if("text/csv"===e.type)return vn(function(e){const t=e.split(/\s*$\s*/m).filter((e=>!un(e)));t.at(-1)===String.fromCharCode(0)&&t.pop();const n=cn(t[0]).map((e=>new sn(e)));for(let e=1;e<t.length;++e){const i=cn(t[e],void 0),o=i.length;if(o<n.length)throw new TypeError(`too few columns in row ${e}`);for(let t=0;t<n.length;++t)n[t].data[e-1]=i[t];for(let t=n.length;t<o;++t)if(!un(i[t]))throw new TypeError(`too many columns in row ${e}`)}for(let e=n.length-1;e>=0&&""===n[e].name&&n[e].data.every(un);e--)n.pop();return n}(e.toText()),t);throw new TypeError(`Cannot turn file (${e.type}) into database`)}class wn{#l;#p;#c;#u;#e;#d;#f;#m="";[te]="Buffer";constructor(e,t=".",r,a,s){"string"!=typeof t&&(t=t.fullPath),this.#u=n(t,e),this.#c=e,this.#p=i(this.#u),void 0!==r&&(this.#f=r),this.#m=a??function(e){return e=e.toLowerCase(),Object.hasOwn(an,e)?an[e]:""}(o(this.#p)),this.#l=s}static fromString(e,{cwd:t,stat:n,mimetype:i}){return new wn(e,t,n,i)}static#h(e){void 0===e.#f&&(e.#f=f(e.#u,{throwIfNoEntry:!1})??null)}getContentAsBuffer(){if(this.#d)return this.#d;if(this.#l)return this.#d=this.#l();const e=void 0===this.#f?f(this.#u,{throwIfNoEntry:!1}):this.#f;this.#d=m(this.#u);const t=f(this.#u,{throwIfNoEntry:!1});if(e.size!==t?.size||e.mtimeMS!==t?.mtimeNS)throw new Error(`File changed while we were reading it, for ${JSON.stringify(this.#c)}`);return void 0===this.#f&&(this.#f=e),this.#d}get type(){return this.#m}get size(){return this.#d?this.#d.byteLength:(wn.#h(this),this.#f?.size??NaN)}get name(){return this.#p}get webkitRelativePath(){return this.#c}get lastModified(){return wn.#h(this),this.#f?.mtimeMs??NaN}get fullPath(){return this.#u}static#y(e){return wn.#h(e),z(e.#f)}get isFile(){return wn.#y(this)===P}get isDir(){return wn.#y(this)===C}get isDirectory(){return wn.#y(this)===C}get filesystem(){throw new TypeError("Not implemented")}toFilename(){return this.#c}toURL(){return u(this.#u)}toBuffer(){return this.getContentAsBuffer()}async buffer(){return this.getContentAsBuffer()}toArrayBuffer(){const e=this.getContentAsBuffer();return 0!==e.byteOffset||e.length!==e.buffer.byteLength?e.buffer.slice(e.byteOffset,e.byteOffset+e.length):e.buffer}async arrayBuffer(){return this.toArrayBuffer()}toText(){return void 0!==this.#e?this.#e:this.#e=this.getContentAsBuffer().toString("utf8")}async text(){return this.toText()}async blob(){return new O([this.getContentAsBuffer()],{type:this.type})}file(){return new rn([this.getContentAsBuffer()],this.name,{type:this.type})}toJSON(){return JSON.parse(this.toText())}async json(){return JSON.parse(await this.text())}formData(){throw new TypeError("Method formData not impelemented")}async database(e="data"){return gn(this,e)}*toLines(){let e=0;const t=this.toText();for(;;){const n=t.indexOf("\n",e);if(-1===n)break;const i=n&&13===t.charCodeAt(n-1)?n-1:n;yield t.slice(e,i),e=n+1}e<t.length&&(yield t.slice(e,t.length))}async*lines(){yield*this.toLines()}setValueAsBufferVector(e){this.#d=void 0,this.#e=void 0,this.#f=void 0,function(e,t){const n=y(e,"w");let i=!0,o=!1;try{v(n,t)}catch(e){console.error(e),i=!1}try{g(n)}catch(e){i&&(i=!1,console.error(e))}if(!i){try{w(e),o=!0}catch(e){console.error(e)}throw new Error(o?"failed to write file":"failed to write file - it's probably corrupt")}}(this.#u,e)}setValueAsBuffer(e){this.#d=void 0,this.#e=void 0,this.#f=void 0,h(this.#u,e)}async fetchContentAsResponse(){const{type:e,lastModified:t}=this;return new Response(this.getContentAsBuffer(),{status:200,statusText:"OK",headers:new Headers([["Last-Modified",new Date(t).toGMTString()],...e?[["Content-Type",e]]:[]])})}slice(){throw new TypeError("Method slice not implemented")}stream(){throw new TypeError("Method stream not implemented")}}class xn{#p;#c;#u;#f;[te];constructor(e,t=".",o=null){t instanceof xn&&(t=t.fullPath),this.#u=n(t,e),this.#c=e,this.#p=i(e),this.#f=o||M(this.#u);const r=z(o);if(r!==C&&r!==D)throw new TypeError(`${JSON.stringify(e)} is not a directory`)}static fromString(e,{cwd:t}){return new xn(e,t)}static fromFullPath(e){return new xn(e)}get size(){return NaN}get type(){return""}get name(){return this.#p}get webkitRelativePath(){return this.#c}get fullPath(){return this.#u}get lastModified(){return this._stat(),this.#f?.mtimeMs??NaN}get isFile(){return z(this._stat())===P}get isDir(){return z(this._stat())===C}get isDirectory(){return z(this._stat())===C}get filesystem(){throw new TypeError("Not implemented")}get exists(){return z(this._stat())!==D}getFile(e){return new wn(e,this)}getDir(e){return new xn(e,this)}glob(e="*",t={}){return Cn(e,{dirs:!0,files:!0,...t,cwd:this.#u})}_stat(){return void 0!==this.#f?this.#f:this.#f=f(this.#c,{throwIfNoEntry:!1})??null}toFilename(){return this.#c}toDirname(){return this.#c}toURL(){return u(this.#c)}toString(){return this.#c}}function bn(e){return-1!==e.indexOf("*")}function En(e,t,i,o){if(""===e)throw new TypeError('Invalid filespec`""');if(bn(e)){const{dir:o,base:r}=l(e);let a;if(bn(o)){const e=l(o);if(bn(e.dir)||"**"!==e.base)throw new TypeError("Unsupported glob");if(!1===i)throw new TypeError("Cannot use a recursive glob with --no-recurse");i=!0,a=n(t,e.dir)||t}else i=!!i,a=n(t,o)||t;if(z(a)!==C)throw new TypeError(`${JSON.stringify(a)} is not a directory`);return{globDir:a,globs:[r],recurse:i,filespec:""}}{let r=z(e=n(t,e));return r===D?null:void 0!==i&&!i||r!==C?{globDir:"",globs:null,recurse:!1,filespec:e}:{globDir:e,globs:Array.isArray(o)?o:[o],recurse:!0,filespec:""}}}function Tn(e){return e.replaceAll(/[.+?|^$\[\](){}\\]/g,(e=>"\\"+e)).replaceAll("*",".*?")}function kn(e){if(-1!==e.indexOf("**"))throw new TypeError("Cannot convert a recursive glob to a RegExp");const t=function(e,t,n="",i="",o=""){return Array.isArray(e)?i+e.map(t).join(n)+o:t(e,0)}(e,Tn,"|","(?:",")");return new RegExp(`^${t}$`)}const Sn=Symbol.for("js-hell.private"),On="",jn="iterator",An="array";class Nn{#v;#g;#w=0;constructor(e){this.#v=e,this.#g=On}next(){let e=this.#g;if(e===On){const t=$n(this.#v);if(t===On)e=jn,_n(this.#v);else{if(t!==An)throw t===jn?new TypeError("Multiple iterators over content"):new TypeError("Unknown #state");e=An}this.#g=e}if(e===An){const e=Un(this.#v);return index<e.length?{value:e[index++],done:!1}:{value:void 0,done:!0}}if(e===jn)return Rn(this.#v).next();throw new TypeError("Unknown state")}[Symbol.iterator](){return this}}class In{#g=On;#x;#b;#E=0;get[te](){return"Array"}constructor(e){this.#x=e}toArray(){if(this.#g===On)Ln(this);else if(this.#g!==An)throw new TypeError("Cannot convert to an array");return this.#b}[Symbol.iterator](){return new Nn(this)}get length(){return this.toArray().length}at(e){return this.toArray().at(e)}slice(e,t){return this.toArray().slice(e,t)}values(){return this[Symbol.iterator]()}map(e){return new In(function*(e,t){for(const n of e)yield t(n)}(this[Symbol.iterator](),e))}static toSequenceState(e){return e.#g}static toUnderlyingArray(e){if(e.#g!==An)throw new TypeError("Not an array");return e.#b}static toUnderlyingIterator(e){if(e.#g!==jn)throw new TypeError("Not an iterator");return e.#x}static collapseToIterator(e){if(e.#g!==On)throw new TypeError("Not in a superposition");e.#g=jn}static collapseToArray(e){if(e.#g!==On)throw new TypeError("Not in a superposition");e.#b=Array.from(e.#x),e.#x=null,e.#g=An}}const{toSequenceState:$n,collapseToArray:Ln,collapseToIterator:_n,toUnderlyingIterator:Rn,toUnderlyingArray:Un}=In;function*Mn(t=[],{extensions:i,exclude:o,cwd:l,recurse:p,dirs:c=!1,files:u=!0}={}){const d="string"==typeof l?l:l.fullPath,f=[];for(const e of t)if(e instanceof wn||e instanceof xn)yield e;else{if("string"!=typeof e)throw new TypeError("Filespec must be a string or a File");f.push(e)}const m=function(e,t){return Array.isArray(e)?e.map(t):t(e,0)}(i,(e=>`*${e}`));for(const t of function*(e,{recurse:t,cwd:i=".",glob:o="*",exclude:l="",return:{dirs:p=!1}={}}={}){i=`${i}`;const c=Array.isArray(e)?e:[e];let u=[];const d=new Map;for(const e of c){const a=En(e,i,t,o);if(!a)continue;if(!a.globs){u.push(r(i,n(i,a.filespec)));continue}const s=a.globDir;if(d.has(s)){const e=d.get(s);if(e.recurse!==a.recurse)throw new TypeError("Confused recurse params");e.globs.push(...a.globs)}else d.set(s,{globs:a.globs,recurse:a.recurse})}u.length&&(yield*u);for(const[e,{recurse:t,globs:n}]of d.entries()){const o=kn(n),c=l?kn(l):o.source.startsWith("^\\.")?null:kn(".*"),u=[{dir:e,recurse:t}];for(let e=0;e<u.length;++e){const{dir:t,recurse:n}=u[e];n&&p&&e&&(yield r(i,t)+a);for(const e of x(t,{withFileTypes:!0})){if(c&&c.test(e.name))continue;const l=s(t,e.name);e.isDirectory()?!0===n?u.push({dir:l,recurse:n}):p&&(yield r(i,l)+a):o.test(e.name)&&(yield r(i,l))}}}}(f,{recurse:p,glob:m,exclude:o,cwd:d,return:{dirs:c,files:u}}))yield t.endsWith(e.sep)?new xn(t.slice(0,-1),l):new wn(t,l)}function Cn(e,t){return new In(Mn(e,t))}delete In.toSequenceState,delete In.collapseToIterator,delete In.collapseToArray,delete In.toUnderlyingIterator,delete In.toUnderlyingArray;class Pn{#T;#a;constructor(e){const t=Number(e),n=Number.isSafeInteger(t);this.#a=n?t:BigInt(e),this.#T=n}static fromString(e){return new Pn(e)}toSafeInteger(){if(!this.#T)throw new TypeError("Integer is too big to be safely encoded as a number");return this.#a}toNumber(){return Number(this.#a)}toBigInt(){return BigInt(this.#a)}get[te](){return"SafeInteger"}get[ie](){return this.#T?"number":"bigint"}[ne](){return this.#a}}const Dn=Symbol.for("js-hell.realiseTo");class zn{#e;constructor(e){this.#e=`${e}`}static fromString(e){return new zn(e)}toString(){return this.#e}toRegExp(){return kn(this.#e)}static[Dn]="String"}class Fn{#k;[te]="URL";constructor(e){this.#k=e}toURL(){return this.#k}async toBuffer(){return Buffer.from(await(await fetch(this.#k)).arrayBuffer())}}class Bn{acceptsFileTopic;constructor({name:e,aliases:t,super:n,subname:i,fromString:o,is:r,writeable:a=!1,literal:s=!1,enum:l=!1,variant:p=!1,acceptsFileTopic:c=!1,realiseStdioAs:u,realiseFileAs:d,createListFromStringsAndInstances:f,updateSubtype:m,updateVariant:h,casts:y={},...v}){if(Object.assign(this,{name:e,aliases:t,super:n,subname:i,fromString:o,is:r,literal:s,enum:l,writeable:a,realiseStdioAs:u,realiseFileAs:d,variant:p,acceptsFileTopic:c,createListFromStringsAndInstances:f,updateSubtype:m,updateVariant:h,casts:y}),0!==Object.entries(v).length)throw new TypeError("Illegal keys in type registration")}}const Jn=[new Bn({name:"Str",aliases:["String","Text","Name"],fromString:e=>e,is:()=>!0}),new Bn({name:"Int",aliases:"Integer",fromString:e=>Pn.fromString(e),is:e=>/^[-+]?\d+$/.test(e)}),new Bn({name:"Count",aliases:void 0,fromString:e=>Pn.fromString(e),is:e=>/^\d+$/.test(e)}),new Bn({name:"Date",aliases:void 0,fromString(e){const t=Date.parse(e);if(!Number.isFinite(t))throw new TypeError("Invalid date");return new Date(t)},casts:{Date_fromNumber:e=>new Date(e),Date_toMillisecondsSinceEpoch:e=>+e,Date_toNumber:e=>+e}}),new Bn({name:"File",fromString:(e,{cwd:t="."}={})=>new wn(e,t),is:e=>!0,realiseStdioAs:"Stream",writeable:!0,acceptsFileTopic:!0,createListFromStringsAndInstances(e,t){return Cn(e,{extensions:this.extensions??"",...t})},updateSubtype(e,t){e.extensions=`.${t.toLowerCase()}`},updateVariant(e,t){e.extensions=t.map((e=>e.extensions)).filter((e=>""!==e))}}),new Bn({name:"(Dir|File)",aliases:void 0,acceptsFileTopic:!0,fromString(e,{cwd:t="."}={}){const n=z(e);if(n===P)return new wn(e,{cwd:t});if(n===C)return new xn(e);if(n===D)throw new TypeError(`${JSON.stringify(e)} must exist`);throw new TypeError(`${JSON.stringify(e)} is a special file`)},createListFromStringsAndInstances:(e,t)=>Cn(e,{...t,extensions:"",dirs:!0,files:!0}),variant:!0}),new Bn({name:"Dir",fromString:(e,{cwd:t="."})=>new xn(e,t)}),new Bn({name:"DirName",aliases:"Dirname",fromString(e,{cwd:t="."}){const n=new xn(e,t);return n[te]="Filename",n.toFilename()}}),new Bn({name:"FileName",aliases:"Filename",fromString(e,{cwd:t="."}={}){const n=new wn(e,t);return n[te]="Filename",n}}),new Bn({name:"Url",fromString(e,{cwd:t}){let n;void 0!==t&&(n=u(`${t}`)+"/url_algorithm_deletes_this");return new URL(e,n)},casts:{ULR_toBuffer:async e=>Buffer.from(await(await fetch(e)).arrayBuffer()),URL_toResponse:async e=>fetch(e),URL_toArrayBuffer:async e=>(await fetch(e)).arrayBuffer(),URL_toText:async e=>(await fetch(e)).text(),URL_toJson:async e=>(await fetch(e)).json()}}),new Bn({name:"(File|Url)",acceptsFileTopic:!0,fromString(e,{cwd:t="."}={}){const n=/(?<=^[a-zA-Z]{2,}):/.test(e)?new Fn(e):wn.fromString(e,{cwd:t});return n[te]="Buffer",n},createListFromStringsAndInstances(e,t){throw new Type("Lists of url|file not implemented.")},variant:!0}),new Bn({name:"Json",fromString(e){try{return JSON.parse(e)}catch(t){throw console.log(e),t}},is(e){const t=e.trim();return!!/^[\[{"'0-9-]/.test(t)||("true"===t||"false"===t||"null"===t)},acceptsFileTopic:!0,realiseFileAs:"JSON"}),new Bn({name:"(File|Json)",fromString(e,{cwd:t="."}){if(!e.startsWith("{")&&!e.startsWith("[")){const n=new wn(e,t);return n[te]="JSON",n}try{return JSON.parse(e)}catch(t){throw console.log(e),t}},is:e=>!0,acceptsFileTopic:!0,realiseFileAs:"JSON"}),new Bn({name:"Scriptlet",fromString:(e,{cwd:t="."}={})=>jl(e,{cwd:t.toString()}),is:e=>!0,writeable:!1}),...Object.entries({Glob:zn}).map((([e,t])=>new Bn({name:e,fromString:t.fromString,writeable:"function"==typeof t.prototype.setValueAsBuffer})))],Vn=new Map(Jn.map((e=>[e.name,e]))),qn=function(){const e={};for(const t of Vn.values())if(void 0!==t.casts)for(const[n,i]of Object.entries(t.casts))e[n]=i;return e}();!function(){const e=[];for(const t of Vn.values()){t.aliases?Array.isArray(t.aliases)||(t.aliases=[t.aliases]):t.aliases=[];for(const n of t.aliases)e.push([n,t])}for(const[t,n]of e)Vn.set(t,n)}();var Wn=Object.freeze({__proto__:null,TypeRegistration:Bn,casts:qn,default:Vn,list:function(){const e=[];for(const{name:t,aliases:n=[]}of Jn)e.push([t,...n].join(" "));return e}});const Kn=Vn;function Gn(e){const t=e.charCodeAt(0);return t>=65&&t<=91}function Xn(e){const t=e;if(Vn.has(t))return Vn.get(t);const n=t.slice(1).search(/[A-Z]/)+1;if(n){const e=t.slice(n),i=function(e,t,n){if(!Vn.has(n))throw new TypeError(`No such supertype ${JSON.stringify(n)} for type ${JSON.stringify(e)}`);const i=Vn.get(n),o=Object.create(i);return o.super=i,o.subname=t,o.name=e,"function"==typeof i.updateSubtype&&i.updateSubtype(o,t),o}(t,t.slice(0,n),e);return Vn.set(t,i),i}throw new TypeError(`Unknown type ${t}`)}function Hn(e,t=""){if("true"===e||"false"===e)return e;if(Array.isArray(e))return new Bn({name:(n=t,""===n||Gn(n)?n:n.slice(0,1).toUpperCase()+n.slice(1)),is:t=>e.includes(t),fromString:e=>e,enum:!0});var n;if("string"!=typeof e)throw new TypeError(`Not a type name ${JSON.stringify(e)}`);if(!Gn(e))throw new TypeError(`Invalid type name ${JSON.stringify(e)}`);return Xn(e)}function Zn(e,t="literal"){return new nn(e,t)}function Yn(e,t){const n=Math.min(e.length,t.length);for(let i=0;i<n;++i){const n=e.charCodeAt(0)-t.charCodeAt(0);if(n)return n}return e.length-t.length}function Qn(e){if(!(e.length>1))throw new TypeError("Not a typename list");if(!e.every((e=>"string"==typeof e)))throw new TypeError(`Not type names ${JSON.stringify(t)}`);if(!e.every((e=>Gn(e))))throw new TypeError(`Invalid type names ${JSON.stringify(t)}`);e.sort(Yn);const n=`(${e.join("|")})`;if(Kn.has(n))return Kn.get(n);const i=e.map((e=>Xn(e))),o="object"==typeof i[0].super&&i[0].super?i[0].super:i[0];for(let e=1;e<i.length;++e){if(o!==("object"==typeof i[e].super&&i[e].super?i[e].super:i[e]))throw new Error("Invalid discriminated union (all types must have the same supertype")}const r=Object.create(o);return r.variant=!0,"function"==typeof o.updateVariant&&o.updateVariant(r,i),r}function ei(e,t,n,i,o=!0){const r=e(t);if("start"===r)return o?t.padEnd(n,i):t;if("end"===r)return t.padStart(n,i);if("none"===r)return t;throw new TypeError("Callback returned unknown alignment")}const ti=/^[-+]?(?:\d+(?:\.\d+)?|\.\d+)%?$/;function ni(e){return ti.test(e)?"end":"start"}function ii(e,{collapseWhitespace:t,escapeSeparator:n,separator:i,quotedSeparator:o}){let r=`${e}`;return t&&(r=r.trim().replaceAll(/\s+/g," ")),n&&(r=r.replaceAll(i,o)),r}function oi(e,{escapeSeparator:t=!0,separator:n="|",leading:i=!0,trailing:o=!1,padding:r=" ",collapseWhitespace:a=!0,eol:s="\n",ubhead:l=!1,columnHeadings:p=!0}={}){const c=`\\${n}`,u=[];let d=0;for(let i=0;i<e.length;++i){const{name:s,data:p,align:f="auto",padding:m=r,maxWidth:h=0}=e[i],y=ii(s,{collapseWhitespace:a,escapeSeparator:t,separator:n,quotedSeparator:c});let v=y.length;const g=l?[y]:[y,""];for(const e of p){let i=ii(e,{collapseWhitespace:a,escapeSeparator:t,separator:n,quotedSeparator:c});i.length>v&&(v=i.length),g.push(i)}l||(g[1]="-".repeat(o||i<e.length-1?v:g[0].length)),h>0&&v>h&&(v=h);const w=i<e.length-1||o?n:"",x=i<e.length-1||o;console.log("column",i,x);const b="function"==typeof f?(e,t,n)=>ei(f,e,t,n):"auto"===f?(e,t,n)=>ei(ni,e,t,n,x):"end"!==f?x?(e,t,n)=>e.padEnd(t,"."):e=>e:(e,t,n)=>e.padStart(t,n);for(let e=0;e<g.length;++e)g[e]=b(g[e],v,m)+w;if(l){const t=g[0];let n=`<u>${t.slice(0,t.length-w.length)}</u>`;0===i?n="<b>"+n:i===e.length-1&&(n+="</b>"),g[0]=n+w}const E=g.length;u.push(g),E>d&&(d=E)}let f="";const m=i?n:"";for(let e=p?0:2;e<d;++e){f+=m;for(let t=0;t<u.length;++t)f+=u[t][e]??" ".repeat(u[t][0].length);f+=s}return f}function ri(e,{eol:t}={}){const n=[];for(const t of e)n.push(JSON.stringify(t.name));let i=n.join(",")+t;for(let o=0;o<e[0].data.length;++o){n.length=0;for(const{data:t}of e)n.push(JSON.stringify(t[o]));i+=n.join(",")+t}return i}const ai="Str",si="Utf8",li=Symbol("toString"),pi="JSON",ci="Object",ui="Lines",di="Bytes",fi="Enum",mi="Table",hi="Columns",yi="nb-psv",vi="csv",{toString:gi}=Object.getPrototypeOf({});function wi(e){if("string"==typeof e)return ai;if(Buffer.isBuffer(e))return"Buffer";if("object"==typeof e){if(e instanceof ArrayBuffer)return"ArrayBuffer";if(e instanceof Uint8Array)return di;if(e.buffer instanceof ArrayBuffer)return"ArrayBuferView"}if(Array.isArray(e)){if(e.every((e=>"string"==typeof e)))return ui;if(e.every((e=>Number.isInteger(e)&&e>=0&&e<=255)))return di}return"object"==typeof e&&e?"function"==typeof e.toJSON?pi:"string"==typeof e[Symbol.toStringTag]?e[Symbol.toStringTag]:Array.isArray(e)||e.toString===gi?ci:li:pi}function xi(e,t){return e===mi&&t===ci||(e===ci&&(t===pi||t===di||t===ui)||(e===pi&&(t===ci||t===di||t===ui)||(t===di&&"Uint8Array"===e||(t!==si&&t!==li||(t=ai),e===t))))}const bi=new Map([["json",4],["json(4)",4],["json<4>",4],["JSON",4],["json0",0],["JSON0",0],["JSON<0>",0],["JSON(0)",0]]);function Ei({format:e}){return!bi.has(e)}const Ti=" ";function ki(e,t,n,i,o="uf8"){const r=function(e,t,n){switch(t){case li:case si:case ai:return`${e}`;case ui:return Array.isArray(e)?e.join(n):e;case ci:return N(e);case fi:return`{${e.join(", ")}}`;case mi:if(!Array.isArray(e))throw new TypeError("Must be a table, probably");return oi(ln(e),{leading:!1,separator:Ti,trailing:!1,padding:Ti,eol:n,collapseWhitespace:!1,escapeSeparator:!1});case hi:if(!Array.isArray(e))throw new TypeError("Must be a table, probably");return JSON.stringify(Object.fromEntries(ln(e).map((e=>[e.name,e.data]))));case"table-ub":if(!Array.isArray(e))throw new TypeError("Must be a table, probably");return oi(ln(e),{leading:!1,separator:Ti,trailing:!1,padding:Ti,eol:n,collapseWhitespace:!1,escapeSeparator:!1,ubhead:!0});case"psv":if(!Array.isArray(e))throw new TypeError("Must be a table, probably");return oi(ln(e));case yi:if(!Array.isArray(e))throw new TypeError("Must be a table, probably");return oi(ln(e),{padding:" "});case vi:return ri(ln(e),{eol:n})}}(e,t,i);if("string"==typeof r)return Buffer.from(r+n,o);switch(t){case"Buffer":return e;case di:return Buffer.from(e);case"ArrayBuffer":return Buffer.from(ArrayBuffer);case"Uint8Array":case"ArrayBufferView":return Buffer.from(e.buffer,e.byteOffset,e.byteLength)}if(bi.has(t))return Buffer.from(JSON.stringify(e,void 0,bi.get(t))+n,o);throw new TypeError(`Unknown format ${JSON.stringify(t)}`)}const Si=new Set(["hex","base64","base64url"]);function Oi(e,t,{format:n,EOL:i,textEncoding:o="utf8"},r=!1){if(void 0===e)throw new TypeError("module didn't provide expected output");const a=r?"":i;if(Si.has(n)){const r=ki(e,t,a,i,o);return Buffer.from(r.toString(n),"ascii")}return ki(e,n||t,a,i,o)}function ji(e,t=80,n=""){const i=e.map((e=>"string"==typeof e?e:`${e}`)),o=Math.max(...i.map((e=>e.length)))+1,r=n.length,a=[],s=(Math.max(Math.trunc((t-r)/o),1)-1)*o+r;let l=n;for(const e of i)l+=e,l.length<=s?l+=" ".repeat(o-e.length):(a.push(l),l=" ".repeat(r));return 0!==l.length&&a.push(l),a}const Ai="application/json",Ni="text/plain";function Ii({basetype:e="unknown",enum:t="unknown"}={},{format:n,mimetype:i},o){if("unknown"===t&&"function"!=typeof o&&(t=Array.isArray(o)?ae:le),(t===le||t===ae)&&bi.has(n))return Ai;if(void 0!==n){if(n===vi)return"text/csv";throw new TypeError("Unsupported format for pipe")}if(t===le)switch(e){case"JSON":return Ai;default:if("string"!=typeof o)break;case"string":case"String":case"Text":return"string"!=typeof i?Ni:i}}var $i=Object.freeze({__proto__:null,Buffer_fromScalarType:Oi,FORMAT_BYTES:di,FORMAT_COLUMNS:hi,FORMAT_CSV:vi,FORMAT_CUSTOM_TO_STRING:li,FORMAT_ENUMLIST:fi,FORMAT_JSON:pi,FORMAT_LINES:ui,FORMAT_NB_PSV:yi,FORMAT_OBJECT:ci,FORMAT_PSV:"psv",FORMAT_TABLE:mi,MIME_JSON:Ai,MIME_TEXT:Ni,formatRowsInColumns:ji,fromObjectArray:ln,inferFormat:wi,isFormatCompatible:xi,mimetype:Ii,outputComponentsAndCat:Ei,toCSV:ri,toMarkdown:oi});const Li="vector",_i="stream",Ri="buffer";function Ui(e,t){return"Buffer"===e&&t===ae?Li:t===se?_i:Ri}function Mi(e={}){let{basetype:t,enum:n}=e;const i=!!e;return i&&(t=function(e){if(!Vn.has(e))return e;const t=Vn.get(e);return t.super?t.super.name:t.name}(t),"DirName"!==t&&"FileName"!==t||(t="Str")),{typeAsserted:i,basetype:t,enumAs:n,method:Ui(t,n)}}function Ci(e,t="",n=""){const i=wi(e);if("Lines"===i&&n!==le)return t;if(!t)return i;if(i===li)return li;if(!xi(t,i))throw new TypeError(`Provided value appears to be ${JSON.stringify(i)} and not ${JSON.stringify(t)} as expected`);return t}function Pi(e,t,n,i,o){return"function"==typeof e.toBuffer_fromScalarType?e.toBuffer_fromScalarType(t,n,i,o):Oi(t,n,i,o)}class Di{typeAsserted;basetype;enumAs;formatParams;method;constructor(e,t){const{typeAsserted:n,basetype:i,enumAs:o,method:r}=Mi(e);Object.assign(this,{typeAsserted:n,basetype:i,enumAs:o,formatParams:t}),this.method=r}setReceiverValue(e,t){const{typeAsserted:n,basetype:i,enumAs:o,formatParams:r,method:a}=this;let s,l;if(a===Li){if("function"==typeof e.setValueAsBufferVector)return void e.setValueAsBufferVector(t)}else if(a===_i){if("function"==typeof e.setValueAsBufferStream)return void e.setValueAsBufferStream(function*(e,t,n,i){for(const o of t){const t=Ci(o,n);yield Pi(e,o,t,i)}}(e,t,i,r));if(!tn(t))throw new TypeError("Not a generator");t=Array.from(t),s=Ci(t,i,ae)}else{if(a!==Ri)throw new TypeError("Unknown method");if(void 0===t&&void 0===i)return;s=Ci(t,i,o),tn(t)&&(t=Array.from(t))}l=Array.isArray(t)&&(o===se||o===ae)&&Ei(r)?Buffer.concat(t.map(((n,i)=>Pi(e,n,s,r,i==t.length-1)))):Pi(e,t,s,r,!0),e.setValueAsBuffer(l)}}class zi{receiver;#S;constructor(e,t,n){this.receiver=e,this.#S=new Di(t,n)}getMethod(){return this.#S.method}setValue(e){this.#S.setReceiverValue(this.receiver,e)}}const Fi="range",Bi="property",Ji="method",Vi="global";class qi{[te]="Error";#m;#O;#j;#A;constructor(e,t="",n="",i=function(e){return e===Ji}(e)){this.#m=e,this.#O=t,this.#j=n,this.#A=i}getType(){return this.#m}get isException(){return this.#A}convertToException(){this.#A=!0}getMessage(){return this.#m===Vi?`Missing parameter ${JSON.stringify(this.#O)}`:this.#m===Bi?this.#j?`No property ${JSON.stringify(this.#O)} in ${JSON.stringify(this.#j)}`:`No property ${JSON.stringify(this.#O)}`:this.#m===Ji?`No method ${this.#O}() on instance of ${this.#j}`:this.#m===Fi?"Index out of range":"unindex"===this.#m?"Not an indexable property":"cast"===this.#m?`Cannot cast from ${JSON.stringify(this.#j)} to ${JSON.stringify(this.#O)}`:"Not an object (JSON.stringify(this.#type)}"}toError(){return this.#m===Vi?ReferenceError(this.getMessage()):TypeError(this.getMessage())}toBoolean(){return!1}static fromMissingGlobal(e){return new qi(Vi,e,"",!1)}static fromMissingProperty(e,t){return new qi(Bi,e,t,!1)}static fromMissingMethod(e,t){return new qi(Ji,e,t,!0)}static fromIndexOutOfRange(){return new qi(Fi,"","",!1)}static fromUnindex(){return new qi("unindex")}static fromMissingCast(e,t){return new qi("cast",t,e)}}class Wi{#N;constructor(e){this.#N=e}get(){return this.#N}}function Ki(e){return e instanceof Wi?e.get():e}function Gi(e){return e instanceof Promise?new Wi(e):e}function Xi(e){return e.map((e=>Ki(e)))}function Hi(e,t){return e instanceof Promise?e.then(t):t(e)}const Zi="Boolean";function Yi(e,t){if(!function(e,t){return"object"==typeof e?null!==e&&t in e:void 0!==e&&t in Object(e)}(e,t))return!1;const n=e[Sn];return"object"!=typeof n||!n||!n.has(t)}function Qi(e){const t={};for(let n=0;n+1<e.length;n+=2)t[e[n]]=e[n+1];return t}function eo(e,t){return Be(e,["locals",Be(e.locals,t)])}function to(e){return"Error"===e?.[te]&&"function"==typeof e.toError}function no(e){if("function"==typeof e)throw new TypeError("cannot realise a function");if("object"!=typeof e||!e)return!0;if(e instanceof Error)throw e;return!1}function io(e,t){if("function"==typeof e&&e[te]===e)return e;if(no(e))return e;const n=e[te]||e.constructor[te];if("string"==typeof n){if("Error"===n){if("function"==typeof e.toError)throw e.toError();throw new TypeError("Cannot realise as error")}const t=function(e,t){if(void 0===e)return t!==Zi&&qi.fromMissingCast("cast","Undefined",cast);if(null===e||to(e))return t!==Zi&&e;const n=e[`to${t}`];return"function"!=typeof n?qi.fromMissingCast(e.constructor.name,t):Reflect.apply(n,e,[])}(e,n);if("String"===n&&"string"!=typeof t)throw new TypeError("Cast failed!");if(no(t))return t;if(to(t))return t;if(void 0===(t[te]||t.constructor[te]))return t;throw new TypeError("Realised result needs to be realised itself")}if("Integer"===e.constructor.name)return e.toSafeInteger();if("LazyFileSync"===e.constructor.name)return e.toFile();if(en(e))return function*(e){for(const t of e)yield io(t)}(e);if(Array.isArray(e)){const t=e;for(let e=0;e<t.length;++e){const n=io(t[e]);n!==t[e]&&(t[e]=n)}return t}{const t=e;for(const e in t){if(!Object.hasOwn(t,e))continue;const n=io(t[e]);n!==t[e]&&(t[e]=n)}return t}}function oo(e,t){return to(e)?e:io(e)}function ro(e,t,n=""){if(void 0===t)throw new TypeError("Shouldn't be slicing with undefined");if(to(e))return e.convertToException(),e;if(void 0===e||"object"==typeof e&&null===e)return qi.fromUnindex();if(en(e)){if(t===Symbol.iterator)return e;throw new TypeError("Probably not supported")}if("string"==typeof t){const i=t;return Yi(e,i)?Gi(e[i]):qi.fromMissingProperty(i,n)}if("function"==typeof t)throw new TypeError("Cannot index with function");if("number"==typeof t)return function(e){return!!Array.isArray(e)||!("object"!=typeof e||!e||"number"!=typeof e.length||"function"!=typeof e.at)}(e)?t>=e.length||t<-e.length?qi.fromIndexOutOfRange():Gi(e.at(t)):qi.fromMissingProperty(t,n);if("object"==typeof t){if(!function(e){return!!Array.isArray(e)||!("object"!=typeof e||!e||"number"!=typeof e.length||"function"!=typeof e.slice)}(e))throw new TypeError("Not a sliceable type");if(void 0!==t.start){if(t.start<0||t.start>=e.length||t.end<0||t.end>=e.length||t.end<t.start)throw new TypeError("Subscript out of range")}else if(void 0!==t.end)throw new TypeError("Cannot have definite subscript with indefinite end");return e.slice(t.start,t.end)}throw"symbol"==typeof t?new TypeError("Symbol properties not supported"):new TypeError("Unsupported subscripts")}function ao(e,t){const{globals:n,imports:i,locals:o}=t;console.assert(e.type===ue||e.type===he,"value invocation on node type %s",e.type);const{name:r}=e,a=e.type===ue?e.scope:e.import?Ae:je;if(a!==je&&void 0!==e.defaultValue)throw new Error(U`Failed invariant: non-global binding ${e.name} has a default value`);if(a===Ne){if(Yi(o,r))return o[r];throw new Error(U`Binding ${e.name} flagged as LOCAL is not in the locals`)}if(a===Ae){if(i.has(r))return i.get(r);throw new Error(U`Binding ${e.name} flagged as an IMPORT is not in the imports`)}if(a!==je)throw new Error(U`Binding ${e.name} has unknown scope ${a}`);return n.has(r)?n.get(r):void 0!==e.defaultValue?yo(e.defaultValue,t):qi.fromMissingGlobal(r)}const so={};function lo(e,t,n,i,o){const r=go(i,o,!0);return Hi(e,(e=>Hi(n,(n=>Hi(r,(i=>function(e,t,n,i){try{return to(i)?i:to(n)?n:to(e)?e:Gi(n===so?Reflect.construct(e,i):Reflect.apply(e,n,i))}catch(e){const n=new Error(`${t}() threw an exception`,{cause:e});throw n.name="ScriptletError",n}}(e,t,n,i)))))))}function po(e,t){if("function"==typeof e){const n=e.name;return""!==n?`%${n}%.${t}(...)`:""}const n=function(e){if(en(e))return"Iterator";const t=e?.constructor?.name;return"string"==typeof t?t:""}(e);return""!==n?`%${n}.prototype%.${t}(...)`:""}function co(e,t,n){if(to(e))return e.convertToException(),e;const i=function(e,t,n){if("string"==typeof t){if("object"==typeof n){const i=po(e,t);if(""!==i&&n.has(i))return n.get(i)}}else if("symbol"!=typeof t)throw new TypeError("`methodName` must be a symbol or a string");return Yi(e,t)?e[t]:qi.fromMissingMethod(t,e.constructor.name)}(e,t,n);if("function"!=typeof i)return qi.fromMissingMethod(t,e.constructor.name);if(("function"==typeof e||e instanceof Function)&&i===Yi(Function.prototype,t))throw new TypeError("Cannot invoke function methods");return i}function uo(e,t,n,i){const o=xo(t,eo(e,["%",n]));if(!0!==o){if(!1===o)throw new TypeError(`failed type assertion: expr is not type ${qe(i)}`);return console.warn("warning: unchecked type assertion %s",qe(i)),!1}return!0}function fo(e,t,n,i){return Hi(t,(t=>to(t)?t:Hi(xo(n,e),(e=>to(e)?e:i(t,e)))))}function mo(e,t){if("boolean"==typeof e)return!0;if(to(e))return!1;throw new TypeError(`Condition to \`${t}\` must be a boolean.`)}function ho(e){return"object"==typeof e&&e?"function"!=typeof e[ne]?e:e[ne]():e}function yo(e,t){if(e.type===ve)return e.value;if(e.type===ue)return ao(e,t);if(e.type===ge){const n=yo(e.object,t);if(e.op===ke){const t=function(e){if(e.type===ge&&e.op===ke)return void 0!==e.property?e.property:e;throw new TypeError("Cannot get subscript")}(e);return Hi(n,(e=>ro(e,t,"")))}if(e.op===Se)return Hi(n,(e=>Ki(e)));if(e.op===Oe)return Hi(n,(e=>{if(to(e))return!1===e.isException?"undefined":e;if(null===e)return"null";const t=typeof e;return"object"!==t?t:"string"==typeof e[ie]?e[ie]:t}));if("!"===e.op)return Hi(n,(e=>mo(e,"!")?!e:e));throw new TypeError("Unknown unary operation")}if(e.type===he){const n=ao(e,t);if(to(n))return n;if("function"!=typeof n)throw new TypeError("JSON.stringify( f ) is not callable");return lo(n,e.name,e.new?so:void 0,e.args,t)}if(e.type===ye){const n=e.name,i=xo(e.object,t);return lo(Hi(i,(e=>co(e,n,t.globals))),n,e.new?so:i,e.args,t)}if(e.type===we){const n=yo(e.lhs,t);if(e.op===be)return Hi(n,(n=>to(n)?yo(e.rhs,t):n));if("."===e.op){const i=n;if(to(i))return i;const o=i,r=yo(e.rhs,t);return to(r)?r:Hi(o,(e=>e[r]))}if(e.op===Ee)return Hi(n,(n=>{if(to(n))return n;if(e.exprType.enum===le)return uo(t,e.rhs,n,e.exprType),n;if(e.exprType.enum===ae)return n.every((n=>uo(t,e.rhs,n,e.exprType))),n;if(e.exprType.enum===se)return function*(e,t,n,i){for(const o of n){const r=uo(e,t,o,i);if(yield o,!r){yield*n;break}}}(t,e.rhs,n,e.exprType);if(e.exprType.enum===pe)return async function*(e,t,n,i){for await(const o of n){const n=uo(e,t,o,i);if(yield o,!n){yield*iterator;break}}}(t,e.rhs,n,e.exprType);throw new Error(U`Internal error (unknown enum type ${e.exprType.enum})`)}));if("|>"===e.op)return to(n)?n:Hi(n,(n=>xo(e.rhs,eo(t,["%",n,"%"+e.pipeIndex,n]))));if(e.op===Te)return fo(t,n,e.rhs,((e,t)=>e instanceof t));if("==="===e.op)return fo(t,n,e.rhs,((e,t)=>ho(e)===ho(t)));if("!=="===e.op)return fo(t,n,e.rhs,((e,t)=>ho(e)!==ho(t)));if(","===e.op)return fo(t,n,e.rhs,((e,t)=>t));throw new TypeError("Unknown binary operation")}if(e.type===xe)return Hi(yo(e.condition,t),(n=>mo(n,"?:")?yo(n?e.true:e.false,t):n));if("->"===e.type)return Hi(yo(e.sourceValue,t),(n=>{const i=ao(e.destIdentifier,t);return Hi(new zi(i,e.typeAssertion,{}).setValue(n),(e=>{}))}));throw new TypeError(`Unknown node type ${JSON.stringify(e.type)}`)}let vo=!1;function go(e,t,n=!1){const i=[];let o=!1;vo||(vo=!0);for(const r of e){let e;if(r.type===de)e=go(r.value,t);else if(r.type===fe)e=wo(r.value,t);else if(r.type===ge&&"..."===r.op){const n=io(yo(r.object,t),t.globals);if(!to(n)){if(en(n))i.push(...n);else{if("function"!=typeof n[Symbol.iterator])throw new TypeError("expected iterable for rest arg");{const e=n[Symbol.iterator]();i.push(...e)}}continue}e=n}else{if(r.type===me){if(!n)throw new Error("Callbacks are only allowed in argument lists");const{expr:e,freeVariableNames:o,async:a}=r,s=(...n)=>{const i=[ce,a];for(let e=0;e<o.length;++e)i.push(o[e],e<n.length?n[e]:void 0);const r=eo(t,i),s=xo(e,r);if(s instanceof Promise)return s.then((e=>io(e,t.globals)));{const e=io(s,t.globals);return a?Promise.resolve(e):e}};i.push(s);continue}{const n=yo(r,t);e=to(n)?n:io(n,t.globals)}}if(to(e))return e;!o&&e instanceof Promise&&(o=!0),i.push(e)}return o?Promise.all(i).then((e=>Xi(e))):Xi(i)}function wo(e,t){const n=[];let i=!1;for(const[o,r]of e){let e;if(n.push(o),r.type===de)e=go(r.value,t);else if(r.type===fe)e=wo(r.value,t);else{e=Hi(yo(r,t),(e=>oo(e,t.globals)))}if(to(e))return e;!i&&e instanceof Promise&&(i=!0),n.push(e)}return i?Promise.all(n).then((e=>Qi(Xi(e)))):Qi(Xi(n))}function xo(e,t){return e.type===de?go(e.value,t):e.type===fe?wo(e.value,t):yo(e,t)}function bo(e,t,n=void 0,i=!0,o){if(Array.isArray(e.args))throw new TypeError("Non-expression invocation no longer supported");if("object"!=typeof n&&void 0!==n)throw console.log(n),new TypeError("Expected object for formatterParams");const r=Be(null,[ce,!0]),a={globals:t,imports:void 0===o?t:new Map(Object.entries(o)),locals:r},s=Hi(xo(e.args,a),(e=>oo(e)));return i?Hi(s,(e=>{if(!to(e))return e;throw e.toError()})):s}function Eo(e,t){for(const n of e)if(!t(n))return!1;return!0}class To{#I;#$;#L;#_;#R;globals;inlineOptions;get name(){return this.#$}get args(){return this.#I}get cast(){return this.#_}get void(){return this.#L||void 0!==(e=this.#_)&&Jt.includes(e.basetype);var e}get astNode(){return this.#I}get imports(){return this.#$}constructor({importReferences:e,globalReferences:t,imports:n,args:i,typeAssertion:o,inlineOptions:r,isVoid:a}){this.#I=i,this.#$=n,this.#_=o,this.#R=t,this.#L=a,this.globals=new Set(t.keys()),this.inlineOptions=r}static from(e,{expr:t=!1}={}){const n="string"==typeof e?new ee(e):e;return new To(Ht(n,t?qt:Kt))}static fromEmbeddedExpr(e){const t="string"==typeof e?new ee(e):e;return new To(Ht(t,Wt))}static fromTemplateContents(e){const t="string"==typeof e?new ee(e):e;return new To(Ht(t,Gt))}static fromTemplateTail(e){const t="string"==typeof e?new ee(e):e;return new To(Ht(t,Xt))}get build(){throw new Error("Not implemented")}exec(e,t,{throwError:n=!0,legacyBrk:i=!1}={}){return bo(this,e,void 0,n,t)}static#U(e,t){if(!e.#R.has(t))return null;const n=e.#R.get(t);if(1!==n.size)return null;const i=n.values().next().value;return void 0===i.defaultValue||i.defaultValue.type!==ve?null:i.defaultValue}hasDefault(e){return null!==To.#U(this,e)}getDefault(e){return To.#U(this,e)?.value}*globalsWithLiteralDefaults(){for(const[e,t]of this.#R.entries()){if(console.assert(0!==t.size,"expected non-zero references to global %s",e),!Eo(t.values(),(e=>void 0!==e.defaultValue&&e.defaultValue.type===ve)))continue;const n=t.values(),i=n.next().value.defaultValue.value;Eo(n,(e=>e.defaultValue.value===i))&&(yield[e,i])}}options(){}hasGlobal(e){return this.#R.has(e)}getGlobal(e){if(!this.#R.has(e))return null;const t=new ko;for(const n of this.#R.get(e))n.parent&&n.parent.type===ye?t.methods.add(n.parent.name):t.othersCount++;return t}remapGlobals(e,t){(function(e,t,n){if(!e.has(t)||t===n)return!1;const i=e.get(t);for(const e of i){if(e.type!==ue)throw new TypeError("Illegal reference");if(e.name!==t)throw new TypeError("Mimsatched names");e.name=n}if(e.has(n)){const t=e.get(n);for(const e of i)t.add(e)}else e.set(n,i);return e.delete(t),!0})(this.#R,e,t)&&(this.globals=new Set(this.#R.keys()),this.inlineOptions=Vt(this.#R))}isLiteral(){return $e(this.#I)}toLiteralValue(){if(!$e(this.#I))throw new Error("Not a literal");return this.#I.value}}class ko{methods=new Set;othersCount=0}const So="$n",Oo="=",jo="--$",Ao=";",No="${}",Io="=${}",$o=new RegExp(`-${F.source}`,"y"),Lo=/&&?|\|\|?|>>?|<<?|;|(?<=^|\s)\d>{1,2}/y,_o=/\$\{/y,Ro="",Uo="=",Mo=!1,Co=!0,Po="expr",Do=Symbol("-");function zo(e,t=false,n=!0){return e===Do.description&&n?Do:e}function Fo(e,t,n,i,o=!1){return n===Po?{type:e?Io:No,value:t,info:Ro}:{type:e?Oo:So,value:zo(t,n,i),info:n===Co?'"':Ro}}function Bo(e){if(e.startsWith('"')||e.startsWith("'"))return e.indexOf(e.charAt(0),1)===e.length-1}function Jo(e,t,n,i){if(n!==Mo)throw new Error("fromArgv options must always be unquoted");if(Bo(t))t=t.slice(1,-1),n=Co;else if(t.startsWith("${")&&t.endsWith("}"))i&&(t=t.slice(2,-1),n=Po);else if(t.startsWith("`")&&t.endsWith("`")){const e=new ee(t.slice(1)),i=To.fromTemplateTail(e);if(!e.atEof())throw e.error("expected argument end");i.isLiteral()?(t=i.toLiteralValue(),n=Co):n=Po}return Fo(e,t,n,i)}function*Vo(e){let t=!0;const n=new ee(e,{autoTrim:!1,trimStart:!1});for(let e=!0;;){const i=n.trimStart();if(n.atEof())break;const o=n.match(Lo);if(o){yield{type:Ao,value:o,info:Ro},t=!0,e=!0;continue}if(!i&&!e)throw n.error("expected whitespace");e=!1;let r,a,s=Mo;if(t&&(a=n.match($o))){if("--"===a){t=!1;continue}if(a===Do.description){yield{type:r===Oo?Oo:So,value:Do,info:Ro};continue}{const e=n.match("=");if(yield{type:jo,value:a,info:e?Uo:Ro},!e)continue;r=Oo}}else r=So;if(n.match(_o)){n.trimStart();const e=n.pos;if(To.fromEmbeddedExpr(n),a=n.slice(e).trimEnd(),!n.match("}"))throw n.error("expected '}'");s=Po}else if(n.match("`")){const e=n.pos-1,t=To.fromTemplateTail(n);t.isLiteral()?(a=t.toLiteralValue(),s=Co):(a=n.slice(e),s=Po)}else if(({value:a,quoted:s}=X(n)),s)Bo(a)&&(a=a.slice(1,-1));else if(""===a){if(!n.startsWith(/\s/y))throw n.error("Illegal character - must be quoted");if(r===So)throw n.error("Expected argument to option")}yield Fo(r===Oo,a,s,t)}}function qo(e){const t=e.indexOf("=");return-1===t?[e]:[e.slice(0,t),e.slice(t+1)]}function*Wo(e){let t=!0;for(const o of e)if(t&&o.startsWith("-"))if("--"===o)t=!1;else if(o===Do.description)yield{type:So,value:Do,info:Ro};else if(o.startsWith("--")){const[e,n]=qo(o);void 0===n?yield{type:jo,value:e,info:Ro}:(yield{type:jo,value:e,info:Uo},yield Jo(!0,n,!1,t))}else yield{type:jo,value:o,info:Ro};else i=o,(n=Lo).lastIndex=0,n.test(i)&&n.lastIndex===i.length?yield{type:Ao,value:o,info:Ro}:yield Jo(!1,o,!1,t);var n,i}function Ko(e,t=0){if("string"==typeof e)return Vo(e);if(!Array.isArray(e))throw new TypeError("Invalid argument (argument must be an array or a string)");let n=e[Symbol.iterator]();if(t)if("function"==typeof n.drop)n=n.drop(t);else for(;t;)n.next();return Wo(n)}var Go=Object.freeze({__proto__:null,ARG_NAME:jo,ARG_NAMED_EXPR:Io,ARG_NAMED_VALUE:Oo,ARG_OPERATOR:Ao,ARG_POSITIONAL_EXPR:No,ARG_POSITIONAL_VALUE:So,FILE_TOPIC:Do,INFO_HASVALUE:Uo,INFO_NONE:Ro,INFO_QUOTED:'"',RE_EXPR_BODY:/.*?(?=\s|\})/y,RE_EXPR_START:_o,RE_OPERATOR:Lo,RE_OPTION:$o,default:Ko,parseArray:Wo,parseText:Vo,shfy:function(e){if("string"!=typeof e)throw new TypeError("Source must be a string");return function(e){const t=[];let n,i=!1;for(const{type:o,value:r}of e){if(void 0!==n){if(o===Oo){t.push(`${n}=${r}`),n=void 0;continue}t.push(n),n=void 0}if(o===So)r===Do?t.push(Do.description):(!i&&r.startsWith("-")&&(t.push("--"),i=!0),t.push(r));else if(o===jo){if(i)throw new Error("Probably can't represent args as an array");n=r}else{if(o!==Ao)throw new TypeError("Unexpected arg type");i=!1,void 0!==n&&t.push(n),n=void 0,t.push(r)}}return void 0!==n&&t.push(n),t}(Vo(e))}});const Xo="none";class Ho{key;arg;impliedValue;constructor({key:e,arg:t,impliedValue:n}){Object.assign(this,{key:e,arg:t,impliedValue:n})}static fromOption({key:e,typename:t}){return new Ho({key:e,arg:"true"===t||"false"===t?Xo:"required",impliedValue:"true"===t||"false"!==t&&void 0})}}const Zo="option",Yo=Symbol("lookup"),Qo="cli";function*er(e,t,n=0){let i="",o=Zo,r=0,a=!0;const s=t[Symbol.iterator]();try{for(const{type:t,value:p,info:c}of function*(e){const t=e[Symbol.iterator]();for(;;){const{done:e,value:n}=t.next();if(e)return n;yield n}}(s))if(o===Zo)if(t===jo||t===Ao)e:for(let{optionName:t,optionNameTail:n}=(l=p,"-"===l[0]&&"-"!==l[1]?{optionName:l.slice(0,2),optionNameTail:l.slice(2)}:{optionName:l,optionNameTail:""});;){if(!e.has(t))throw new TypeError(`Unknown option ${JSON.stringify(t)}`);const{key:r,arg:a,impliedValue:s}=e.get(t);if(a===Xo){if(yield{key:r,value:s,isInstantiated:!0,optionName:t,source:Qo},n){t="-"+n[0],n=n.slice(1);continue e}}else n?yield{key:r,value:n!==Do.description?n:Do,isInstantiated:!1,optionName:t,source:Qo}:o="value";i=t;break e}else{if(t===Oo||t===Io)throw new TypeError(`Cannot set a value for ${i}`);if(t===So)yield{key:"",value:p,isInstantiated:!1,optionName:"",source:Qo};else{if(t!==No)throw new TypeError("Unsupported argType");yield{key:"",value:p,isInstantiated:Yo,optionName:"",source:Qo}}if(++r,r===n)return yield{key:"",value:s,isInstantiated:!0,optionName:"...",source:Qo},void(a=!1)}else{const n=i,{key:r,arg:a}=e.get(n);if(a==Xo)throw new Error("Internal error - should be unreachable (in STATE_EXPECTING_NAMED_VALUE state for ARGVALUE_NONE arg )");if(t!==Oo&&t!==So&&t!==Io&&t!==No)throw new TypeError(`Need value for ${n}`);yield{key:r,value:p,isInstantiated:(t===Io||t===No)&&Yo,optionName:n,source:Qo},o=Zo}if(o!==Zo)throw new TypeError(`Need value for ${i}`)}finally{a&&t.return?.()}var l}function tr(e,t,n,{cwd:i}){if("function"==typeof e.is&&!e.is(t))throw"number"==typeof n&&(n="$"+n),e.enum||e.literal?new TypeError(`Invalid value ${JSON.stringify(t)} for ${n}`):new TypeError(`Cannot convert ${JSON.stringify(t)} to ${e.name} for ${n}`);return e.fromString(t,{cwd:i})}function nr(e,t,n,i,{recurse:o,cwd:r,exclude:a}){if("function"==typeof e.createListFromStringsAndInstances)return e.createListFromStringsAndInstances(t,{recurse:o,cwd:r,exclude:a});const s=[];for(let i=0;i<t.length;++i)"string"==typeof t[i]?s.push(tr(e,t[i],`${n}[i]`,{cwd:r})):s.push(t[i]);return s}class ir{#M;constructor(e={}){this.#M=e}get(e){return Object.hasOwn(this.#M,e)?this.#M[e]:void 0}has(e){return Object.hasOwn(this.#M,e)}}class or{present=new Set;rawDictionary;#C;#P;#D;#z;#F=[];#B=!1;setFileTopic(e){if(void 0!==this.#P)throw new TypeError("Cannot overwrite file topic.");this.#P=e}constructor(e,t={}){this.#D=e,this.rawDictionary={$:void 0,$LEXICAL_ENVIRONMENT$:void 0,cwd:void 0,...t}}has(e){return this.present.has(e)}#J(e,{value:t,get:n}){if(this.present.add(e),"function"==typeof n){if(void 0!==t)throw new Error("Cannot specifier accessor and value");Object.defineProperty(this.rawDictionary,e,{get:n,configurable:!0,enumerable:!0})}else{if(void 0!==n)throw new Error("Getter must be undefined or a function");Object.defineProperty(this.rawDictionary,e,{value:t,configurable:!0,writable:!0,enumerable:!0})}}_useFileTopic(e,t){if(void 0!==this.#C)throw new Error(U`the file topic (\`-\`) can only be used ONCE in the command line (already set via ${this.#C}) while setting ${e}`);if(void 0===this.#P)throw new Error(U`the file topic (\`-\`) not available`);return this.#C=e,void 0!==t&&(this.#P[te]=t),this.#P}appendKeyValue2(e,t,n,i,o){if("$"===e){if(void 0!==this.#z)throw new Error("Invariant: '$' can only be set onced");if(!0!==i||void 0!==n||"$"!==o)throw new Error("Internal error (incorrect params for '$')");return void(this.#z=t)}const{typename:r,type:a,recurs:s}=this.#D.getNamedOptionFromKey(e);if(console.assert(s===i,"list argument should be a recurring one."),t===Do)a.acceptsFileTopic?(t=this._useFileTopic(e,a.realiseFileAs),n=!0):(t="-",n=!1);else if(s){const n=t.indexOf(Do);-1!==n&&(a.acceptsFileTopic?t[n]=this._useFileTopic(e,a.realiseFileAs):t[n]="-")}if(console.assert(this.#D.hasKey(e),U`Invariant: key ${e} should exist`),console.assert(!this.present.has(e),U`Invariant: key ${e} passed multple times`),console.assert(!!i==!!s,U`Invariant: key ${e}: isList (${!!i}) should match recurs (${!!s})`),i){if(n===Yo)throw new Error("Expressions are not currently available in lists");if(t.length)if("boolean"===r){if(!n)throw new Error("Internal error (boolean options should always be instantiated )");this.#J(e,{value:t.length})}else{if(n){if(!t.some((e=>e===Yo)))throw new Error("Expressions are not currently available in lists");if(!t.every((e=>"string"!=typeof e)))throw new Error("Instantiated values cannot be strings")}this.#J(e,{value:t})}}else if(n===Yo){const n=(l=t,To.from(l,{expr:!0}));this.#F.push({key:e,type:a,optionName:o,optionValue:t,expr:n,index:void 0}),this.#J(e,{get:()=>{throw new Error("Not implemented!")}})}else{if("boolean"===r&&!n)throw new Error("Internal error (boolean options should always be instantiated )");const i=n?t:tr(a,t,o,this.rawDictionary);this.#J(e,{value:i})}var l}appendParsedOption({key:e,value:t,isInstantiated:n,optionName:i=e,list:o=!1}){this.appendKeyValue2(e,t,n,o,i)}appendParsedOptions(e){for(const t of e)this.appendParsedOption(t)}instantiateListOption(e,t=!1){const{optionName:n,typename:i,type:o,recurs:r,defaultValue:a}=this.#D.getNamedOptionFromKey(e);if(!r)throw new TypeError("Not a list type");if("boolean"===i&&!1===a)throw new Error("Internal error (recurring booleans cannot be false)");if(this.present.has(e))"boolean"!==i&&(this.rawDictionary[e]=nr(o,this.rawDictionary[e],n,0,this.rawDictionary));else{0;Object.hasOwn(this.rawDictionary,e)||t||(this.rawDictionary[e]="boolean"===i?0:nr(o,[],n,0,this.rawDictionary))}}_createLexicalEnvironment(){const{rawDictionary:e}=this;if(void 0!==e.$LEXICAL_ENVIRONMENT$)throw new TypeError("About to overwrite $LEXICAL_ENVIRONMENT$");e.$LEXICAL_ENVIRONMENT$=new ir(e)}_instantiateAndDefaultLists(){for(const{key:e,recurs:t}of this.#D.enumAllOptions())t&&this.instantiateListOption(e,!1);for(const{key:e,recurs:t}of this.#D.enumAllPositionals())t&&this.instantiateListOption(e,!0)}_instantiateExpressions(){const{rawDictionary:e}=this;for(const{key:t,type:n,optionName:i,optionValue:o,expr:r,index:a}of this.#F){const o=r.exec(new ir(e),{}),s="string"==typeof o?tr(n,o,i,e):o;if(void 0===a)Object.defineProperty(e,t,{value:s});else{if(!Number.isSafeInteger(a))throw new TypeError("Invalid index");const n=e[t];if(!Array.isArray(n))throw new Error("Attempt to instantiate element of a non list");if(a<0||a>=n.length)throw new RangeError("Index out of range");n[a]=o}}}finalise(){if(this.#B)throw new Error("Can only finalise() once!");const{rawDictionary:e}=this;this._createLexicalEnvironment(),this._instantiateAndDefaultLists(),this._instantiateExpressions();const t=[];for(const n of this.#z??[])t.push(e[n]);e.$=t;for(const[t,n]of this.#D.getAliases())Object.hasOwn(e,n)&&(e[t]=e[n]);return Object.defineProperty(this.rawDictionary,re,{enumerable:!1,value:new Set(this.present)}),this.#B=!0,this.rawDictionary}usesFileTopic(){return void 0!==this.#C}}function rr(e){return e.replaceAll(/-[a-z]/g,(e=>e.charAt(1).toUpperCase()))}function ar(e){return e.replaceAll(/(?:(?<=[a-z])[A-Z]|(?<=[A-Z])[A-Z](?=[a-z]))/g,(e=>"_"+e)).toUpperCase()}const sr="--",lr="$n",pr="$n#",cr="($n)",ur="'",dr="...",fr="(')",mr="(...)",hr="true",yr="false";function vr(e,t,n,i){return{type:sr,option:t,key:e,value:n,shortAlias:i}}function gr(e,t){return{type:lr,value:e,identifier:t}}function wr(e,t,n){return{type:pr,value:e,suffix:t,identifier:n}}const xr="only one optional block is allowed at any level as otherwise the sequence would be ambiguous",br="Must be separated by whitespace",Er="suffixed type not allowed here",Tr=/^[a-z][0-9a-z]*(?:[_-][0-9a-z]+)*$/,kr=/^[A-Z]+(?:_[A-Z]+)?(?:\d+)?$/,Sr=/^--[a-z]+(?:-[a-z]+)*$/,Or=/^-[a-zA-Z0-9]$/,jr=/[-_A-Za-z0-9]+/y,Ar=/\d+$/g;function Nr(e,t){throw e.error(`\`...\` not allowed (${t})`,e.lastIndex)}function Ir(e,t){throw e.error(`unexpected \`[\` (${t})`,e.lastIndex)}function $r(e,t){throw e.error(t,e.lastIndex)}function Lr(e){return e.charAt(0)+e.slice(1).toLowerCase().replace(/_[a-z]/,(e=>e.charAt(1).toUpperCase()))}const _r="literal",Rr="type",Ur="type#",Mr="type...",Cr="option",Pr="punctuator",Dr="(--)";function zr(e,t=!1){t&&e.trimStart();const n=e.fence(),i=e.match(jr,!1);if(i){const t=function(e,t){if(/^[A-Z]/.test(e)){if(!kr.test(e))throw t.error("Invalid type (typenames must be entirely uppercase with at most one underscore)");return Rr}if(e.startsWith("-"))return"--"===e?Dr:Cr;if(!Tr.test(e))throw t.error("Invalid literal (literals must be entirely lowercase broken by single underscores or hyphens )");return _r}(i,e);if(t===Dr)throw e.error("annotation not allowed here");if(t!==Rr)return{type:t,value:i,index:n,suffix:void 0,identifier:i};{const{typename:t,suffix:o}=function(e){const t=e.match(Ar);if(!t)return{typename:Lr(e),suffix:""};const n=t[0];return{typename:Lr(e.slice(0,e.length-n.length)),suffix:n}}(i),r=e.match("...");if(o&&r)throw e.error(Er);return{type:r?Mr:o?Ur:Rr,value:t,index:n,suffix:o,identifier:i}}}const o=e.match(/[|\[\]()=]|\.+/y,!1);if(o)return{type:Pr,value:o,index:n,suffix:void 0};const r=e.match(/\s+/y,!1);if(r)return{type:"ws",value:r};if(e.atEof()||e.startsWith(W,!1))return{type:"eof",value:void 0,index:n};throw e.error("unexpected character")}function Fr(e,t=zr(e)){if(")"===t.value)throw e.error("empty `()`");if(t.type===Pr)throw e.error(`unexpected token ${JSON.stringify(t.value)}`);const n=t.type,i=[t.value],o=n===Cr?2:268435455;for(;;){const t=zr(e,!0);if(")"===t.value)return{type:n,values:i};if("|"!==t.value)throw e.error(`unexpected token ${JSON.stringify(t.value)}`);if(i.length===o)throw e.error("can only have a short option and a long option");const{type:r,value:a}=zr(e,!0);if(r!==n)throw e.error("all members of an equivalent class must have the same type");i.push(a)}}function Br(e,t,n=void 0){if(!Sr.test(e))throw t.error("options names must be groups of lowercase letters, separated by single dashes");const i=e.startsWith("--no-"),o=rr(i?e.slice(5):e.slice(2));if(!t.match("="))return vr(o,e,i?yr:hr,n);if(i)throw new t.error("Options beginning '--no-' may not take a value type");const r=function(e,t){const{type:n,value:i}=zr(e);if(n==Pr&&"("===i){const t=e.lastIndex,{type:n,values:i}=Fr(e);if(n!==_r)throw e.error("only a group of literals",t);return i}if(n===Rr)return i;if(n===_r)return[i];throw n===Ur?e.error(Er):n===Mr?e.error(`a list is not allowed here (do you want \`[${t}=${i.toUpperCase()}]...\`?)`):new e.error("unexpected token")}(t,e);return vr(o,e,r,n)}function Jr(e,t){console.assert(2===e.length),e[0].startsWith("--")||([e[0],e[1]]=[e[1],e[0]]);const n=e[0],i=e[1];if(!Or.test(i))throw t.error("an option can only be aliased as dash following by a letter or number");return Br(n,t,i[1])}function Vr(e,t=!1){const n=[];e.trimStart();let i=!1,o=!0;for(;;){const{type:r,value:a,index:s,suffix:l,identifier:p}=zr(e);if("]"===a)break;if("["===a)!o&&Ir(e,br),i&&Ir(e,xr),n.push(Vr(e)),i=!0;else if("("===a){!o&&$r(e,br);const t=s,{type:i,values:r}=Fr(e);if(i!==_r&&i!==Rr)throw i===Ur||i===Mr?e.error("can only construct a variant with pure types (no suffixes, no lists)",t):i===Cr?e.error("unexpected '-' (named options can only appear in a top-level block immediately after the command name)"):e.error("unknown type for token",t);if(r.length>1){const t={type:i===_r?fr:cr,value:r};e.match("...")?n.push({type:dr,value:t,min:1}):n.push(t)}else{if(1!==r.length)throw new Error("Empty equivalece classes should be prohibitted");n.push(i===_r?{type:ur,value:r[0]}:gr(r[0],p))}}else{if(r===Cr)throw e.error("unexpected '-' (named options can only appear in a top-level block immediately after the command name)");if(r===_r)n.push({type:ur,value:a});else if(r===Rr)n.push(gr(a,p));else if(r===Ur)n.push(wr(a,l,p));else{if(r!==Mr){if("eof"===r){if(t)break;throw e.error("expected `]` (unterminated optional block)")}throw e.error(`unexpected token ${JSON.stringify(a)}`,s)}i&&Nr(e,xr),i=!0,console.assert(void 0===l||""===l,"no suffix on list"),n.push({type:dr,value:gr(a,p),min:1})}}o=e.atEof()||e.startsWith(W,!1)||e.trimStart()}if(0===n.length&&!t)throw e.error("empty `[]` are not allowed!",e.lastIndex);if(e.match("...")){console.assert(!t),n.length>1&&Nr(e,"can only repeat sections containing a single term");const i=n[0];return i.type===lr||i.type===sr||Nr(e,"unknown type"),{type:dr,value:i,min:0}}if(!t&&1===n.length&&n[0].type===dr){const e=n[0];return console.assert(1===e.min,"list reduction from 1"),e.min=0,e}return n}function qr(e,t){return"]"===zr(t,!0).value||function(e,t,n){throw e.error(`expected \`${t}\` (${n})`,e.fence())}(t,"]","only one named option per optional block"),t.match("...",!1)?{type:dr,value:e,min:void 0}:e}function Wr(e,t){return e.type!==sr&&e.type!==dr?e:G(e,t)}function Kr(e,t=""){const n=[];if("string"!=typeof t)throw new TypeError("$0 should be a string");if(t){const e=t===K?gr("String",K):{type:ur,value:t};n.push(e)}e.trimStart();const{mandatoryOptions:i,optionalOptions:o}=function(e){const t=[],n=[];for(;;){const i=zr(e,!0);if("["===i.value){e.trimStart();const{type:t,value:o}=zr(e);if(t===Cr){if(!o.startsWith("--"))throw e.error("expected '--' (only long options supported)");const t=Wr(qr(Br(o,e),e),e);n.push(t)}else{if("("!=o){e.rollback(i.index);break}{const t=zr(e);if(t.type!==Cr){e.rollback(i.index);break}{const{values:i}=Fr(e,t),o=Wr(qr(Jr(i,e),e),e);n.push(o)}}}}else if("("===i.value){const n=zr(e);if(n.type!==Cr){e.rollback(i.index);break}{const{values:i}=Fr(e,n),o=Jr(i,e);t.push(o)}}else{if(i.type!==Cr){e.rollback(i.index);break}if(!i.value.startsWith("--"))throw e.error("expected '--'");t.push(Wr(Br(i.value,e),e))}const o=e.trimStart();if(e.atEof()||e.startsWith("::"))break;if(!o)throw e.error("unexpected character")}return{mandatoryOptions:t,optionalOptions:n}}(e);return n.push(...Vr(e,!0)),e.match("::",!0),[i,o,n]}const Gr=Symbol("literal");function Xr({type:e,value:t,suffix:n},i){if(e===dr){if(t.type===dr)throw new TypeError("list-in-list");return Xr(t,i)}if(e===lr||e===pr||e===fr)return{typename:t,type:Hn(t,i)};if(e===cr)return{typename:t,type:Qn(t)};if(e===ur)return{typename:Gr,type:Zn(t,i)};throw new TypeError(`Unknown nodetype ${JSON.stringify(e)}`)}class Hr{key;aliases=new Set;typename;type;mandatory=!0;recurs;orgTypeName;orgTypeIdentifier;index;constructor({typename:e="",type:t=null,recurs:n=!1,orgTypeName:i="",orgTypeIdentifier:o="",index:r}){this.key=`$${r}`,Object.assign(this,{typename:e,type:t,recurs:n,orgTypeName:i,orgTypeIdentifier:o,index:r})}static fromAstNode(e,t,n=`$${t}`){const{typename:i,type:o}=Xr(e,n),r=function({type:e,value:t,suffix:n}){return e===dr?t.value:e===lr?t:e===pr?t+n:""}(e),a=e.type===dr;return new Hr({typename:i,type:o,recurs:a,orgTypeName:r,orgTypeIdentifier:a?e.value.identifier:e.identifier,index:t})}}function Zr(e,t){return`$${n=e,64&n.charCodeAt(n)?n=n.charAt(0).toLowerCase()+n.slice(1):n}${t?"s":""}`;var n}function Yr(e){const t=function(e){const t=new Map;for(let n=0;n<e.length;++n){const{key:i,type:{literal:o,variant:r},recurs:a,orgTypeName:s}=e[n];if(!o&&!r)if(t.has(s)){const e=t.get(s);e.singular?(e.singular=!1,e.index=[e.index,n],e.key=[e.key,i],e.recurs=[e.recurs,a]):(e.index.push(n),e.key.push(i),e.recurs.push(a))}else t.set(s,{key:i,singular:!0,index:n,recurs:a})}return t}(e);for(const[n,{key:i,singular:o,index:r,recurs:a}]of t.entries())o&&e[r].aliases.add(Zr(n,a))}const Qr=268435455;class ea{#V;#q;#W;#K;#G=!1;#X;#H;get longest(){return this.#H}shortest;size;constructor(e){const t=[],n=[];let i=0,o=0;const r=new Set,a=function(e,t){let n=0;const i=[],o=[{source:e,dest:i,branch:0,branches:0}];for(;o.length;){const{source:e,dest:i,branch:r,branches:a}=o.pop();for(let s=i.length;s<e.length;++s){if(Array.isArray(e[s])){const t=[];o.push({source:e,dest:i,branch:r,branches:a+1}),o.push({source:e[s],dest:t,branch:a,branches:0}),i.push(t);break}const l=o.length;i.push(t(e[s],n++,l,s,r))}}return i}(e,((e,a,s,l,p)=>{const c=Hr.fromAstNode(e,a);if(e.suffix){if(r.has(c.orgTypeName))throw new TypeError(`duplicate ${e.value} suffix '${e.suffix}' at $${a}`);r.add(c.orgTypeName)}if(c.recurs&&t.push({positional:c,depth:s,flatIndex:a,localIndex:l,min:e.min}),0===s?o++:s>i&&(i=s),0!==p)throw new Error("Can only have one optional segment");return console.assert(n.length===a,"invariant: flat index"),n.push(c),c}));let s=n.length,l=s,p=null,c=!1;if(t.length){if(1!==t.length)throw new TypeError("Only one positional may be a list.");if(t[0].depth!==i)throw new TypeError("List must be maximully eldied");p=t[0].positional,l=t[0].flatIndex,c=0===t[0].min,s=Qr,c&&o--}if(Yr(n),function(e){for(const[t,n]of Object.entries(Object.groupBy(e,(({orgTypeIdentifier:e})=>e))))if(""!==t&&"string"==typeof t)if(1!==n.length)for(const e of n);else n[0].aliases.add(t)}(n),this.#V=a,this.#q=n,this.shortest=o,this.#H=s,this.#W=l,this.#K=p,this.#X=c,this.size=i+1,!(null!==this.#K?this.longest===Qr:this.longest!==Qr))throw console.log("this",this.#K,this,null!==this.#K,this.longest!==Qr),new Error("List invariant failed")}hasList(){return console.assert(null!==this.#K?this.longest===Qr:this.longest!==Qr,"PositionalTree: invariant: both measures of list must match"),null!==this.#K}getLongestBranch(){return this.#q}enumOptions(){return this.#q.values()}getNearestTo(e){const t=function(e,t){for(;;){const n=e.filter((e=>!Array.isArray(e)));if(t<=n.length||n.length===e.length)return n;e=e.flat(1)}}(this.#V,e);if(this.#X&&t.length>e){const e=t.findIndex((e=>e===this.#K));if(-1===e)throw new TypeError("List missing");t.splice(e,1)}return t}getList(){return this.#K}getListSlice(e){if(!this.hasList())return;const t=this.#q.length-1,n=t<e?e-t:0;return 0===n&&this.#X?void 0:{start:this.#W,end:this.#W+n}}isEmpty(){return 0===this.#H}arrange(e){return function(e,t){const n=t.length-1?"only "+(t.length-1):"none";if(t.length<e.shortest)throw new TypeError(`Required ${e.size>1?"at least ":""}${e.shortest-1} arguments - but ${n} given.`);const i=e.getNearestTo(t.length);if(t.length<i.length)throw new TypeError(`Required ${i.length} arguments - but only ${n} given`);if(t.length>e.longest)throw new TypeError(`No more than ${e.longest} positional arguments`);const o=e.getListSlice(t.length);let r;var a,s,l;return o?(r=t.slice(0),a=r,s=o.start,l=o.end,a[s]=a.splice(s,l-s,null)):r=t,{positionals:r,positionalOptions:i}}(this,e)}*aliases(){for(const{key:e,aliases:t}of this.#q)for(const n of t)yield[e,n]}get(e){return this.#q.find((({key:t})=>t===e))}has(e){return this.#q.some((({key:t})=>t===e))}addTail(){if(this.#G||this.hasList())throw new Error("already has a tail");if(this.shortest!==this.longest)throw new TypeError("can only set tail when there are no optionals");this.shortest++,this.#H++,this.#G=!0;const e=new Hr({index:this.shortest-1});this.#q.push(e),this.#V.push(e)}getTailStartIndex(){return this.#G?this.shortest-1:0}}const ta="inline";const na="instantiated",ia="none";function oa({defaultText:e,defaultValue:t}){return void 0!==t?{type:na,value:t}:void 0!==e&&e?{type:"raw",value:e}:{type:ia,value:void 0}}class ra{key;optionName;shortAlias;optionNames;typename;type;mandatory;platform;recurs;defaultText;defaultValue;annotation="";constructor({key:e,optionName:t,shortAlias:n,typename:i,mandatory:o,platform:r,recurs:a,defaultText:s,defaultValue:l,annotation:p=""}){if(!function(e){return"string"==typeof e||"symbol"==typeof e||!!Array.isArray(e)&&e.every((e=>"string"==typeof e))}(i))throw new TypeError("Invalid typename");if("string"!=typeof t||!t.startsWith("--"))throw new TypeError("Invalid option name");let c;if(""===i){if(r!==ta)throw new TypeError("Invalid typename");c=null}else c=Hn(i,e);const u=[t];if("string"==typeof n&&n){if(1!==n.length)throw new Error("Invalid short alias");u.push(`-${n}`)}Object.assign(this,{key:e,optionName:t,shortAlias:n,optionNames:u,typename:i,type:c,mandatory:o,platform:r,recurs:a,defaultText:s,defaultValue:l,annotation:p})}static fromMandatoryAstNode(e){const t=e.type===dr,{platform:n=""}=e,{type:i,key:o,value:r,option:a,shortAlias:s}=t?e.value:e;return console.assert(i===sr,"node must be a named parameter"),new ra({key:o,optionName:a,shortAlias:s,typename:r,mandatory:!0,platform:n,recurs:!!t,defaultText:void 0,defaultValue:void 0,annotation:e.annotation})}static fromNonMandatoryAstNode(e,t,n){const i=e.type===dr,{platform:o=""}=e,{type:r,key:a,value:s,option:l,shortAlias:p}=i?e.value:e;return console.assert(r===sr,"node must be a named parameter"),new ra({key:a,optionName:l,shortAlias:p,typename:s,mandatory:!1,platform:o,recurs:!!i,defaultText:t,defaultValue:n,annotation:e.annotation})}static fromInlineOption({name:e,typename:t,hasDefaultValue:n,defaultValue:i}){if("string"===t)t="String";else if("boolean"===t&&n){if("boolean"!=typeof i)throw new Error("Assert: typeof defaultValue === 'boolean'");t=i?yr:hr}const o=(t===yr?"--no-":"--")+e.replaceAll(/(?:(?<=[a-z])[A-Z]|(?<=[A-Z])[A-Z](?=[a-z]))/g,(e=>"-"+e)).toLowerCase();return new ra({key:e,optionName:o,shortAlias:void 0,typename:t,platform:ta,recurs:!1,defaultText:void 0,defaultValue:i})}isInsaneBoolean(){const{typename:e}=this;return e===hr||e===yr}static sanitiseBoolean(e){if(1!==e.length&&2!==e.length)throw new TypeError("1-2 booleans required for sanitisation");if(!e[0].isInsaneBoolean())throw new TypeError("No sanitisation necessary");if(e.length>1&&!e[1].isInsaneBoolean())throw new TypeError("No sanitisation necessary");const t=new ra(e[0]);t.typename="boolean";const n=typeof t.defaultValue;if("boolean"!==n&&"undefined"!==n)throw new TypeError("`typeof defaultValue` should be `undefined` or `boolean`");return 2===e.length?(console.assert(!t.mandatory,"not mandatory"),t.defaultText=void 0,t.defaultValue=void 0):(console.assert("boolean"==typeof t.defaultValue||void 0===t.defaultValue,"single boolean arg must have a default value"),console.assert(t.defaultText===oe||void 0===t.defaultText,"expected default text to be DEFAULT_MISSING_BOOL",t.defaultText)),t}isInline(){return this.platform===ta}toBaseOptionName(){const{optionNames:e}=this;return e.length>1?`(${e.join("|")})`:e[0]}toBareUsage(e){let t,n=this.toBaseOptionName();if(t=this.optionNames.length>1?e.get(this.optionNames[0]).arg!==Xo:e.get(n).arg!==Xo,t){const{typename:e}=this;Array.isArray(e)?n+=`=(${e.join("|")})`:n+="="+ar(e)}return this.recurs&&(n+="..."),n}}function*aa(e){do{yield e}while(e=e.next)}function*sa(e,t){e.has(t)&&(yield*aa(e.get(t)))}class la{#Z=new Set;#w=new Map;get size(){return this.#Z.size}has(e){return this.#w.has(e)}get(e){if(this.#w.has(e))return this.#w.get(e).value}enumAll(e){return sa(this.#w,e).map((({value:e})=>e))}getAll(e){return function(e,t){return Array.from(sa(e,t),(({value:e})=>e))}(this.#w,e)}set(e,t){for(const t of sa(this.#w,e))this.#Z.delete(t);const n={key:e,value:t,next:null};this.#Z.add(n),this.#w.set(e,n)}append(e,t){const n={key:e,value:t,next:null};this.#Z.add(n),this.#w.has(e)?(function(e,t){for(const n of sa(e,t))if(!n.next)return n}(this.#w,e)).next=n:this.#w.set(e,n)}delete(e){for(const t of sa(this.#w,e))this.#Z.delete(t);this.#w.delete(e)}*entries(){for(const{key:e,value:t}of this.#Z)yield[e,t]}keys(){return this.#w.keys()}*multipleValues(){for(const e of this.#w.values())e.next&&(yield Array.from(aa(e),(({value:e})=>e)))}}function pa(e,t,n,i=""){let o=`${i}${t(e[0])}`;for(let i=1;i<e.length;++i)o=`${o}${n}${t(e[i])}`;return o}function ca(e){if(Array.isArray(e))return`[${pa(e,ca," ")}]`;if(e.type===ur)return e.value;if(e.type===dr)return ca(e.value)+"...";if(e.type===lr)return ar(e.value);if(e.type===cr)return`(${pa(e.value,ar,"|")})`;if(e.type===sr)return pa(function(e,{annotation:t=!0,defaultJson:n}={}){const i=function(e){return e.type===dr?e.value:e.type===sr?e:(console.log(e),null)}(e);if(!i)throw console.log(e),new TypeError("Not an option node");const o=[],{option:r,shortAlias:a,value:s}=i,{annotation:l}=e;a?o.push({type:"literal",value:"("},{type:"short",value:`-${a}`},{type:"literal",value:"|"},{type:"long",value:r},{type:"literal",value:")"}):o.push({type:"long",value:r});"true"!==s&&"false"!==s&&(o.push({type:"literal",value:"="}),Array.isArray(s)?o.push({type:"type",value:"("+pa(s,(e=>e),"|")+")"}):o.push({type:"type",value:ar(s)}));e.type===dr&&o.push({type:"literal",value:"..."});t&&l&&o.push({type:"literal",value:": "},{type:"annotation",value:l});void 0!==n&&o.push({type:"literal",value:" "},{type:"literal",value:"["},{type:"literal",value:"DEFAULT:"},{type:"literal",value:" "},{type:"value",value:JSON.stringify(n)},{type:"literal",value:"]"});return o}(e,{annotation:!1}),(e=>e.value),"");if(e.type===fr)return`(${e.value.join("|")})`;if(e.type===mr)return"...";throw console.log(e),console.log(lr,e.type===lr),new TypeError(U`Unsupported node type (${e.type})`)}const ua="default";function da(e){const{instantiated:t=[],raw:n=[]}=Object.groupBy(e,(({isInstantiated:e})=>e?"instantiated":"raw"));if(0===t.length)return{values:n.map((({value:e})=>e)),isInstantiated:!1};if(0===n.length)return{values:t.map((({value:e})=>e)),isInstantiated:!0};throw new Error("Cannot mix instanatiated and unintatiated values")}class fa{#Y;#Q;#ee;#te;get positionalOptions(){return this.#Q}get cliMap(){return this.#te}get saneOptionsFromKey(){return this.#ee}get positionalAstNodes(){return this.#Y}constructor({positionalAstNodes:e,positionalTree:t,saneOptionsFromKey:n,cliMap:i}){this.#Y=e,this.#Q=t,this.#ee=n,this.#te=i}static fromOptionsOnly(e,t="",n={},i=[]){return function(e,t="",n,i){const o=va(Kr(new ee(e),""),n,i);if(o.hasPositionalOptions())throw console.log(o.positionalOptions),new TypeError("Cannot add positional options");if(""!==t)for(const e of o.saneOptionsFromKey.values())console.assert(""===e.platform,"platforms shouldn't be defined (was %s)",e.platform),e.platform=t;return o}(e,t,n,i)}hasPositionalOptions(){return!this.#Q.isEmpty()}hasRecurringPositional(){return null!==this.#Q.getList()}getRecurringPositionalType(){return this.#Q.getList()?.type??null}enumPositionalTypes(){return new Set(this.#Q.getLongestBranch().map((({type:e})=>e))).values()}getPostionalString(){const e=this.#Y.values();e.next();let t="";for(const n of e)t&&(t+=" "),t+=ca(n);return t}enumAllOptions(){return this.#ee.values()}enumAllPositionals(){return this.#Q.enumOptions()}getCliMap(){return this.#te}keys(){return this.#ee.keys()}getNamedOptionFromKey(e){return e.startsWith("$")?this.#Q.get(e):this.#ee.get(e)}hasKey(e){return e.startsWith("$")?this.#Q.has(e):this.#ee.has(e)}addOptions(e){const t=new Map(this.#ee.entries()),n=new Map(this.#te.entries());for(const[t,i]of e.cliMap){if(n.has(t))throw new TypeError(U`key ${t} already defined`);n.set(t,i)}for(const[n,i]of e.saneOptionsFromKey){if(t.has(n))throw new TypeError(U`key ${n} already defined`);t.set(n,i)}return new fa({positionalAstNodes:this.#Y,positionalTree:this.#Q,saneOptionsFromKey:t,cliMap:n})}getConflictingOptions(e){return new Set(this.#te.keys()).intersection(new Set(e.cliMap.keys()))}rawParse(e){return er(this.#te,e)}*parseOptions(e){const t=this.#ee,n=this.#te,i=new Set(t.values()),o=new Map(Array.from(function*(e){for(const t of e.values())if(t.recurs){if(t.mandatory)throw new Error("Invariant: a recurring key cannot be mandatory");if(oa(t).type!==ia)throw new Error("Invariant: recurring items cannot have a default");yield t}}(t),(e=>[e,[]]))),r=[];for(const a of er(n,e,this.#Q.getTailStartIndex())){if(""===a.key){r.push(a);continue}const e=t.get(a.key);if(o.has(e)){o.get(e).push(a)}else{if(!i.has(e))throw new TypeError(U`Cannot repeat option ${e.toBaseOptionName(n)}`);yield a}i.delete(e)}for(const[e,t]of o){const{optionName:n}=e,{values:o,isInstantiated:r}=da(t);yield{key:e.key,value:o,isInstantiated:r,optionName:n,source:o.length?Qo:ua,list:!0},i.delete(e)}for(const e of i){if("help"===e.key)continue;if(e.mandatory)throw new TypeError(U`Missing option ${e.toBareUsage(n)}`);const{type:t,value:i}=oa(e);if(t!==ia){const{optionName:n}=e;yield{key:e.key,value:i,isInstantiated:t===na,optionName:n,source:ua,list:!1}}}const{positionals:a,positionalOptions:s}=this.#Q.arrange(r);console.assert(a.length===s.length,"PositioanlOptions and rawPositionals must marry up");for(let e=0;e<a.length;++e){const t=s[e];if(t.recurs){const{values:n,isInstantiated:i}=da(a[e]);yield{key:t.key,value:n,isInstantiated:i,optionName:t.key,source:Qo,list:!0}}else{const{value:n,isInstantiated:i,source:o}=a[e];yield{key:t.key,value:n,isInstantiated:i,optionName:t.key,source:Qo,list:!1}}}yield{key:"$",value:s.map((e=>e.key)),isInstantiated:void 0,optionName:"$",source:"computed",list:!0}}*getAliases(){for(const{aliases:e,key:t}of this.#Q.enumOptions())for(const n of e)yield[n,t]}addOperators(e){const t=this.#te;for(const[n,i]of Object.entries(e))t.has(i)&&t.set(n,this.#te.get(i));return this}addTail(){this.#Q.addTail(),this.#Y.push({type:mr})}}function ma(e,t){if(!e.hasDefaultValue&&!e.hasExplicitType)return!0;throw new Error("Cannot declare an option in both usage and binding")}function ha(e,t,n,i){const{key:o}=e,r=i.get(o),a=i.has(o);return t&&a&&console.warn(U`warning: list option ${o} has a default value`),n.has(o)?(a&&console.warn(U`warning: default for option ${o} will be ignored`),{defaultText:n.get(o),defaultValue:r}):t||"true"!==e.value&&"false"!==e.value?{defaultText:void 0,defaultValue:r}:a?("true"===e.value?!1!==r&&console.trace(`warning: true option ${o} doesn't default to false`):!0!==r&&console.warn(`warning: false option ${o} doesn't default to true`),{defaultText:oe,defaultValue:r}):{defaultText:oe,defaultValue:"true"!==e.value}}function ya(e,t={},n=[],i){const o=function([e,t,n]){const i=new ea(n);if(!i)throw new TypeError("Postional arguments are ambiguous.");return{mandatoryOptions:e,optionalOptions:t,positionalTree:i}}(e),{mandatoryOptions:r,positionalTree:a,optionalOptions:s}=o;for(const e of s)e.platform="";const l=[];for(const e of r)l.push(ra.fromMandatoryAstNode(e));const p=new Map(Object.entries(t)),c=new Map(n);for(const e of s){const t=e.type===dr,n=t?e.value:e,{defaultText:i,defaultValue:o}=ha(n,t,p,c);l.push(ra.fromNonMandatoryAstNode(e,i,o))}for(const e of i)l.push(ra.fromInlineOption(e));return{allOptions:l,positionalTree:a}}function va(e,t={},n=[],i=[]){const{allOptions:o,positionalTree:r}=ya(e,t,n,i),a=new Map,s=new la;for(const e of o){const{key:t,optionNames:n}=e;s.append(t,e);for(const e of n)if(a.has(e)){if(a.get(e)!==t)throw new Error(U`Duplicate option ${e}`)}else a.set(e,t)}const l=new Map;for(const e of s.keys()){const t=s.getAll(e);t.length,0;const{inline:n=[],usage:i=[]}=Object.groupBy(t,(e=>e.isInline()?"inline":"usage"));if(i.length>1){if(2!==i.length||i[0].optionName===i[1].optionName)throw new TypeError(`Duplicate options for key ${e}`);if(i.some((e=>e.defaultText!==oe)))throw new TypeError(`Duplicate options for key ${e}`);for(const e of i)e.defaultText=void 0;const t=ra.sanitiseBoolean(i);l.set(t.key,t)}else 1===i.length&&l.set(i[0].key,i[0].isInsaneBoolean()?ra.sanitiseBoolean(i):i[0]);if(n.length>=1){if(1!==n.length)throw new Error(`Internal error (inline options for key ${e} not deduplicated)`);if(0===i.length&&""===n[0].typename)throw new Error(U`Inline-option ${n[0].optionName} has no type. (Add a type or shadow the option in the usage )`);if(!ma(n[0],i[0]))throw new Error("Cannot declare an option in both usage and binding");0===i.length&&l.set(n[0].key,n[0].isInsaneBoolean()?ra.sanitiseBoolean(n):n[0])}}const p=new Map;for(const[e,t]of a){const n=s.getAll(t);if(1===n.length)p.set(e,Ho.fromOption(n[0]));else if(n[0].optionNames.includes(e))p.set(e,Ho.fromOption(n[0]));else{if(!n[1].optionNames.includes(e))throw console.log(n),new Error(U`Internal error (can't find option record for key ${t} with option name ${e})`);p.set(e,Ho.fromOption(n[1]))}}return new fa({positionalAstNodes:e[2],positionalTree:r,saneOptionsFromKey:l,cliMap:p})}const ga="Expected SCRIPTLET_NAME",wa="Invalid version string",xa="Illegal character",ba=/\d+(?=\s)/y;function Ea(e,t){if(e.toUpperCase()!==e)throw t.error("Environment variables must be composed of UPPERCASE letters");if(e.includes("-")){if(e.includes("_"))throw t.error("Environment variables cannot mix SNAKE_CASE (underscores) with KEBAB-CASE (hyphens)");return t.warn("Environment variables should use SNAKE_CASE (underscores) not KEBAB-CASE (hyphens)"),rr(e.toLowerCase())}return e.toLowerCase().replaceAll(/_[a-z]/g,(e=>e.charAt(1).toUpperCase()))}function Ta(e,t=!1){return e.atEof()||e.startsWith(W)||(t?e.trimStart():e.startsWith(/\s/y))}const ka="A".charCodeAt(0),Sa="a".charCodeAt(0);function Oa(e){const t=e.match(/\d+/y,!1);if(""===t)throw e.error(wa);const n=parseInt(t,10);if(0===n)throw e.error(wa);const i=e.match(/[A-Za-z]?/y,!1);let o=0;if(i.length){const e=i.charCodeAt(0);o=e<"a".charCodeAt(0)?26+e-ka:e-Sa,++o}if(!Ta(e,!0))throw e.error(wa);return{major:n,minor:o,text:t+i}}const ja=/\s*?(?:\r?\n|$)/y,Aa=/\s*?(?=\r\n?|\n|\S|$)/y,Na=/\r\n?|\n/y,Ia=/\s/y;const $a=new Set(["idl","details","summary","defaults","api","name"]);function La(e,{extractName:t=!1}={}){if(!1===t)throw new TypeError("No extract name");const n=new ee(e),{major:i,minor:o}=function(e){if(e.trimStart(),!e.match("IDL=",!1)){if(!e.match("API=",!1))throw e.error("Expected `IDL=<version>` as first token.");console.warn("deprecated: use of `API=` instead of `IDL=`")}return Oa(e)}(n),r=function(e){const t=[];let n="";const i=()=>{n&&(t.push(n),n="")};for(;e.match(Aa,!1),!e.atEof();)if(e.match("--",!1)){if(e.atEof())break;if(!e.startsWith(Ia))throw e.error("Expected whitespace");if(e.match(ja,!1))i();else{const t=e.match(q,!1);n+=t}}else{if(!e.match(Na))break;i()}return i(),t}(n),a=function(e){const t={idl:void 0};for(;;){const n=e.pos;if(e.startsWith("-"))throw e.error(ga);const i=e.match(F,!1)||e.match(K);if(!i)throw e.error(ga);if(i===K||!e.match("=",!1)){if(!Ta(e,!1))throw e.error(xa);const{annotation:n}=G({},e);return t.idl=e.getText().slice(e.pos),t.name=i,void 0!==n&&(t.summary=n),t}const o=Ea(i,e);if($a.has(o))throw e.error(`Environment variable uses reserved name (${o})`,n);if(Object.hasOwn(t,o))throw e.error(`Environment variable redeclared (${o})`,n);if(Ta(e,!1))throw e.error("Expected value");let r;if(r=""!==e.match(ba,!1)?parseInt(e.slice(e.lastIndex),10):H(e),!Ta(e,!0))throw e.error(xa);t[o]=r.valueOf()}}(n);return a.api=i+o/100,r.length&&(a.summary=r[0],a.details=r.slice(1)),a}class _a{#ne;#ie;#oe;constructor(e,t){this.#ne=e,this.#ie=t}setValueAsBuffer(e){this.#ie.write(e)}setValueAsBufferStream(e){for(const t of e)this.#ie.write(t)}toStream(){return this}async fetchValueAsBuffer(){if(!this.#ne)throw new TypeError("Stream not readable");return this.#oe=async function(e){const t=[];for await(const n of e)t.push(n);return Buffer.concat(t)}(this.#ne)}toBuffer(){return this.fetchValueAsBuffer()}async fetchContentAsResponse(){const e=await this.fetchValueAsBuffer();return new Response(e,{status:200,statusText:"OK",headers:new Headers})}}const Ra=(e,t)=>Math.imul(e,t);function Ua(e){return Ra((t=Ra(e,3432918353))<<15|t>>>17,461845907);var t}const Ma="input",Ca={Map:Map,Set:Set,Buffer:Buffer,Boolean:Boolean,Error:Error,Promise:{all:e=>Promise.all(e)},String:String,Number:Number,JSON:{stringify:JSON.stringify,parse:JSON.parse,isJSON:()=>!0,[te]:()=>JSON}},Pa={"%Response.prototype%.buffer(...)":async function(){return Buffer.from(await this.arrayBuffer())},..."undefined"==typeof Iterator?{"%Iterator.prototype%.map(...)":function*(e){for(const t of this)yield e(t)},"%Iterator.prototype%.toArray(...)":function(){const e=[];for(const t of this)e.push(t);return e},"%Iterator.prototype%.forEach(...)":function(e){for(const t of this)e(t)}}:{},"%String.prototype%.hash(...)":function(e){const t=function(e,t=4294967295*Math.random()>>>0){let n=t,i=0;for(;i+3<e.length;i+=4)n^=Ua(e.readUint32LE(i)),n=(o=n)<<13|o>>>19,n=Ra(n,5),n=3864292196+(n>>>0)>>>0;var o;return n^=Ua(function(e,t){let n=0;return t<e.length&&(n=e[t],t+1<e.length&&(n<<=8,n|=e[t+2],t+2<e.length&&(n<<=8,n|=e[t+2]))),n}(e,i)),n^=e.length,n^=n>>>16,n=Ra(n,2246822507),n^=n>>>13,n=Ra(n,3266489909),n^=n>>>16,n>>>0}(Buffer.from(this),e);return console.log("hash",this,t.toString(16)),t},"%String%.isString(...)":e=>"string"==typeof e||e instanceof String,"%Boolean%.isBoolean(...)":e=>"boolean"==typeof e||e instanceof Boolean,"%Number%.isNumber(...)":e=>"number"==typeof e||e instanceof Number},Da={recursive:void 0,expandGlobs:!0,output:"-",outputTextEncoding:"utf8"};function za(e){const{api:t,name:n,usageAndBinding:i,defaults:o,summary:r,details:a}=function(e){const{api:t,name:n,idl:i,summary:o,details:r,...a}=La(e,{extractName:!0});return{api:t,name:n,usageAndBinding:i,idl:i,summary:o,details:r,defaults:a}}(e),s=new ee(i),l=Kr(s,n),p=To.from(s);Object.defineProperty(p,"output",{get:()=>{throw new Error("Acccessed binding.output")}}),p.remapGlobals("$-",Ma);const c=va(l,o,p.globalsWithLiteralDefaults(),p.inlineOptions);let u="[(--cwd|-C)=DIR] [(--help|-h)]";p.void||(u+=" [(--output|-o)=FILE]",u+=" [--output-format=STR] [--output-text-encoding=(utf8|ucs2)]\n[--output-mimetype=STR] -- Set the mimetype. Only neede for pipes. Will normally be defaulted by `--output-format` and shouldn't be override.\n"),function(e){if(!e.hasRecurringPositional())return!1;const t=e.getRecurringPositionalType();return"File"===t.name||"(Dir|File)"===t.name}(c)&&(u+=" [(--recurse|-R)] [--no-recurse] [(--exclude|-X)=GLOB_TEXT]...");const d=p.globals,{usesInput:f,inputVariable:m,inputOptions:h}=function(e,t){const n=e.has(Ma),i=n?Ma:"";let o="";return n&&(t.hasKey(Ma)||(o="[--input=FILE]")),{usesInput:!!n,inputVariable:i,inputOptions:o}}(d,c);p.usesInput=f,h&&(u+=" "+h);const y=c.addOptions(fa.fromOptionsOnly(u,"platform",o,p.globalsWithLiteralDefaults()));!function(e){if(!e.hasKey(Ma))return;const t=e.getNamedOptionFromKey(Ma),{mandatory:n,optionName:i,defaultValue:o,defaultText:r}=t;console.assert(void 0===o,"--input should never have a value default",o),console.assert(void 0===r,"--input should never have a text default"),void 0===t.defaultText&&(t.defaultText=Do)}(y),function(e,t){for(const{key:n,platform:i}of t)if(!e.has(n)&&!i)throw new TypeError(`arg ${JSON.stringify(n)} left unbound`)}(d,y.enumAllOptions());const v=function(e){for(const t of e.enumPositionalTypes())if(t.realiseStdioAs)return!0;return!1}(y);return{api:t,name:n,binding:p,inputVariable:m,summary:r??"",details:a,platformOptions:u,hasStdinReplaceables:v,hasStdoutReplaceables:!p.void,userSuppliedDefaults:o,usageObject:y}}function Fa(e,t={}){const n=To.from(new ee(e)),i=Object.assign({},Da,qn,Ca,Pa,t),{name:o,args:r,result:a}=function(e,t,n,i=!0,o){return{name:void 0,args:bo(e,t,n,i,o),resultTypeAssertion:e.cast}}(n,new Map(Object.entries(i)));return{name:o,args:r}}function Ba(e){return"function"!=typeof e?e:"string"==typeof e.name&&""!==e.name?{default:e,[e.name]:e}:{default:e}}function Ja(e,t,n=!1){if("string"==typeof e||"symbol"==typeof e){const n=t[e];return"function"==typeof n?{[e]:n}:null}if(Array.isArray(e)){const i={};for(const o of e){if(!Object.hasOwn(t,o)){if(!n)return null;throw new Error(`Module doesn't have an export called ${JSON.stringify(o)}`)}i[o]=t[o]}return i}throw new TypeError("Invalid imports in binding")}class Va{#re;get text(){return this.#re}#ae;#D;#r;inputVariable;summary;details;get platformOptions(){throw new Error("Platform options not supported any more")}globalDefaults=null;hasStdinReplaceables;hasStdoutReplaceables;userSuppliedDefaults;__dirname;get name(){return this.#r}constructor(e,t={},n){if(e instanceof Va)throw new TypeError("Copy!");if("string"!=typeof e)throw new TypeError("IDL should be string now");const i=function(e){try{return e?c(new URL(".",e)):void 0}catch{}}(n),{api:o,name:r,binding:a,inputVariable:s,summary:l,details:p,platformOptions:u,hasStdinReplaceables:d,hasStdoutReplaceables:f,userSuppliedDefaults:m,usageObject:h}=za(e);if(-1!==o&&1!==o)throw void 0===o?new TypeError("Module's js-hell declaration is invalid (it's missing an `api` key)"):"number"!=typeof o?new TypeError("Module's js-hell declaration is invalid (the `api` key must be a number)"):new TypeError(`Module uses an unsupported API version (version 1 is required, but script is version ${o})`);Object.assign(this,{summary:l,details:p,globalDefaults:t,hasStdinReplaceables:d,hasStdoutReplaceables:f,userSuppliedDefaults:m,inputVariable:s,__dirname:i}),this.#re=e,this.#ae=a,this.#D=h,this.#r=r}validateModule(e){return!!Ja(this.#ae.name,Ba(e))}getDefaults({stdout:e=process.stdout,stdin:t=process.stdin,cwd:n=process.cwd(),globalDefaults:i={}}={}){const o=new _a(t,e),{globalDefaults:r,userSuppliedDefaults:a,__dirname:s}=this;return{...Da,...a,...qn,...Ca,...Pa,...r,...i,cwd:xn.fromFullPath(n),output:o,"$-":o,input:t,__dirname:"string"==typeof s&&s?xn.fromFullPath(s):void 0}}createLexicalEnvironment(e){return new or(this.#D,this.getDefaults(e))}getUsage(e="",t={}){return""===e?this.#D:this.#D.addOptions(fa.fromOptionsOnly(e,"host")).addOperators(t)}getOptionConflicts(e){return this.#D.getConflictingOptions(fa.fromOptionsOnly(e,"host"))}parseOptions(e,t=""){return this.getUsage(t).parseOptions(e)}async _exec(e,t,n={}){const i=this.createLexicalEnvironment(n);i.appendParsedOptions(this.parseOptions(Ko(t)));const o=i.finalise();return{result:await this._exec1(e,o,n),_rawDictionary:o}}async _execParsed(e,t,n={}){const i=this.createLexicalEnvironment(n);i.appendParsedOptions(this.parseOptions(t));const o=i.finalise();return this._exec1(e,o,n)}async _exec1(e,t,{brk:n=!1,inspect:i=!1}={}){const o=this.#ae,r=Ba(e),a=Ja(o.name,r,!0);if(!a)throw new TypeError("Module's entry point is missing or not a function");return(i||n)&&await import("node:inspector"),o.exec(new Map(Object.entries(t)),a,{legacyBrk:n})}toString(){return this.#re}isInputUsed(){return""!==this.inputVariable}inputUsedWithMethodCall(){const e=this.#ae.getGlobal(this.inputVariable);return e&&0===e.othersCount?e.methods:null}canGuaranteeNoOuput(){return this.#ae.void}getResultType(){return this.#ae.cast}getCliMap(){return this.#D.getCliMap()}getPositionalList(){return this.#D.enumPositionalAstNodesExcluding$0()}addTail(){this.#D.addTail()}}const qa="js_hell",Wa=qa,Ka="js-hell",Ga="Invalid IDL";function Xa(e){if("string"!=typeof e&&("object"!=typeof e||!e))return;const t=new URL(e);if("file:"!==t.protocol)return;const n=f(t,{throwIfNewEntry:!1});if(!n)return;return new Date(n.mtimeMs).toISOString()}class Ha{#se;#le;#re;#pe;#ce;#ue;constructor(e,{module:t,moduleUrl:n,name:i,version:o=Xa(n)}){if(this.#se=n,this.#le=t,Array.isArray(e)&&(e=pa(e,(e=>{if("string"!=typeof e)throw new TypeError(Ga);return e}),"\n")),"string"!=typeof e)throw new TypeError(Ga);if(this.#re=e,void 0===i){const e=new URL(this.#se);if(e.hash)this.#ce=e.hash.slice(1);else{const t=e.pathname;this.#ce=k(t,S(t))}}else{if("string"!=typeof i)throw new TypeError("Invalid `name`");this.#ce=i}this.#ue=o}get moduleUrl(){return this.#se}get api(){throw new TypeError("Not implemented")}get summary(){throw new TypeError("Not implemented")}get details(){throw new TypeError("Not implemented")}get defaults(){throw new TypeError("Not implemented")}get idlText(){const e=this.#re;if(!function(e){return"*"===e}(e))return e;const t=this.#le;if(void 0===t)throw new TypeError("module not loaded");if("object"!=typeof t||!this.#le)throw new TypeError("invalid module (not an object)");if(!Object.hasOwn(t,qa))throw new Error(`invalid module (missing export ${qa})`);return t[qa]}get idl(){if(void 0!==this.#pe)return this.#pe;if(this.#pe=new Va(this.idlText,void 0,this.#se),this.#pe.name!==this.#ce&&this.#pe.name!==K)throw new TypeError("Name mismatch"+U`: expected the module name (${this.#ce}) to match the IDL name (${this.#pe.name})`);return this.#pe}get name(){return this.#ce}get version(){return this.#ue}async importModule(){if(!this.#le){const e=new URL(this.#se);"about:"===e.protocol&&"blankjs"===e.pathname?this.#le=Object.create(null):(e.hash="",this.#le=await import(e))}return this.#le}static from(e,t,n=void 0,i){return new Ha(e,{module:n,moduleUrl:t,name:i})}static async fromModuleUrl(e,t,n=void 0){const i=new URL(e,t).toString(),o=await import(i);return Ha.from("*",i,o,n)}}function Za(t,n=".",{relative:i=!0}={}){const o=n;for(n=e.resolve(n);;){if(b(e.join(n,t)))return i?e.relative(o,n)||".":n;const r=e.parse(n);if(""===r.dir||r.dir===r.root)return"";n=e.join(n,"..")}}var Ya=Object.freeze({__proto__:null,default:Za});const Qa=Symbol;class es{#r;#de;#fe;get name(){return this.#r}get type(){return"catalogue"}isRunnable(){return!0}get source(){return this.#fe}get value(){return this.toScriptlet()}async exec(e,t){const n=this.#de.find((([t])=>t===e));if(!n)throw new Error(U`No such sub command ${e}`);const i=n[1],o=await i.importModule(),r=[{type:"$n",value:i.idl.name,info:""},...t],a=fn().lexicalEnvironmentOptions;return i.idl._execParsed(o,r,a)}constructor(e,t,n,i){if(e!==Qa)throw new Error("Illegal invocation");this.#r=t,this.#de=n,this.#fe=i}toScriptlet(){const e=this.#de.map((([e])=>e)).join("|"),t=new Ha(`IDL=1 $0 (${e}) :: default( $1, $2 )`,{name:this.#r,module:{default:(e,t)=>this.exec(e,t)}});return t.idl.addTail(),t}static fromPackageTree(e,{url:t,name:n}){const i=e.getOwnScriptletEntries(t);if(0===i.length)throw new Error("Package has no scriptlets");return new es(Qa,n,i,t)}static async fromScriptlets(e,{name:t,source:n}){if(0===e.length)throw new Error("Package has no scriptlets");return new es(Qa,t,e.map((e=>[e.name,e])),n)}}const ts="IDL=1 js-hell :: default( $1, {cwd} )";var ns=Object.freeze({__proto__:null,default:function(e,t={}){throw new Error("Shouldn't be reachable")},js_hell:ts});var is=Object.freeze({__proto__:null,default:function(e,t){console[e](t)},js_hell:'IDL=1    \n    -- Write a messge to the log. (i.e. call `console[LEVEL](TEXT)`)    \n    log [--level=(debug|log|info|error|warn)] TEXT     \n    :: default( level = "log", $1 )   '});async function os(e=80){const{user:t,builtin:n,packageScripts:i}=await async function(){const e=new ml;await e.addCwdPackageTree();const t=[],n=[],i=[];for(const o of e.packages()){const{name:e,type:r,source:a}=o;if(a===tl)t.push(e);else if(r===Qs)i.push(e);else{const t=await o.isRunnable();t&&n.push(e+(t?"":"†"))}}return t.sort(((e,t)=>e.localeCompare(t))),n.sort(((e,t)=>e.localeCompare(t))),i.sort(((e,t)=>e.localeCompare(t))),{builtin:t,user:n,packageScripts:i}}();return{usage:"js-hell SCRIPTLET ...",summary:"",details:[...ji(n,e,"builtins: "),...t.length?["",...ji(t,e,"package:  ")]:[],...i.length?["",...ji(i,e,"npm run:  ")]:[]],defaults:[]}}const rs="\n[--log=FILE]   -- Save `console.xxx()` messages to FILE, instead of writing them to stderr.\n[--stacktrace] -- Print a full stacktrace on error.\n",as={">":"--output","<":"--input","2>":"--log"};var ss=Object.freeze({__proto__:null,default:async function(e=null,{helpStyle:t="hg",SCREEN_COLUMNS:n=80,externalName:i="$0"}={}){let o,r,a,s,l;if(e){const t=function(e,t=e.name){const n=e=>e.replaceAll(/\s*\r?\n\s*/g," ").trim();let i=t;const o=n(e.summary),r=e.details?e.details.map(((t,i)=>n(t)+(i<e.details.length-1?"\n":""))):[],a=[],s=e=>!e.isInline()&&e.platform,l=e.getUsage(rs),p=Array.from(l.enumAllOptions()),c=l.getCliMap();let u="",d=!1,f="";for(const e of p)if(s(e))f&&(f+=" "),f+="["+e.toBareUsage(c)+"]";else if(e.mandatory){const t=e.toBareUsage();u+=" "+t,e.annotation&&a.push("   "+t+": "+e.annotation)}else{d=!0;let t="   "+e.toBareUsage(c);e.annotation&&(t+=": "+e.annotation),void 0!==e.defaultValue?"boolean"!=typeof e.defaultValue&&(t+=" [DEFAULT: "+JSON.stringify(e.defaultValue)+"]"):void 0!==e.defaultText&&("symbol"!=typeof e.defaultText?t+=" [DEFAULT: "+JSON.stringify(e.defaultText)+"]":e.defaultText===Do&&("input"===e.key?t+=" [DEFAULT: _stdin_]":"output"===e.key?t+=" [DEFAULT: _stdout_]":t+=" [DEFAULT: _file topic_]")),a.push(t)}return d&&(i+=" [OPTION]..."),i+=u,i+=" "+l.getPostionalString(),{usage:i,summary:o,details:r,options:a,defaults:[],extraOptions:f}}(e,"$0"!==e.name?e.name:i);o=t.usage,r=t.summary?t.summary:"",l=t.defaults,a=[...t.details,...t.options],s=t.extraOptions}else({usage:o,summary:r,details:a,defaults:l}=await os(n));const p=a?Array.isArray(a)?a:[a]:[];let c;return Array.isArray(r)||(r=r?[r]:[]),c="gnu"===t?[`usage: ${o}`,...s?[`addtional options: ${s}`]:[],...r,...l,...p]:function(...e){const t=e[Symbol.iterator](),n=[...t.next().value];for(const e of t)e.length&&(n.push(""),n.push(...e));return n.push(""),n}([o],r,p,l,s?[`addtional options: ${s}`]:[]),c}});var ls=Object.freeze({__proto__:null,default:async function(e,t){const{name:n,args:i}=Fa(t),{main:o}=await jl(e,{shim:"IDL=1 cmd"});if("function"!=typeof o[n])throw new TypeError("Module's binding is missing");return await o[n].apply(void 0,await i)},js_hell:"IDL=1\n-- Import PACKAGE_NAME and use the js-hell syntax BINDING_TEXT to invoke a function. \ncall PACKAGE_NAME BINDING_TEXT :: default($packageName,$bindingText)"});var ps=Object.freeze({__proto__:null,default:function*(t,{lastModified:n=!0,size:i=!0,summary:o=!0,useColor:r=!0,dirs:a=!0,locale:s}={}){const l=new Intl.DateTimeFormat(s,{dateStyle:"short",timeStyle:"short"}),p="en-GB"===l.resolvedOptions().locale?e=>l.format(e).replace(",",""):e=>l.format(e),c=new Intl.NumberFormat,u=e=>c.format(e);let d=0,f=0;const m=r?`[${N.colors.whiteBright[0]}m`:"",h=r?`[${N.colors.gray[0]}m`:"",y=r?`[${N.colors.reset[0]}m`:"";for(const{size:o,webkitRelativePath:r,lastModified:s,isDirectory:l}of t){if(!a&&l)continue;let t=l?m:"";if(n&&(t+=p(s)+"\t"),i&&(t+=(l?" ":u(o))+"\t",d+=l?0:o),l)t+=r;else{const{dir:n,base:i}=e.parse(r);t+=`${h}${n}${n?e.sep:""}${y}${i}`}t+=y,yield t,++f}o&&(yield i?`Total: ${f} files; ${u(d)} bytes`:`Total: ${f} files`)},js_hell:'IDL=1\n    dir [(FILE|DIR)...] \n    :: default( \n        *( $1 ?? cwd.glob( "*", { exclude } ) ).map( f => ({f.size,f.lastModified,f.webkitRelativePath,f.isDirectory}) )\n        ,{\n            @option lastModified = true, \n            @option size = true, \n            @option summary = true, \n            useColor: @option color = true, \n            @option dirs = true,\n            locale: (@option(Str) locale) ?? undefined \n        }\n    ) as *String'});var cs=Object.freeze({__proto__:null,default:function*(e,t){for(const{name:n,data:i}of t){const t=i.toString().split(/\r?\n/);e:for(let i=0;i<t.length;++i){let o=0;for(;;){const r=t[i].indexOf(e,o);if(-1===r)continue e;yield`${n}:${i+1}.${r}:${t[i]}`,o=r+e.length}}}},js_hell:"IDL=1\n   -- Search for occurences of SEARCH_STR in FILE... \n   findstr SEARCH_STR FILE... :: default($searchStr, *$files.map( f => ({ name: f.webkitRelativePath, data: f.toText()}) )) as *String\n"});var us=Object.freeze({__proto__:null,default:async function(e){const t=await import(e);return Object.keys(t)},js_hell:"IDL=1\n-- List the exports in the ESM module MJS_FILE.\nOUTPUT_FORMAT=Enum\nget-exports MJS_FILE :: default($1.toURL())"});function ds(e,t){if("number"==typeof t){if(!Number.isInteger(t)||t<0)throw new TypeError("Numeric key must be an unsigned integer");if(!Array.isArray(e))throw new TypeError("Numeric key requires an array")}else{if("string"!=typeof t)throw new TypeError("`key` must be an unsigned integer or a string");if("object"!=typeof e||!e||Array.isArray(e))throw new TypeError("String key requires a non-null dictionary object")}}var fs=Object.freeze({__proto__:null,default:function(e,t,n){let i=e;for(let e=0;e<t.length-1;++e){const n=t[e];ds(i,n),i=i[n]}const o=t.at(-1);return ds(i,o),i[o]=n,e},js_hell:"IDL=1 json-set JSON_FILE KEY_NAME... JSON :: default( JSON_FILE.toJSON(), $2, $3) as JSON -> JSON_FILE"});var ms=Object.freeze({__proto__:null,default:function(e,t=255,{crypto:n=!1}){if(n){let n;if(255===t)n=new Uint8Array(e);else if(65535===t)n=new Uint16Array(e);else{if(4294967295!==t)throw new TypeError("Illegal maximum value for cryptograph random numbers");n=new Uint32Array(e)}return globalThis.crypto.getRandomValues(n),n}{const n=[];for(let i=0;i<e;++i)n.push(Math.trunc(Math.random()*t));return n}},js_hell:"IDL=1\n-- Generate COUNT random numbers between 0 and MAX_COUNT (inclusive; 0 <= x <= MAX_COUNT).\n-- MAX_COUNT defaults to 255 (i.e. bytes).\n\nrand \n    [--crypto] -- Use `crypto.getRandomValues()` instead of `Math.random()`; MAX_INT must be set for 8-, 16-, 32- or bit unsigned ints.  \n    [MAX_INT] \n    COUNT \n    :: default($2, $1 = 255, {crypto=false})\n"});var hs=Object.freeze({__proto__:null,default:function(e,t){return e.prepare(`SELECT ${t}`).all()},js_hell:"IDL=1 \n-- Run the SQL query `` `SELECT ${QUERY_TEXT}` `` on DATABASE_FILE.\n--  \n-- If DATABASE_FILE isn't a table, it will be converted to database with table name 'STDIN'; for example,\n-- `js-hell select --input=file.csv '\"FROM STDIN Name,sum( Amount ) AS Total GROUP BY Name ORDER BY Name\"'`\n-- \nselect [--input=DATABASE_FILE] QUERY_TEXT :: default( await input.database('STDIN'), $1 ) as JSON"});var ys=Object.freeze({__proto__:null,default:function(e,t){if("object"!=typeof e||Array.isArray(e))throw new Error("$1 must be a plain object (a 'dictionary')");return To.fromTemplateContents(t).exec(new Map(Object.entries(e)),{})},js_hell:"IDL=1\n    -- Treat TEMPLATE_FILE as a template literal and output it. \n    -- JSON|FILE is used to populate the global namespace (i.e. provides the execution context - like a `with` statement. \n    template \n        (JSON|FILE) \n        TEMPLATE_FILE  \n    :: default( $1, $2.toText() ) as String"});let vs=null;async function gs(e,t,n,i={}){const o=await e.importModule(),{idl:r}=e,a=r.createLexicalEnvironment(i);a.appendParsedOptions(r.parseOptions(function*(e,t){if(e.startsWith("/"))throw new TypeError("Illegal path");for(const[e,n]of t.entries())yield{type:jo,value:`--${e}`,info:Uo},yield{type:Oo,value:n,info:Ro};for(const t of e.split("/"))yield{type:So,value:t,info:Ro}}(t,n)));const s=a.finalise();return await r._exec1(o,s)}function ws(e){return"application/module+javascript"===e?"application/javascript":e}async function xs(e,t,i,o,{remoteDiagnostics:r=!1,sessionId:a,safeCall:s}){let l;try{l=await async function(e,t,i){if(i.startsWith("/"))throw new TypeError("Illegal path");const[o]=i.split("/",2);if(t.has(o)){if(!t.isWebSafe(o))throw new Error("Forbidden");return await t.getScriptlet(o)}const r=wn.fromString(n(e,i),{});if(r.isFile)return r;if(!r.isDirectory)return null;const a=wn.fromString(n(e,i,"index.html"),{});return a.isFile?a:null}(t,e,i)}catch(e){return console.error(e.message),{code:500,message:"Path resolution",content:r?e.stack:""}}if(!l)return{code:404,message:"Not found"};if(l instanceof Ha)return await async function(e,t,n,{remoteDiagnostics:i,sessionId:o,safeCall:r}){if(e.startsWith("/"))throw new TypeError("Illegal path");if(!await async function(e){return await e.importModule(),e.idl.getResultType().isScalar("JSON")}(t))return{code:403,message:"Scriptlet doesn't output JSON"};try{const i=await gs(t,e,n,{globalDefaults:gp({sessionId:o})});return{mimeType:"application/json",content:JSON.stringify(r?{success:!0,value:i}:i)}}catch(e){if("object"==typeof e&&e&&e.cause instanceof Error&&(e=e.cause),r)return{mimeType:"application/json",content:JSON.stringify({success:!1,value:i?e.stack:e.message})};console.error(e.message);let t="";return i&&(t=e.stack),{code:500,message:"Scriptlet exception",content:t}}}(i,l,o,{remoteDiagnostics:r,sessionId:a,safeCall:s});if(l.isFile){return{code:200,content:l.getContentAsBuffer(),mimeType:ws(l.type)}}return{code:403,message:"Forbidden"}}class bs{#me;constructor(e){for(const t of e.trim().split(/;\s*/g)){if(!t.includes("="))continue;const[e,n]=t.split("=",2);"uuid"===e.trimEnd()&&(this.#me=n)}}static fromRequest({cookie:e=""}){return new bs(e)}get(e){return"uuid"===e?this.#me:void 0}has(e){return void 0!==this.#me}}class Es{#he;#ye;constructor(e){this.#he=e,e=e.trimStart();const[t,n]=e.split(";",2);this.#ye=t.toLowerCase()}get essence(){return this.#ye}toString(){return this.#he}}const Ts="content-type";async function ks(e,t,n,i,{remoteDiagnostics:o,safeCall:r}){const{method:a,headers:s,url:l}=n,p=bs.fromRequest(s),c={},{uuid:u,state:d}=function(e,t){let n;if(e.has("uuid")){const t=e.get("uuid").trim();if(/^[a-fA-F0-9]{8}-[a-fA-F0-9]{4}-4[a-fA-F0-9]{3}-[a-fA-F0-9]{4}-[a-fA-F0-9]{12}$/.test(t))return{uuid:t,state:"="};n="!"}else n="+";const i=_();return t["Set-Cookie"]=`uuid=${i}; Max-Age=604800; SameSite=Strict; Path=/`,{uuid:i,state:n}}(p,c);let f=null;if("POST"===a){if(!Object.hasOwn(s,Ts))return console.log("webhost[%s%s]: received %s (no content type) %s",d,u,a,l),i.writeHead(400,"No Content-Type"),void i.end();const e=new Es(s[Ts]);if(console.log("webhost[%s%s]: received %s (%s) %s",d,u,a,e,l),"application/x-www-form-urlencoded"!==e.essence)return i.writeHead(500,"Post must be application/x-www-form-urlencoded"),void i.end();f=new URLSearchParams(await async function(e){let t="";for await(const n of e)t+=`${n}`;return t}(n))}else{if("GET"!==a)return console.log("webhost[%s%s]: received %s %s",d,u,a,l),i.writeHead(501,"Unsupported method"),void i.end();console.log("webhost[%s%s]: received %s %s",d,u,a,l)}const m=new URL(l,"https://dummyservername.internal"),h=m.pathname.slice(1);let y=m.searchParams;if(f)if(0===y.size)y=f;else for(const[e,t]of f.entries())y.append(e,t);const v=await xs(e,t,h,y,{remoteDiagnostics:o,sessionId:u,safeCall:r}),{code:g=200,message:w="OK",mimeType:x="text/plain",content:b=""}=v,E=Buffer.from(b);c["Content-Type"]=x,c["Content-Length"]=E.length,i.writeHead(g,w,c),i.end(E)}var Ss=Object.freeze({__proto__:null,default:async function({host:e="127.0.0.1",port:t=8111,cwd:i,remoteStacktrace:o=!1,abortOnInput:r=!0,usePackageJson:a=!0,safeCall:s=!1}={}){const l=r&&process.stdin.isTTY?(vs||(process.stdin.setRawMode(!0),vs=new Promise((e=>process.stdin.on("data",(t=>{vs=null,console.log("[abort]"),e("abort")}))))),vs):new Promise((()=>{}));console.warn("This is EXPERIMENTAL. Do NOT deploy in a production environment.");const u=new ml({builtins:!1});let d;if(a){const e=Us(`${i}`);if(!e)throw new Error("Couldn't find a `package.json` file");await u.addJsonPackageFromUrl(e,{recurse:!0}),d=p(c(e))}else await u.init(),d=n(`${i}`);console.info("webhost:",d),console.info("webhost: packages",u.packages().map((e=>e.name))),R.createServer(((e,t)=>ks(u,d,e,t,{remoteDiagnostics:o,safeCall:s}))).listen({host:e,port:t},((...n)=>{console.info("webhost: listening on %s:%d",e,t,n)})),await Promise.race([new Promise((e=>e)),l])},js_hell:'IDL=1\n-- The experimental web host (xwh).\n--\n-- This serves a package:\n--\n--  * Ordinary files are returned as is (provided they match the files key.)\n-- \n--  * js-hell scriptlets are executed as CGI.\n--\n--  See README.md for more info.\n-- \n HOST="0.0.0.0" PORT="8111"\n $0 \n    [--remote-stacktrace]     -- Output exceptions, etc... to scripts.\n    [--no-abort-on-input]     -- Don\'t listen on stdin and abort on any input.\n    [--no-package-json]       -- Serve files from the current directory without any CGI.\n    [--safe-call]             -- Use the safecall RPI format for all scriptlets. See docs. \n    [[HOST_STRING] PORT_INT]             \n::\n  default( {host:$1 = "127.0.0.1", port:$2 = 8111,cwd,remoteStacktrace,abortOnInput,usePackageJson:packageJson,safeCall} )'}),Os={name:"js-hell",version:"1.0.20250108",description:"JS CLI host",keywords:"cli shell","-- It's not importable, so skip main":"","-- main":"lib/host/main.mjs",directories:{lib:"lib"},devBin:{"js-hell-dev":"lib/bin/cli.mjs"},bin:"dist/js-hell.mjs","-- files: we don't need anything other than bin, plus README, LICENCE, and package.json; all of which are auto included.":"",files:[],scripts:{"test-debug":"node --no-warnings -- node_modules/jasmine/bin/jasmine.js --reporter=./test-data/specReporter.mjs",test:"npx jasmine","mimetype-extensions-make":"js-hell lib/utils/mimetype-extensions-make.mjs node_modules/mime-db/db.json --output=lib/utils/mimetype-extensions.json","make-dist":"rollup -c rollup.config.mjs"},js_hell:{jasmine:"API=1 jasmine :: default()"},author:"",license:"BSD-2-Clause",devDependencies:{"@rollup/plugin-json":"^6.1.0",jasmine:"^4.2.1","mime-db":"^1.52.0",terser:"^5.34.1"},optionalDependencies:{"better-sqlite3":"^10.0.0"}};var js=Object.freeze({__proto__:null,default:function(e){return e?void 0===e.version?"(undefined)":e.version:Os.version},js_hell:"IDL=1 \n\n-- Output the version of js-hell, or the version of SCRIPTLET if supplied.  \n\n$0 [SCRIPTLET] :: default($1 = null )"});const As=[{nodetype:"module",idl:"IDL=1 bitmask -- Return a bitmask of all the bit indices\n INT...     :: with() Math.bits( ...$1 )",moduleUrl:"about:blankjs#bitmask",module:void 0,version:"1.0.20250108"},{nodetype:"module",idl:"IDL=1 cat     -- Copy FILE to stdout                    \n (FILE|URL) :: with() await fetch($1).buffer() as Buffer",moduleUrl:"about:blankjs#cat",module:void 0,version:"1.0.20250108"},{nodetype:"module",idl:'IDL=1 OUTPUT_MIMETYPE="text/csv" csv -- Output a JSON table as CSV.\n [--input=JSON_FILE] :: with( toCSV,fromObjectArray ) toCSV( fromObjectArray( input.toJSON() ), { eol: EOL }  )',moduleUrl:"file:///z:/www/js-hell/lib/formatOutput.mjs#csv",module:$i,version:"1.0.20250108"},{nodetype:"module",idl:"IDL=1 psv -- Output a JSON table as pipe-separated variables - suitable for use as a markdown table\n [--input=JSON_FILE] :: with( toMarkdown,fromObjectArray ) toMarkdown( fromObjectArray( input.toJSON() ), { eol: EOL }  )",moduleUrl:"file:///z:/www/js-hell/lib/formatOutput.mjs#psv",module:$i,version:"1.0.20250108"},{nodetype:"module",idl:"IDL=1 echo TEXT... :: with() TEXT.join(' ') as String",moduleUrl:"about:blankjs#echo",module:void 0,version:"1.0.20250108"},{nodetype:"module",idl:"IDL=1 -- Echo an option value instead of a positional. (For testing.)\n echo-value --value=TEXT :: with() value as String",moduleUrl:"about:blankjs#echo-value",module:void 0,version:"1.0.20250108"},{nodetype:"module",idl:"IDL=1 -- Single argument version of echo. (Because lists can't contain expression.)\necho1 TEXT :: with() $1 as String",moduleUrl:"about:blankjs#echo1",module:void 0,version:"1.0.20250108"},{nodetype:"module",idl:"IDL=1 -- Used for testing: output the JSON\nOUTPUT_FORMAT=JSON0 echo-json JSON :: with() $1",moduleUrl:"about:blankjs#echo-json",module:void 0,version:"1.0.20250108"},{nodetype:"module",idl:["IDL=1","-- Fetch VAR_NAME from the lexical environemnt. For example `get cwd` or `get --output-format=JSON EOL`","get VAR_NAME :: with() $LEXICAL_ENVIRONMENT$.get(VAR_NAME)"],moduleUrl:"about:blankjs#get",module:void 0,version:"1.0.20250108"},{nodetype:"module",idl:"*",moduleUrl:"file:///z:/www/js-hell/lib/host/builtins/log.mjs",module:is,version:"1.0.20250108"},{nodetype:"module",idl:"IDL=1 product -- Product of all the numbers.            \n INT...     :: with() Math.product( ...$1 )",moduleUrl:"about:blankjs#product",module:void 0,version:"1.0.20250108"},{nodetype:"module",idl:"IDL=1 split -- Split text into chunks.              \n [--limit=COUNT] SPLIT_STRING TEXT :: with() $2.split( $1, limit ?? undefined)",moduleUrl:"about:blankjs#split",module:void 0,version:"1.0.20250108"},{nodetype:"module",idl:["IDL=1","shuffle           -- Randomise the order of a set of strings.","   [--seed=COUNT] -- The number seed. If ommitted, a random number will be picked.","   STRING...",":: with( )","    ( seed ?? Math.random32() )","    |> $1.map( text => ({text,hash:text.hash( % )}) )","    |> %.toSorted( ( a, b ) => Math.diff( a.hash, b.hash ) )","    |> %.map( a => a.text )"],moduleUrl:"about:blankjs#shuffle",module:void 0,version:"1.0.20250108"},{nodetype:"module",idl:"IDL=1 avg     -- Average of the list of numbers         \n [INT...]     :: with() Math.quotient( Math.sum( ...$1 ), $1.length )",moduleUrl:"about:blankjs#avg",module:void 0,version:"1.0.20250108"},{nodetype:"module",idl:"IDL=1 sum     -- Sum all the numbers.                   \n INT...     :: with() Math.sum( ...$1 )",moduleUrl:"about:blankjs#sum",module:void 0,version:"1.0.20250108"},{nodetype:"module",idl:"IDL=1 help    [SCRIPTLET] :: default($1.idl ?? null,{SCREEN_COLUMNS,externalName:$1.name ?? 'help'})",moduleUrl:"file:///z:/www/js-hell/lib/host/help.mjs",module:ss,version:"1.0.20250108"},{nodetype:"node:dep",idl:"IDL=1 cp      -- Reserved for future use.\n :: with() new Error( 'reserved for future use.' )",moduleUrl:"node:fs#cp",module:d,version:"1.0.20250108"},{nodetype:"module",idl:"*",moduleUrl:"file:///z:/www/js-hell/lib/host/builtins/call.mjs",module:ls,version:"1.0.20250108"},{nodetype:"module",idl:"*",moduleUrl:"file:///z:/www/js-hell/lib/host/builtins/dir.mjs",module:ps,version:"1.0.20250108"},{nodetype:"module",idl:"*",moduleUrl:"file:///z:/www/js-hell/lib/host/builtins/findstr.mjs",module:cs,version:"1.0.20250108"},{nodetype:"module",idl:"IDL=1 false :: with () false",moduleUrl:"about:blankjs#false",module:void 0,version:"1.0.20250108"},{nodetype:"module",idl:"*",moduleUrl:"file:///z:/www/js-hell/lib/host/builtins/get-exports.mjs",module:us,version:"1.0.20250108"},{nodetype:"module",idl:["IDL=1","-- Parse a JSON file and output it _as_ JSON.","-- ","-- For example `json somefile.json --output-format=psv` will turn it into a markdown table.","json JSON_FILE :: with( ) $1.toJSON() as JSON"],moduleUrl:"about:blankjs#json",module:void 0,version:"1.0.20250108"},{nodetype:"module",idl:"*",moduleUrl:"file:///z:/www/js-hell/lib/host/builtins/json-set.mjs",module:fs,version:"1.0.20250108"},{nodetype:"module",idl:"*",moduleUrl:"file:///z:/www/js-hell/lib/host/builtins/rand.mjs",module:ms,version:"1.0.20250108"},{nodetype:"module",idl:["IDL=1","resolve     -- Run the scriplet resolver on SCRIPTLET and return the URL of the ESM module that will be used.","    [--idl] -- Return the IDL instead of the MODULE_URL.","     SCRIPTLET","     :: with() $1[idl ? 'idl' : 'moduleUrl'].toString()"],moduleUrl:"about:blankjs#resolve",module:void 0,version:"1.0.20250108"},{nodetype:"module",idl:"*",moduleUrl:"file:///z:/www/js-hell/lib/host/builtins/select.mjs",module:hs,version:"1.0.20250108"},{nodetype:"module",idl:"IDL=1 spawn -- Reserved for future use.\n:: with() new Error( 'Reserved for future use.')",moduleUrl:"about:blankjs#spawn",module:void 0,version:"1.0.20250108"},{nodetype:"module",idl:"IDL=1 true :: with () true",moduleUrl:"about:blankjs#true",module:void 0,version:"1.0.20250108"},{nodetype:"module",idl:"*",moduleUrl:"file:///z:/www/js-hell/lib/host/builtins/template.mjs",module:ys,version:"1.0.20250108"},{nodetype:"module",idl:"IDL=1 zeroes [BYTE_COUNT] :: with() Buffer.alloc( $1 = 0 ) as Buffer",moduleUrl:"about:blankjs#zeroes",module:void 0,version:"1.0.20250108"},{nodetype:"module",idl:["IDL=1","-- Move up through the directory tree and return the first directory conaining FILE_NAME.","-- ","-- ### Example","-- ```","-- js-hell get-projectdir package.json","-- ```","get-projectdir","     [--relative] -- Return a relative path, instead of an absolute one.","     FILE_NAME ",":: default($fileName,cwd.toString(),{relative=false}) as Dirname"],moduleUrl:"file:///z:/www/js-hell/lib/host/getProjectdir.mjs#get-projectdir",module:Ya,version:"1.0.20250108"},{nodetype:"module",idl:["IDL=1","-- Split STRING into individual arguments using js-hell's internal tokeniser.","-- (This can be useful for seeing how js-hell is interpreting arguments or will call","-- an external command.)","--","-- Arguments are separated by spaces (any codepoint matching /\\s/)","-- and by the specials `!?$%^=@#~()[]{}<>&|,;`'\"`.","--","-- Empty strings, and strings containing spaces or special characters can be quoted","-- with single or double quotes (\"\" or '').","--","-- There in no escaping: quotes run through to next occurence of the quote character.","-- (This means you can't use strings that contain both `\"` and `'`. It's for Windows","-- filenames - the plan is to add `` quoting with escaping.)","--","-- Quotes can only happen at the start of a token (or the start of an option's",'-- value). So `some" "thing` is NOT permitted - it has to be `"some thing"`. (But','-- `--char=" "` is fine to specify a space.)',"","argtok STRING :: shfy($string) as JSON"],moduleUrl:"file:///z:/www/js-hell/lib/args/argtok.mjs",module:Go,version:"1.0.20250108"},{nodetype:"module",idl:["IDL=1","-- List the names and aliases in the type registry","idl-types :: list()"],moduleUrl:"file:///z:/www/js-hell/lib/types/registry.mjs#idl-types",module:Wn,version:"1.0.20250108"},{nodetype:"module",idl:"IDL=1 repl -- Reserved for future use.\n:: with() new Error( 'Reserved for future use.' )",moduleUrl:"about:blankjs#repl",module:void 0,version:"1.0.20250108"},{nodetype:"module",idl:"IDL=1 rm -- Reserved for future use.\n:: with() new Error( 'Reserved for future use.' )",moduleUrl:"about:blankjs#rm",module:void 0,version:"1.0.20250108"},{nodetype:"module",idl:"IDL=1 run -- Reserved for future use.\n:: with() new Error( 'Reserved for future use.' )",moduleUrl:"about:blankjs#run",module:void 0,version:"1.0.20250108"},{nodetype:"node:dep",idl:"IDL=1 uuid -- Output a random UUID (i.e. wraps `crypto.getRandomUUID()`)\n:: randomUUID()",moduleUrl:"node:crypto#uuid",module:L,version:"1.0.20250108"},{nodetype:"module",idl:"*",moduleUrl:"file:///z:/www/js-hell/lib/webhost/server.mjs#xwh",module:Ss,version:"1.0.20250108"},{nodetype:"module",idl:"*",moduleUrl:"file:///z:/www/js-hell/lib/host/version.mjs",module:js,version:"1.0.20250108"},{nodetype:"module",idl:"*",moduleUrl:"file:///z:/www/js-hell/lib/host/version.mjs#ver",module:js,version:"1.0.20250108"}];let Ns=0;class Is{#ve;#ge;default;constructor(e,{startupDir:t}={}){this.#ve=e,this.#ge=t,this.default=()=>this.exec()}async exec(){const e=++Ns;console.log("[!%d] %s>%s",e,this.#ge,this.#ve);const{shell:t}=fn(),n=await t.execJob(["node","js-hell",this.#ve],{startupDir:this.#ge});return console.log("[!%d] exited (%d)",e,n),0===n}toScriptlet(e){return Ha.from(`IDL=1 -- Execute the script:\n--\n-- >${JSON.stringify(this.#ve).slice(1,-1)}\n${e} :: default()`,`script:${this.#ve}`,this,e)}}const $s=new URL("./builtins.json",import.meta.url),Ls="root-package";function _s(e){return Object.keys("object"==typeof e&&e?e:{})}async function Rs(e){try{return"file:"===new URL(e).protocol?JSON.parse(m(c(e),"utf8")):(await import(e,{with:{type:"json"}})).default}catch(e){return}}function Us(t){const n=Za("package.json",t,{relative:!1});return n?u(e.join(n,"package.json")):""}function Ms(e,t){return"string"!=typeof e.main?null:new URL(e.main,t)}function Cs(e){const t=`${e}`.trimStart();return t.startsWith("js-hell ")?t:""}function Ps(e){return"object"==typeof e[Ka]?e[Ka]:"object"==typeof e[Wa]?e[Wa]:null}function Ds(e){return Array.isArray(e)&&(e=e.join("\n")),"string"==typeof e&&"*"===(e=e.trim())}function zs(e){return"object"==typeof e&&e&&!Array.isArray(e)}const Fs="root",Bs="module",Js="ignore",Vs="node:dep",qs="child-package",Ws="nodep",Ks="nested",Gs="about:",Xs="blankjs",Hs=`${Gs}${Xs}`,Zs=Fs,Ys=Bs,Qs="script",el="shim",tl="js-hell:builtin";function nl(e,t,n){e.has(t)||e.set(t,n)}class il{name;type;baseUrl;value;source;constructor({name:e,type:t,baseUrl:n,value:i,source:o}){Object.assign(this,{name:e,type:t,baseUrl:n,value:i,source:o})}isRunnable(){return!1}toScriptlet(){throw new TypeError("Not runnable!")}}class ol{name;type;baseUrl;value;source;constructor(e,{name:t=e.name,baseUrl:n=e.moduleUrl,type:i=Ys,source:o}={}){Object.assign(this,{name:t,type:i,value:e,source:o})}isRunnable(){return!0}toScriptlet(){return this.value}}class rl{#we;#xe;#se;name;type;baseUrl;value;source;constructor({name:e,type:t,baseUrl:n,value:i,source:o}){Object.assign(this,{name:e,type:t,value:i,source:o}),this.#we=n}async resolveJson(){if(void 0!==this.#xe)return;const e=await Rs(this.#we);if(e.name!==this.name)throw new TypeError("Package name doesn't match name under which it was loaded");if(this.#se=Ms(e,this.#we),!this.#se)throw new TypeError(U`Package ${this.name} is not executable (missing or invalid "main" key in package.json)`);if(this.type===el){if(Ps(e))throw new TypeError(U`Package ${this.name} cannot be overridden with a shim as it has a js-hell descriptor`)}else this.value=Ps(e);this.#xe=e}async isRunnable(){try{return await this.resolveJson(),!!this.value}catch(e){return!1}}async toScriptlet(){return await this.resolveJson(),new Ha(this.value,{module:void 0,moduleUrl:this.#se})}}function al(t,n,i){const o=e.dirname(c(i));return new Is(n,{startupDir:o}).toScriptlet(t)}const sl=new Set,ll=Symbol(Ls);function pl(e,t=!1,n){const i={};if("object"!=typeof e||Array.isArray(e))return sl.has(n)||(console.warn("warning: missing or malformed package list %s",n),sl.add(n)),i;const o=function(e){const t=Object.hasOwn(e,Wa);if(Object.hasOwn(e,Ka)){if(t)throw new TypeError(`package cannot have both ${Ka} and ${Wa} keys`);return Ka}return t?Wa:""}(e);if(o){const t=e[o];if("object"==typeof t){if(null===t)throw new TypeError(`invalid ${o} entry in package.json: null`);if(!Array.isArray(t))return t}const n=e.name;if("string"!=typeof n)throw new TypeError(`if idl is used ${o} the package must have a name`);i[n]=t,i[ll]=n}if(t){for(const t of _s(e.dependencies))Object.hasOwn(i,t)||(i[t]="*");for(const t of _s(e.devDependencies))Object.hasOwn(i,t)||(i[t]="*")}return i}function cl(e,t){return null!=e&&Object.hasOwn(e,t)}function ul(e,t,n){if(e.startsWith("./")){const t=new URL(e,n);return function(e){"file:"!=typeof e.protocol||new URL(e.pathname,"file:")}(t),{type:Bs,url:t,name:void 0}}if(e.startsWith("node:"))return{type:Vs,url:new URL(e),name:void 0};if(e.startsWith("#"))return{type:Bs,url:new URL(e,Hs),name:void 0};if(e.startsWith("about:")){const t=new URL(e);if("blankjs"===t.pathname)return console.assert("about:blankjs"===Hs,"The code is broken: it assumes `about:blankjs` is BLANKMODULE_URL"),{type:Bs,url:t,name:void 0}}if(e.startsWith("--"))return{type:Js,url:e,name:void 0};if(e===t.name)return{type:Fs,url:Ms(t,n),name:e};if(cl(t.dependencies,e)||cl(t.devDependencies,e)){const t=new URL(`./node_modules/${e}/package.json`,n);return{type:qs,url:t,name:void 0}}return{type:Ws,url:e,name:void 0}}function dl({protocol:e,pathname:t}){return e===Gs&&t===Xs}async function fl(e,t,n){const i=t;t===tl&&(t=$s);const{version:o}=n,r=[];for(const{type:a,url:s,name:l,idl:p,key:c}of function*(e,t,n){for(const[i,o]of Object.entries(e)){let{type:e,url:r,name:a}=ul(i,n,t);if(e===Bs&&dl(r)&&zs(o))e=Ks,a=r.hash.slice(1);else if("string"!=typeof o&&!Array.isArray(o))throw new Error(U`Invalid IDL for entry ${i}: it must be a string`);yield{type:e,url:r,name:a,idl:o,key:i}}}(e,t,n))if(a!==Js)if(a===Ks){const e=await fl(p,t,n);if(0===e.length)throw new Error(U`No sub commands for ${s}`);const o=await Promise.all(e.map((e=>e.toScriptlet())));r.push(await es.fromScriptlets(o,{name:l,source:i}))}else if(a===Ws)console.error("missing dependency: %s",s,t);else if(a===qs)if(console.assert(void 0===l,"name shouldn't be defined here"),Ds(p)){const e=new ml;if(await e.addJsonPackageFromUrl(s,{recurse:!1}),e.hasTrueRootScriptlet()){const t=await e.getTrueRootScriptlet();r.push(new ol(t,{type:a,source:i}))}else e.getOwnScriptletEntries(s).length&&r.push(es.fromPackageTree(e,{url:s,name:c}))}else zs(p)?console.error("%s: nested IDL not supported here",c):r.push(new rl({name:c,type:el,baseUrl:s,value:p,source:i}));else if(a===Fs){const e=new Ha(p,{moduleUrl:s,name:l,version:o}),t=new ol(e,{type:Zs,source:i});r.push(t);const n=Object.create(t,Object.getOwnPropertyDescriptors({name:Ls,isRunnable(){return Object.getPrototypeOf(this).isRunnable()},toScriptlet(){return Object.getPrototypeOf(this).toScriptlet()}}));r.push(n)}else if(a===Vs){if(Ds(p)){console.error("%s: cannot use '*' as the IDL",c);continue}if(zs(p)){console.error("%s: cannot use a nested IDL key for a `node:` module",c);continue}const e=new Ha(p,{moduleUrl:s,version:o});r.push(new ol(e,{type:a,source:i}))}else{if(a!==Bs)throw new Error(U`Unknown node type \`${a}\``);if(zs(p))console.error("%s: nested IDL not supported here",c);else{const e=new Ha(p,{moduleUrl:s,version:o});r.push(new ol(e,{type:a,source:i}))}}return r}class ml{#be;#Ee;constructor({builtins:e=!0}={}){this.#Ee=e}async init(){if(this.#be)return;if(this.#be=new Map,!this.#Ee)return;if(Array.isArray(As))for(const{nodetype:e,idl:t,moduleUrl:n,module:i,version:o}of As)this.addScriptlet(e,new Ha(t,{moduleUrl:n,module:i,version:o}),tl);else await this.addScriptletList(As,tl,Os);const e=new Ha(ts,{module:ns,name:"js-hell"});e.idl.addTail(),this.addScriptlet(Ys,e,tl)}async addJsonPackageFromUrl(e,{recurse:t=!1}){if(!e)throw new Error("No package url");await this.init(),await async function(e,t,{recurse:n=!1}){const i=t.toString(),o=await Rs(i),r=pl(o,n,i);await e.addScriptletList(r,t,o),n&&o?.scripts&&e.addScriptNodes(o.scripts,t)}(this,e,{recurse:t})}async addCwdPackageTree(e="."){const t=function(e="."){return Us(e)}(e=`${e}`);t?await this.addJsonPackageFromUrl(t,{recurse:!0}):await this.init()}has(e){return this.#be.has(e)}isWebSafe(e){const t=this.#be.get(e);return(t.type===Ys||type===el)&&t.source!==tl||(console.log("not websafe?",t.type,t.source),!1)}static isNonShim(e){return null==e||""!==e||"*"!==e}async getScriptlet(e,t){if(!ml.isNonShim(t))throw new TypeError("No shims!");return this.#be.get(e).toScriptlet()}hasTrueRootScriptlet(){return this.#be.has(Ls)}getTrueRootScriptlet(e){return this.getScriptlet(Ls,e)}getCompositeRootScriptlet(e,{url:t,name:n}={}){if(this.hasTrueRootScriptlet())return this.getTrueRootScriptlet(e);if(!ml.isNonShim(e))throw new TypeError("No shims!");return es.fromPackageTree(this,{url:t,name:n}).toScriptlet()}async addScriptletList(e,t,n={}){const i=await fl(e,t,n),o=this.#be;for(const e of i)nl(o,e.name,e)}addScriptNodes(e,t){const n=this.#be;for(const[o,r]of(i=e,Object.entries("object"==typeof i&&i?i:{}))){const e=Cs(r);nl(n,o,e?new ol(al(o,e,t),{type:"js-hell script"},this):new il({name:o,type:Qs,baseUrl:t,value:{scriptText:r}},this))}var i}addScriptlet(e,t,n){const i=new ol(t,{type:e,source:n},this);return nl(this.#be,i.name,i),i}packages(){return Array.from(this.#be.values()).filter((e=>!!e))}getOwnScriptletEntries(e){return e=e.toString(),Array.from(this.#be.values()).flatMap((t=>t?t.type!==Ys&&"catalogue"!==t.type||t.source.toString()!==e?[]:[[t.name,t.value]]:[]))}}const hl="json_url",yl="script_url";async function vl(e,t){e=`${e}`;const n=await import(e);if(Object.hasOwn(n,"js_hell")){if("number"!=typeof n.js_hell)return Ha.from(n.js_hell,e,n);console.error("invalid module (numeric js_hell key)",e)}if(t)return Ha.from(t,e,n);throw new TypeError(`Incompatible module (missing or invalid "js_hell" export in module ${JSON.stringify(e)})`)}async function gl(e,t){const{type:n,filename:o}=function(e){const t=z(e);if(t===C){const t=s(e,"package.json");if(z(t)!==P)throw new Error(`missing ${t}`);return{type:hl,filename:t}}if(t===D)throw new Error(U`no FILE ${e}`);if(t!==P)throw new Error(U`cannot read ${e}`);if(e.endsWith(".mjs")||e.endsWith(".js"))return{type:yl,filename:e};if(e.endsWith(".json"))return{type:hl,filename:e};throw new Error(U`cannot process file ${e}`)}(e),r=u(o);if(n===yl)return vl(r,t);if(n===hl){const n=new ml;return await n.addJsonPackageFromUrl(r,{recurse:!1}),n.getCompositeRootScriptlet(t,{url:r,name:i(e)})}throw new Error(U`Unknown file type ${n}`)}const wl=/^(?:https?|file):/,xl=/^(?:\.?[/\\]|[A-Za-z]:)/,bl=/[.\\/]/,El="file",Tl="url",kl="file-or-package",Sl="package";async function Ol(e="help",{shim:t="",cwd:n}){const i=function(e){return wl.test(e)?Tl:xl.test(e)?El:!e.startsWith("@")&&bl.test(e)?kl:Sl}(e);if(i===El)return gl(e,t);if(i===Tl)return async function(e,t){return vl(e,t)}(e,t);const o=new ml;if(await o.addCwdPackageTree(n),"--help"!==e&&"-h"!==e||(e="help"),o.has(e))return o.getScriptlet(e,t);if(i===kl)return gl(e,t);if(i!==Sl)throw new TypeError(U`Unknown package type ${i}`);throw new Error(U`no PACKAGE ${e}`)}async function jl(e,{shim:t,cwd:n}={}){const i=await Ol(e,{shim:t,cwd:n});return await i.importModule(),i}const Al=globalThis.fetch;function Nl(e){return new Response(e,{status:200,statusText:"OK"})}function Il(e,t){if(Buffer.isBuffer(e))return Nl(e);const n=new URL(e);return"file:"===n.protocol.toLowerCase()?Nl(m(c(n))):Al(e,t)}Il[te]=Il;const{abs:$l,ceil:Ll,clz32:_l,floor:Rl,imul:Ul,log2:Ml,max:Cl,min:Pl,pow:Dl,random:zl,round:Fl,sign:Bl,trunc:Jl}=Math;var Vl=Object.freeze({__proto__:null,abs:$l,bits:function(...e){let t=0;for(const n of e)t|=1<<n;return t},ceil:Ll,clz32:_l,diff:(e,t)=>e-t,div:(e,t)=>e/t,equal:(e,t)=>Number(e)===Number(t),floor:Rl,imul:Ul,log2:Ml,max:Cl,min:Pl,neg:e=>-e,percent:e=>e/100,pow:Dl,product:function(...e){let t=1;for(const n of e)t*=n;return t},quotient:(e,t)=>e/t,random:zl,random32:()=>4294967295*Math.random()>>>0,reciprocal:e=>1/e,round:Fl,sign:Bl,sum:function(...e){let t=0;for(const n of e)t+=Number(n);return t},trunc:Jl}),ql=Object.freeze({__proto__:null,basename:i,dirname:p,extname:o});const{styleText:Wl=(e,t)=>t}=A,Kl=e=>process.stdout.write(Wl(["bold"],e));function Gl(){if(!process.stdout.isTTY||!process.stdin.isTTY)throw new Error("Cannot readline (not a terminal)")}function Xl(){const e=Buffer.alloc(1);process.stdin.setRawMode(!1);let t="";for(;E(process.stdin.fd,e),13!==e[0];)t+=e.toString();return t}var Hl=Object.freeze({__proto__:null,alert:function(e="Press any key..."){Gl(),Kl(e);const t=Buffer.alloc(1);process.stdin.setRawMode(!0),E(process.stdin.fd,t),process.stdout.write("\r\n")},confirm:function(e){Gl(),Kl(e+" [Y]es/[N]o? ");const t=Xl();return process.stdout.write("\r\n"),t.trimStart().toLowerCase().startsWith("y")},prompt:function(e="Enter a value:",t){return Gl(),e.trimEnd()===e&&(e+=" "),Kl(e),Xl()}});class Zl{#d;setValueAsBuffer(e){this.#d=e}getContentAsBuffer(){return this.#d}}function Yl(e,t,n,i){new zi(e,n,t).setValue(i)}function Ql(e,t,n){const i=Ii(t,e,n),o=new wn("stdin","/dev",void 0,i,(()=>{const i=new Zl;return Yl(i,e,t,n),i.getContentAsBuffer()}));return Ii===Ni?(o.toText=()=>n,o.text=async()=>n):Ii===Ai&&(o.toText=()=>JSON.stringify(n),o.text=async()=>JSON.stringify(n)),o.json=async()=>n,o.toJSON=()=>n,o}const ep="Statement",tp="value",np=!1,ip=!0;class op{type=ep;cwdForResolveScriptlet;argv;scriptletName;scriptlet;module;usage;pipeTail;stacktrace;inspect;logfile;cwd;optionEntries;constructor(e,{cwdForResolveScriptlet:t,stacktrace:n,inspect:i,pipeTail:o}){Object.assign(this,{cwdForResolveScriptlet:t,scriptletName:e[0].value,argv:e,stacktrace:n,inspect:i,pipeTail:o})}async resolveScriptlet(){if(this.argv[0].type!==So)throw new Error("Internal error ($0 should be a literal)");this.scriptletName=this.argv[0].value;const e=await jl(this.scriptletName),t=await e.importModule(),n=e.idl.getOptionConflicts(rs);if(n.size)throw new TypeError(U`scriptlet ${this.scriptletName} cannot use options `+Array.from(n).map((e=>JSON.stringify(e))).join(" "));const i=e.idl.getUsage(rs,as);this.scriptlet=e,this.argv[0].value=e.name,this.module=t,this.usage=i}resolveOptions(){const{argv:e,usage:t}=this,n=[];let i,o,{stacktrace:r,inspect:a}=this;for(const s of t.parseOptions(e)){const{key:e,value:t,source:l}=s;"cwd"===e?i=t:"log"===e?o=t:"stacktrace"===e?l!==ua&&(r=t):"inspect"===e?l!==ua&&(a=t):n.push(s)}Object.assign(this,{optionEntries:n,cwd:i,stacktrace:r,inspect:a,logfile:o})}async exec(e,t=!1,n=null){if(![tp,np,ip].includes(t))throw new TypeError("Invalid value for capture");const{scriptlet:i,argv:o,pipeTail:r,optionEntries:a}=this,{idl:s}=i,l=s.createLexicalEnvironment(e);if(l.setFileTopic(n),l.appendParsedOptions(a),r&&!l.usesFileTopic())throw new TypeError(U`cannot pipe to ${this.scriptletName}`);const p=l.finalise(),c=function(e){const{outputFormat:t,outputTextEncoding:n="utf8",outputMimetype:i,EOL:o=("win32"===process.platform?"\r\n":"\n"),SCREEN_COLUMNS:r=80,output:a}=e;return{output:a,format:t,EOL:o,screenColumns:r,textEncoding:n,mimetype:i}}(p),u=this.getResultType(),d=!(c.output instanceof _a);if(!s.canGuaranteeNoOuput()&&t!==np&&t!==tp&&d)throw new TypeError("cannot use `--output` inside a pipe");if(void 0!==c.format&&t===tp)throw new TypeError("cannot use --output-format in a subshell (pipe and format)");let f;try{f=await s._exec1(this.module,p,e)}catch(e){if("ScriptletError"!==e.name||void 0===e.cause)throw e;return{success:!1,value:e.cause}}if("boolean"==typeof f&&void 0===c.format){if(d)throw new TypeError("cannot save boolean output");if(t!==np&&t!==tp)throw new TypeError("cannot pipe boolean output to a command");return{success:!0,value:f}}if(null==f){if(d)throw new TypeError("Command has no output to save");if(t!==np&&t!==tp)throw new TypeError("cannot pipe command as it has no output");return{success:!0,value:f}}if(t===np)return function(e,t,n){Yl(e.output,e,t,n)}(c,u,f),{success:!0,value:void 0};if(t===tp)return{success:!0,value:f};if(t===ip)return{success:!0,value:Ql(c,u,f)};throw new Error("Illegal value for `capture`")}error(e){this.stacktrace?console.error("%s: %s",this.scriptletName,e.stack):console.error("%s: %s",this.scriptletName,e.message)}howIsInputConsumed(){const e=this.scriptlet.idl.inputUsedWithMethodCall();return e&&1===e.size?e.values().next().value:""}getResultType(){return this.scriptlet.idl.getResultType()}static get type(){return ep}}const rp="operator",ap=["&&","|",...Object.keys(as)];function sp({value:e}){if(!ap.includes(e))throw new Error(`Unsupported operator '${e}'`);return!Object.hasOwn(as,e)}class lp{type=rp;operator;lhs;rhs;constructor(e,t,n){this.operator=t,this.lhs=e,this.rhs=n}}const pp="[2K";class cp extends ${#Te;#ke;#Se;#Oe="";#je="";#Ae="";#Ne="";#Ie(){""!==this.#Ne&&this.#Te.write(pp)}#$e(){""!==this.#Ne&&this.#Te.write(this.#Ne)}constructor(e,t=0,{colorMode:n}={}){super({stdout:e,colorMode:n}),this.#ke=t,this.#Se=!!e.isTTY,this.#Te=e}debug(...e){this.#ke>=1&&(super.debug(...e),this.#Oe="debug")}error(...e){this.#ke>=-2&&(this.#Ie(),super.error(...e),this.#$e(),this.#Oe="error")}info(...e){this.#ke>=0&&(this.#Ie(),super.info(...e),this.#$e(),this.#Oe="info")}log(...e){this.#ke>=0&&(this.#Ie(),super.log(...e),this.#$e(),this.#Oe="log")}warn(...e){this.#ke>=-1&&(this.#Ie(),super.warn(...e),this.#$e(),this.#Oe="warn")}count(e="default"){this.#Se&&"count"===this.#Oe&&this.#je===e&&this.#Te.write("M"),super.count(e),this.#Oe="count",this.#je=e}countReset(e="default"){this.#Se&&"count"===this.#Oe&&this.#je===e&&this.#Te.write("M"+pp)}status(e,...t){if(!this.#Se)return;this.#Ae=I({color:!0,breakLength:1/0,compact:1/0},e,...t);const n="number"==typeof this.#Te.columns?this.#Te.columns:80;this.#Ne=this.#Ae.slice(0,n-1)+"\r",this.#Te.write(pp+this.#Ne)}statusClear(){this.#Se&&""!==this.#Ne&&(this.#Te.write(pp),this.#Ae="",this.#Ne="")}statusFlush(){""!==this.#Ne&&(this.#Se?this.#Te.write("\n"):this.#Te.write(this.#Ae+"\n"),this.#Ae="",this.#Ne="")}}class up{#Le;get shell(){return this.#Le}#_e;#Re;get console(){return this.#Re}lexicalEnvironmentOptions;#Ue=null;constructor(e,t={},n=e.console){this.#Le=e,this.#Re=n,this.lexicalEnvironmentOptions=t}async openLog(e){if(!e)return;if(void 0!==this.#_e)throw new Error("Job cannot have multiple log files");const t=this.#_e=T(e);await new Promise((e=>t.once("open",e))),this.#_e=t,this.#Re=new cp(t,0,{colorMode:!1})}async flushStatusAndCloseLog(){if(this.#Re.statusFlush?.(),void 0===this.#_e)return;const e=this.#_e;this.#_e=void 0,this.#Re=this.#Le.console;const t=new Promise((t=>e.once("close",(()=>t()))));e.close(),await t}registerCleanup(e){if("function"!=typeof e)throw new Error("Callback must be a function");this.#Ue||(this.#Ue=[]),this.#Ue.push(e)}finalise({stacktrace:e=!1}={}){const t=this.#Ue;if(t){this.#Ue=null;for(let n=t.length;n--;){const i=t[n];try{i()}catch(t){this.#Re.error("cleanup:",e?t.stack:t.message)}}}}hasFinalisation(){return!!this.#Ue?.length}}let dp;class fp extends Error{constructor(...e){super(...e)}static name="VersionError";get name(){return fp.name}}const mp=new Map([["--help","help"],["-h","help"],["/?","help"],["--version","version"],["-v","version"]]);function hp(e,{stacktrace:t=!1,inspect:n=!1,reparse:i=!1,head:o=!0,pipeTail:r=!1,jsHellAllowed:a=!1,versionAllowed:s=!1}={}){if(!0!==a)throw new TypeError("`js-hell` should always be a valid initial token");const l=[];let p,c="",u=!1,d=!1,f=null;const m=fa.fromOptionsOnly("\n[--stacktrace]\n[--inspect]\n[(--cwd|-C)=DIR]\n[(--help|-h)] \n[(--version|-v)] \n");let h;for(const o of m.rawParse(function*(){for(let t=!0;;t=!1){const{value:n,done:o}=e.next();if(o)return void(u=!0);if(a&&n.type===So&&"js-hell"===n.value)i=!0,s=!0;else{if(n.type!==Ao)h=n;else{if(t)throw new Error(`Operator '${n.value}' not allowed as first argument`);if(sp(n)){c=n.value;break}}yield n}}}())){if(""===o.key){if(void 0===h)throw console.log(o),new Error("Internal parse error");l.push(h);break}if("stacktrace"===o.key)t=!0;else if("inspect"===o.key)n=!0;else if(mp.has(o.optionName)){if(f)throw new Error("Multiple redirects");const e=mp.get(o.optionName);l.unshift({type:So,value:e,info:Ro}),f=e}else{if("cwd"!==o.key)throw new Error("Intenal error - unknown option should have been caught");p=o.value}}for(;;){const{value:t,done:n}=e.next();if(n){u=!0;break}if(t.type===jo)if(mp.has(t.value)){if(t.info===Uo&&(console.warn(`${t.value} doesn't take an argument`),d=!0),f)throw new Error("Multiple redirects");{const e=mp.get(t.value);l.unshift({type:So,value:e,info:Ro}),f=e}}else l.push(t);else if(t.type===Ao){if(d)throw new Error("Reached unreachable state");if(sp(t)){c=t.value;break}l.push(t)}else d?d=!1:l.push(t)}if(u&&i&&!c&&1===l.length&&l[0].type===So&&void 0===p){let e=l[0].value;if(s&&e.startsWith("CLI=")){const t=new ee(e,{pos:4}),n=Oa(t);if(1!==n.major||0!==n.minor)throw new fp(`Unsupported CLI version (${n.text})`);e=t.tail()}return hp(Vo(e),{stacktrace:t,inspect:n,jsHellAllowed:!0})}if(0===l.length){if(!o||c)throw new Error("expected scriptlet name");l.push({type:So,value:"help"})}if(l[0].type!==So)throw new Error("expected scriptlet name");const y=new op(l,{cwdForResolveScriptlet:p,stacktrace:t,inspect:n,pipeTail:r});if(!c)return y;if(u)throw new Error("expected command");return new lp(y,c,hp(e,{head:!1,pipeTail:"|"===c,jsHellAllowed:!0}))}class yp{#Me;#Ce;lastJoin="";nextJoin="";constructor(e){this.#Ce=e}next(e){const t=this.#Ce;if(null===t)return{node:t,pipeTail:!1,pipeHead:!1};if(this.lastJoin=this.nextJoin,"&&"===this.lastJoin&&!1===e)return{node:this.#Ce=null,pipeTail:!1,pipeHead:!1};const n="|"===this.lastJoin;if(t.type===ep)return this.nextJoin="",this.#Ce=null,{node:t,pipeTail:n,pipeHead:!1};if(t.type===rp){if(this.nextJoin=t.operator,t.lhs.type===ep)return this.#Ce=t.rhs,{node:t.lhs,pipeTail:n,pipeHead:"|"===this.nextJoin};throw new TypeError("Invalid CliNode tree")}throw new TypeError("Invalid CliNode type")}}const vp="00000000-0000-0000-0000-000000000000";function gp({stdout:e,EOL:t=("win32"===process.platform?"\r\n":"\n"),sessionId:n=vp,env:i=process.env}={}){return{EOL:t,SCREEN_COLUMNS:e?.columns??80,expandGlobs:!0,fetch:Il,...ql,Buffer:Buffer,Math:Vl,Uint8Array:Uint8Array,console:console,...Hl,env:i,sessionId:n}}class wp{pwd;chdir;stdout;stdin;stderr;console;EOL;constructor({platform:e=process.platform,cwd:t=process.cwd,chdir:n=process.chdir,stdin:i=process.stdin,stdout:o=process.stdout,stderr:r=process.stderr,console:a=new cp(r,0,{colorMode:"auto"}),EOL:s=("win32"===e?"\r\n":"\n")}=process){Object.assign(this,{pwd:t,chdir:n,stdout:o,stdin:i,stderr:r,console:a,EOL:s})}async execJob(e,{capture:t,startupDir:n=this.pwd()}){const{pwd:i,chdir:o,stdin:r,stdout:a,stderr:s,EOL:l}=this;let p=!0;const{alert:c,prompt:u,confirm:d}=Hl;Object.assign(globalThis,{alert:c,prompt:u,confirm:d});const f=vp;try{o(n);const s=e.slice(1);s[0]="js-hell";const c=Array.from(Wo(s)),u=new yp(hp(c.values(),{reparse:!0,jsHellAllowed:!0,versionAllowed:!0}));let d,m,h=!1;for(let{node:e,pipeHead:n,pipeTail:s}=u.next();e;({node:e,pipeHead:n,pipeTail:s}=u.next(m))){if(s&&!h)throw new Error("pipe has a tail but no head");d=s?m:r,p=e.stacktrace;const c=e.cwdForResolveScriptlet;void 0!==c&&o(c),await e.resolveScriptlet();const u=new up(this);try{if(e.resolveOptions(),s&&""===e.fileTopicKey)throw new TypeError(U`cannot pipe to ${e.scriptletName} - it doesn't consume stdin`);void 0!==e.cwd&&o(e.cwd),({stacktrace:p}=e);const c=s?d:null,y=n?ip:t?tp:np,v={stdin:r,stdout:a,cwd:i(),globalDefaults:gp({stdout:a,EOL:l,sessionId:f}),inspect:e.inspect,brk:!1};await u.openLog(e.logfile);const g=u.console;v.globalDefaults.console=g,u.lexicalEnvironmentOptions=v;const{success:w,value:x}=await mn(u,(()=>e.exec(v,y,c)));if(!w)return g.statusFlush?.(),e.error(x),4;if(g.statusClear?.(),n)m=x,h=!0;else{if(!t&&"boolean"!=typeof x&&void 0!==x)throw new Error("No result expected");m=x,h=!1}}finally{u.finalise({stacktrace:p}),await u.flushStatusAndCloseLog()}}return t?{success:!0,value:m}:!1===m?1:0}catch(e){return"string"==typeof e.sourceText&&"number"==typeof e.sourceIndex&&(console.log("processing: %s",e.sourceText.replaceAll(/[\r\n]/g," ")),console.log("processing: %s","_".repeat(e.sourceIndex)+"^")),console.error("js-hell: %s",p&&"parse"!==e.type&&e.name!==fp.name?e.stack:e.message),5}}finalise(){}}var xp=Object.freeze({__proto__:null,PACKAGE_KEY_JS_HELL:Ka,default:async function({argv:e=process.argv,capture:t,startupDir:n,...i}={}){if(void 0!==fn()){console.assert((o=i,0===Object.keys(o).length),"Extra options passed to shell won't be used.");return fn().shell.execJob(e,{capture:t,startupDir:n})}{void 0===dp&&(dp=globalThis.console,Object.defineProperty(globalThis,"console",{get:()=>fn()?.console??dp}));const o=new wp(i),r=new up(o,{},o.console);try{return await mn(r,(()=>o.execJob(e,{capture:t,startupDir:n})))}finally{console.assert(!r.hasFinalisation(),"The login job should have no registered cleanup."),r.finalise(),o.finalise()}}var o},getGlobalDefaults:gp,parseInvocation:hp});
